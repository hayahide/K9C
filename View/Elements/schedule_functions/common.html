<script>

var bodyColor=function(status){

		var body=window["body"];
		var enable_color="rgba(0,0,0,0.4)";

		if(parseInt(status)==1){

				body.css("background-color",enable_color);
				return;
		}

		var def=body.data("background-color");
		if(!def) return;
		body.css("background-color",def);
}

var cacheData=(function(){

		var fn=function(){

				this.cache={};
		}

		fn.prototype.set=function(key,data){

				if(this.cache[key]==undefined) this.cache[key]={};
				$.extend(this.cache[key],data);
		}

		fn.prototype.clear=function(key){

				this.cache[key]={};
		}

		fn.prototype.get=function(key){

				return this.cache[key];
		}

		return function(selector){

				if(fn.instance instanceof fn){

						return fn.instance;
				}

				var instance=new fn();
				fn.instance=instance;
				return instance;
		}
}());

var localKeyTime=function(k,v){

	if(window["localStorage"]==undefined) return false;
	if($.type(v)=="boolean" && !v) return window["localStorage"].removeItem(k);
	if(v==undefined) return window["localStorage"].getItem(k);

	try{

		if(!window["localStorage"].setItem(k,v)) return false;
		return window["localStorage"].setItem(k,v);

	}catch(e){

		//Privacy mode for ios.
		//QuotaExceededError or other thing.
		return false;
	}
}

var addOptions=function(values,key,callback){

	var select=this;

	if(1>Object.keys(values).length){

		callback(select);
		return;
	}

	var instance=TPL.getInstance(["select_option","select_option_selected"]);
	var fragment=document.createDocumentFragment();

	for(var i in values){

		if(!values.hasOwnProperty(i)) continue;

		var tpl="select_option"+(key==i?"_selected":"");
		var html=instance["get_"+tpl];
		var elem=$(instance.replaceTPL(html,{

			"key"  :i,
			"value":values[i]
		}));

		fragment.appendChild(elem.get(0));
	}

	select.append(fragment);
	if(!$.isFunction(callback)) return;
	elem.ready(function(){

		callback.call(select);
	});
}

//pref
var setMenu=function(values,callback){

	var select=this;
	var top=select.children().eq(0);
	top.nextAll().remove();
	addOptions.call(select,values,null,function(){

		if($.isFunction(callback)) callback();
	});
}

var setColor=function(datas,select_color_id,callback){

	var elem=this;
	var instance=TPL.getInstance("remodal_reservation_color");
	var color_tpl=instance.get_remodal_reservation_color;
	var fragment=document.createDocumentFragment();
	var html;
	var color_html;
	var index=0;

	for(var color_id in datas){
	
		html=instance.replaceTPL(instance.get_remodal_reservation_color,{
		
			"bg_color":datas[color_id],
			"color_id":color_id
		});

		color_html=$(html);

		switch(true){
		
			case(select_color_id==undefined && index==0):
				color_html.addClass("active");
				break;
			case(select_color_id==color_id):
				color_html.addClass("active");
				break;
		}

		fragment.appendChild(color_html.get(0));
		index++;
	}

	elem.append(fragment);
	if(!$.isFunction(callback)) return;

	$(document).ready(function(){
	
		callback();
	});
}

var setCalendarForInput=function(methods,params){

	this.datepicker({
	
		minDate        :(params!=undefined && params["minDate"]!=undefined)?params["minDate"]:"0d",
		maxDate        :(params!=undefined && params["maxDate"]!=undefined)?params["maxDate"]:"+2y",
		closeText      :"<?php echo __("閉じる"); ?>",
		currentText    :"現在日時",
		timeOnlyTitle  :"日時を選択",
		timeText       :"時間",
		hourText       :"時",
		minuteText     :"分",
		autoclose      :true,
		secondText     :"秒",
		millisecText   :"ミリ秒",
		microsecText   :"マイクロ秒",
		timezoneText   :"タイムゾーン",
		prevText       :"&#x3c;前",
		nextText       :"次&#x3e;",
		monthNames     :["<?php echo __("1月");?>",
					     "<?php echo __("2月");?>",
					     "<?php echo __("3月");?>",
					     "<?php echo __("4月");?>",
					     "<?php echo __("5月");?>",
					     "<?php echo __("6月");?>",
					     "<?php echo __("7月");?>",
					     "<?php echo __("8月");?>",
					     "<?php echo __("9月");?>",
					     "<?php echo __("10月");?>",
					     "<?php echo __("11月");?>",
					     "<?php echo __("12月");?>"],
		
		monthNamesShort :["<?php echo __("1月");?>",
						  "<?php echo __("2月");?>",
						  "<?php echo __("3月");?>",
						  "<?php echo __("4月");?>",
						  "<?php echo __("5月");?>",
						  "<?php echo __("6月");?>",
						  "<?php echo __("7月");?>",
						  "<?php echo __("8月");?>",
						  "<?php echo __("9月");?>",
						  "<?php echo __("10月");?>",
						  "<?php echo __("11月");?>",
						  "<?php echo __("12月");?>"],
		
		dayNames       :["<?php echo __("日曜日");?>",
					     "<?php echo __("月曜日");?>",
				         "<?php echo __("火曜日");?>",
					     "<?php echo __("水曜日");?>",
					     "<?php echo __("木曜日");?>",
					     "<?php echo __("金曜日");?>",
						 "<?php echo __("土曜日");?>"],
		
		dayNamesShort  :["<?php echo __("日");?>",
					     "<?php echo __("月");?>",
				         "<?php echo __("火");?>",
					     "<?php echo __("水");?>",
					     "<?php echo __("木");?>",
					     "<?php echo __("金");?>",
						 "<?php echo __("土");?>"],
		
		dayNamesMin    :["<?php echo __("日");?>",
					     "<?php echo __("月");?>",
				         "<?php echo __("火");?>",
					     "<?php echo __("水");?>",
					     "<?php echo __("木");?>",
					     "<?php echo __("金");?>",
						 "<?php echo __("土");?>"],
		
		weekHeader     :"週",
		yearSuffix     :"",
		dateFormat     :"<?php echo __("yy-mm-dd"); ?>",
		onClose:function(val,i){},
		onSelect:function(selectedDate){
		
			var calendar=$(this);
			if(methods["onSelect"]!=undefined && $.isFunction(methods["onSelect"])) methods["onSelect"].call(calendar,selectedDate);
		},
		beforeShow:function(calendar){
		
			calendar=$(calendar);
			if(methods["beforeShow"]!=undefined && $.isFunction(methods["beforeShow"])) methods["beforeShow"].call(calendar);
		}
	});
}

//calendar
var setCalendar=function(datas,params){

	 var elem=this;
	 var date_format="yy-mm-dd";
	 var instance=TPL.getInstance("schedule_calendar");

	 var start_value=(!!datas["start_value"])?replaceToLocalDate(datas["start_value"]):"&nbsp;";
	 var end_value  =(!!datas["end_value"])  ?replaceToLocalDate(datas["end_value"]):"&nbsp;";

	 var html=instance.replaceTPL(instance.get_schedule_calendar,{

		"start_value":start_value,
		"end_value"  :end_value
	 });

	 var html=$(html);
	 var current_calendars=elem.children("div[data-type=\"calendar\"]");
	 var calendars=html.children("input[data-type^=\"calendar-\"]");
	 var start=calendars.eq(0);
	 var end=calendars.eq(calendars.size()-1);

	 var is_end_empty=(1>end.val().trim().length);
	 var CALENDAR_START_TYPE="calendar-start";
	 var CALENDAR_END_TYPE  ="calendar-end";

	 setCalendarForInput.call(calendars,{
	 
		 "onSelect":function(selectedDate){

			 var calendar=$(this);
			 var type=calendar.attr("data-type");
			 if(!params["onSelect"]==undefined || !$.isFunction(params["onSelect"])) return;
			 params["onSelect"].call(calendar,type,selectedDate,{
			 
			 	"end"  :end,
			 	"start":start
			 });
			 return;
			 
			 var end_value=end.val().trim();
			 if(1>end_value.length) is_end_empty=true;
			 if(!is_end_empty) return;
			 if(calendar.attr("data-type")==CALENDAR_END_TYPE){
			 
			 	is_end_empty=false;
			 	return;
			 }
			 
			 var parent=calendar.parent();
			 var calendar_end=parent.children("input[data-type=\""+CALENDAR_END_TYPE+"\"]");
			 calendar_end.val(selectedDate);
		 }
	 });

	 if(1>current_calendars.size()){

		elem.prepend(html);

	 }else{

		current_calendars.eq(current_calendars.size()-1).after(html);
	 }
}

var checkRange=function(start_ymd,end_ymd,date_range){

	var information_start=parseInt(date_range[0]);
	var information_end=parseInt(date_range[date_range.length-1]);
	start_ymd=parseInt(new Date(Number(start_ymd).addMinutesZero()).getYmdByMs().join(""));
	end_ymd  =parseInt(new Date(Number(end_ymd).addMinutesZero()).getYmdByMs().join(""));
	var is_start_over=(start_ymd>=information_start && information_end>=start_ymd);
	var is_end_over  =(end_ymd>=information_start && information_end>=end_ymd);

	var res={"data":{}};
	res["status"]=true;
	res["data"]["is"]=information_start;
	res["data"]["ie"]=information_end
	res["data"]["as"]=start_ymd;
	res["data"]["ae"]=end_ymd
	if(is_start_over && is_end_over) return res;
	res["status"]=false;
	return res;
}

//var setCenterHight=function(par,ch,cw){
var setCenterHight=function(ch,cw){

		var html=this;
		var inner_h=html.height();
		var mh=(ch/2-(inner_h/2));
		html.css("marginTop",mh+"px");
		html.css("marginBottom",mh+"px");
		html.css("max-height",inner_h+"px");
}

var logInitializeToMove=function(user_id,href){

	var params={};
	params["user_id"]=user_id;
	params["last_edit_time"]=cacheData().get(CACHE_LAST_EDIT_TIME).last_edit_time;
	params["local_time_key"]=localKeyTime(LOCAL_STORAGE_TIMEKEY);
	apiGeoRequests.initScheduleLog(params,function(status,res){

		$(window).off("beforeunload");
		var url=document.location.protocol+BASE_URL+href;
		location.href=url;
	});
}

var isDeadlineOver=function(limited_second){

	var current_time=new Date().getTime();
	var time_key=localKeyTime(LOCAL_STORAGE_TIMEKEY);
	var t="";
	if(time_key!=undefined) t=parseInt(time_key)*1000;
	if((!t) && (cacheData().get(MANAGED_LIMITED_TIMER)!=undefined)) t=parseInt(cacheData().get(MANAGED_LIMITED_TIMER).timer);
	if(!t) return false;
	if(current_time>(t+(limited_second*1000))) return true;
	return false;
}

var isAuthority=function(limited_second){

		//is_authority : from server.
		if(!is_authority) return false;
		if(1>parseInt(window["schedule_log"]["edit_time_expired_ms"])) return false;
		if(user_id!=window["schedule_log"]["last_start_user"]) return false;
		if(isDeadlineOver(limited_second)) return false;
		return true;
}

var deadlineOverGetAuthority=function(args){

	var deferred=$.Deferred();
	var user_id       =args["user_id"];
	var last_edit_time=args["last_edit_time"];
	var local_time_key=args["local_time_key"];

	var params={};
	params["user_id"]=user_id;
	params["last_edit_time"]=last_edit_time;
	params["local_time_key"]=local_time_key;
	apiGeoRequests.editStart(params,function(status,res){

		if(!status && res["type"]==0){
			
			alert(res["message"]);
			reloadUnbindUnload();
			return;
		}

		if(!status && res["type"]==1){

			alert(res["message"]);
			reloadUnbindUnload();
			return;
		}

		//■タイマー基準時間更新
		var time_key=res["time_key"];
		var current_time_ms=res["last_modified_ms"];
		var last_edit_time=res["last_edit_time"];
		localKeyTime(LOCAL_STORAGE_TIMEKEY,time_key);
		cacheData().set(MANAGED_LIMITED_TIMER,{"timer":current_time_ms});
		cacheData().set(MANAGED_AUTHORITY ,{"is_managed":true});
		cacheData().set(CACHE_LAST_EDIT_TIME,{ "last_edit_time":last_edit_time });
		deferred.resolve();
	});

	return deferred.promise();
}

var scheduleRefreshOvertime=function(limited_second){

		/*
		$(window).off("focus").bind("focus",function(){　

				if(!is_edit) return false;
				if(!cacheData().get(MANAGED_AUTHORITY).is_managed) return false;
				var edit_time_expired_ms=parseInt(cacheData().get(MANAGED_LIMITED_TIMER).timer);
				var limited_ms=(edit_time_expired_ms+(limited_second*1000));
				var current_ms=new Date().getTime();
				if(limited_ms>=current_ms) return;

				var params={};
				params["user_id"]       =user_id;
				params["last_edit_time"]=cacheData().get(CACHE_LAST_EDIT_TIME).last_edit_time;
				params["local_time_key"]=localKeyTime(LOCAL_STORAGE_TIMEKEY);
				deadlineOverGetAuthority(params).
				done(function(){

						var main_title="段取権限期限切れ";
						var title     ="段取時間を超えている為スケジュールの変更は保存出来ません";
						var __uiAlertViewMessage=function(){

								var message="<span style='color:red;'>※段取を継続致します</span>";
								return message;
						}

						var params={};
						params["main_title"]=main_title;
						params["title"]="◯&nbsp;段取可能時間を超えておりますが継続致します";
						params["message"]=__uiAlertViewMessage();
						params["yes"]=function(){};
						params["close"]=params["yes"];
						uiAlert(params);
				});
		});
		*/
}

var reloadUnbindUnload=function(){

	$(window).off("beforeunload");
	location.reload();
}

var setCalendarOnSchedule=function(params,callback){

	var data_calendar=this;
	var today=window["today"]["date"].getYmdByMs().join("-");

	setCalendar.call(data_calendar,{

		"start_value":params["start_value"],
		"end_value"  :params["end_value"]
	},{
	
		"onSelect":function(type,date,elems){

			var calendar=this;
			var start=elems["start"];
			var end=elems["end"];
			var end_calendar=data_calendar.eq(data_calendar.size()-1);
			var calendars=end_calendar.children("div[data-type=\"calendar\"]");
			var calendar_num=calendars.size();

			var checkEnableDate=function(elem){

				var dates=[];
				var input_date=elem.val().trim();
				var calendar=elem.parent();
				var calendars=data_calendar.children("div[data-type=\"calendar\"]").filter(function(){
				
					return !$(this).is(calendar);
				});

				calendars.each(function(){

					var inputs=$(this).children("input");
					var start=inputs.eq(0);
					var end=inputs.eq(1);
					dates.push({
					
						"start":start.val().trim(),
						"end"  :end.val().trim()
					});
				});

				if(1>dates.length) return true;

				var obj;
				var start;
				var end;
				for(var i in dates){
				
					obj=dates[i];
					start=obj["start"];
					end=obj["end"];
					if(input_date>=start && end>=input_date){
					
						return false;
						break;
					}
				}

				return true;
			}

			var checkMinDate=function(calendar,value){

				var prev_calendar=calendar.prev();
				if(prev_calendar.size()>0){

					var prev_start=prev_calendar.children("input").eq(0).val();
					if(prev_start>value) return false;
				}

				return true;
			}

			switch(type){
			
				case("calendar-start"):

					var start_value=start.val().trim();
					if(1>start_value.length) return;
					var end_value=end.val().trim();
					var calendar=start.parent();

					start_value=replaceToJpDate(start_value);
					end_value=replaceToJpDate(end_value);

					if(today>start_value){

						start.val("");
						var message="<?php echo __("本日以前の日付は設定出来ません"); ?>";
						callback(false,message);
						return;
					}

					if(end_value.length>0 && start_value>end_value){
					
						start.val("");
						var message="<?php echo __("設定された日付は適切ではありません"); ?>";
						callback(false,message);
						return;
					}

					if(!checkMinDate(calendar,start_value)){

						start.val("");
						var message="<?php echo __("設定された日付は適切ではありません"); ?>";
						callback(false,message);
						return;
					}

					if(!checkEnableDate(start)){

						start.val("");
						var message="<?php echo __("選択した日付は別の期間に含まれています"); ?>";
						callback(false,message);
						return;
					}

					if(1>end_value.length) end.val(start_value);

					break;

				case("calendar-end"):

					var end_value=end.val().trim();
					if(1>end_value.length) return;
					var start_value=start.val().trim();
					var calendar=end.parent();

					start_value=replaceToJpDate(start_value);
					end_value=replaceToJpDate(end_value);

					if(today>end_value){

						end.val("");
						var message="<?php echo __("本日以前の日付は設定出来ません"); ?>";
						callback(false,message);
						return;
					}

					if(1>start_value.length){

						end.val("");
						var message="<?php echo __("宿泊開始日が設定されていません"); ?>";
						callback(false,message);
						return;
					}

					if(start_value>end_value){

						end.val("");
						var message=start_value+"<?php echo __("以降の日付を設定して下さい"); ?>";
						callback(false,message);
						return;
					}

					if(!checkMinDate(calendar,end_value)){

						end.val("");
						var message="<?php echo __("設定された日付は適切ではありません"); ?>";
						callback(false,message);
						return;
					}

					if(!checkEnableDate(end)){

						end.val("");
						var message="<?php echo __("選択した日付は別の期間に含まれています"); ?>";
						callback(false,message);
						return;
					}

					break;
			}

			callback(true);
		},
	});
}

var replaceYmForLocale=function(y,m){

	var instance=TPL.getInstance([]);
	var tpl="<?php echo __("<<y>>/<<m>>"); ?>";
	tpl=instance.replaceTPL(tpl,{
	
		"y":y,
		"m":m,
	});

	return tpl;
}

var replaceYmdForLocale=function(y,m,d){

	var instance=TPL.getInstance([]);
	var tpl="<?php echo __("<<y>>/<<m>>/<<d>>"); ?>";
	tpl=instance.replaceTPL(tpl,{
	
		"y":y,
		"m":m,
		"d":d
	});

	return tpl;
}

var checkPriceRateView=function(data_id,type,callback){

	var main_html=this;
	var checkPriceRate=function(data_id,type){
	
		var deferred=$.Deferred();
		var params={"data":{}};
		params["data"]["data_id"]=data_id;
		params["type"]=type;
		apiGeoRequests.checkPriceRate(params,function(status,res){ 
	
			if(!status) return deferred.reject(res);
			var data=res["data"];
			deferred.resolve(data);
		});
	
		return deferred.promise();
	}
	
	var makeViewCheckPriceRate=function(information){
	
		var deferred=$.Deferred();
	
		var instance=TPL.getInstance(["remodal_price_value","remodal_price_title"]);
		var price_title_tpl=instance.get_remodal_price_title;
		var price_value_tpl=instance.get_remodal_price_value;
		var price_check_html=main_html.find("div[data-type=\"price-check\"]");
		var fragment=document.createDocumentFragment();
	
		price_check_html.empty();
	
		var names;
		var first_name;
		var middle_name;
		var last_name;
		var guest_name;
		var price_title_html;
		var ul;
		var schedules;
		var price_value_html;
		var split_ymd;
		var status;
		var price_type_colors={"0":"black","3":"blue","4":"red","5":"green","6":"purple"};

		for(var reserve_id in information){
	
			if(1>Object.keys(information[reserve_id]["schedule"]).length){
			
				continue;
			}
	
			names=[];
			first_name =information[reserve_id]["guest"]["first_name"];
			middle_name=information[reserve_id]["guest"]["middle_name"];
			last_name  =information[reserve_id]["guest"]["last_name"];
			if(first_name.length>0)  names.push(first_name);
			if(middle_name.length>0) names.push(middle_name);
			if(last_name.length>0)   names.push(last_name);
			guest_name=names.join(" ").trim();
			price_title_html=$(instance.replaceTPL(price_title_tpl,{
			
				"guest_name":guest_name.length>0?guest_name:"<?php echo __("宿泊者名未設定"); ?>",
				"reserve_id":reserve_id,
			}));
	
			ul=price_title_html.find("div[data-type=\"schedule-price-list\"]");
			schedules=information[reserve_id]["schedule"];
			for(var ymd in schedules){

				split_ymd=Number(ymd).splitYmd();
				status=schedules[ymd]["price"]["status"];
				price_value_html=$(instance.replaceTPL(price_value_tpl,{
	
					"schedule_id":schedules[ymd]["schedule_id"],
					"date"       :viewYmd(split_ymd[0],split_ymd[1],split_ymd[2]),
					"price"      :Number(schedules[ymd]["price"]["price"]).toLocaleString()+"$",
					"base_price" :Number(schedules[ymd]["price"]["base_price"]).toLocaleString(),
					"data_id"    :schedules[ymd]["price"]["data_id"],
					"font_color" :price_type_colors[status]==undefined?"black":price_type_colors[status]
				}));
	
				ul.append(price_value_html);
			}
	
			fragment.appendChild(price_title_html.get(0));
		}
	
		price_check_html.append(fragment);
		return deferred.resolve();
	}

	checkPriceRate(data_id,type).
	then(makeViewCheckPriceRate).
	fail(function(res){ alert(res["message"]); }).
	done(function(information){

		callback.call(main_html,information);
	});
}

var removePriceRate=function(data_id,type){

	var deferred=$.Deferred();
	var params={"data":{}};
	params["data"]["data_id"]=data_id;
	params["type"]=type;
	apiGeoRequests.removePriceRate(params,function(status,res){ 

		if(!status && res["type"]==0){

			alert('<?php echo __("通信状況が安定しておりません"); ?>');
			return;
		}

		if(!status && res["type"]==1){

			deferred.reject(res["message"]); 
			return;
		}

		deferred.resolve(true,res["data"]); 
	});

	return deferred.promise();
}

var getPriceRatePlans=function(){

	var params={};
	var deferred=$.Deferred();
	apiGeoRequests.getPriceRate(params,function(status,res){ 

		if(!status) return deferred.reject(res);
		deferred.resolve(res["data"]);
	});

	return deferred.promise();
}

var saveMetaValue=function(meta_key,meta_value,params){

	var saveLang=function(meta_key,meta_value){
	
		var deferred=$.Deferred();
		var params={};
		params["meta_key"]  =meta_key;
		params["meta_value"]=meta_value;
		apiGeoRequests.saveSetting(params,function(status,res){

			if(!status) return deferred.reject(res);
			return deferred.resolve(res);
		});

		return deferred.promise();
	}

	saveLang(meta_key,meta_value).
	done(function(res){

		params["done"](res);
	}).
	fail(function(res){

		params["fail"](res);
	});
}

var metaSetting=function(){

	var getSettingInformation=function(){

		var deferred=$.Deferred();

		var params={};
		apiGeoRequests.getSettings(params,function(status,res){

			if(!status) return deferred.reject(res);
			var information=res["data"];
			return deferred.resolve(information);
		});

		return deferred.promise();
	}

	var makeSettingView=function(information){

		var deferred=$.Deferred();

		var instance=TPL.getInstance(["remodal_all_setting"]);
		var main_tpl=instance.get_remodal_all_setting;
		var main_html=$(main_tpl);

		var price_tax_html=main_html.find("input[data-target-type=\"price-tax\"]");
		var language_html =main_html.find("select[data-target-type=\"select-language\"]");
		price_tax_html.val(information["tax"]);
		addOptions.call(language_html,information["langs"],information["lang"]);
		return deferred.resolve(main_html,information);
	}

	var makeCreditView=function(main_html,information){

		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_card_info"]);
		var child_tpl=instance.get_remodal_card_info;
		var card_info=information["cards"];
		var fragment=document.createDocumentFragment();
		var add_target=main_html.find("div[data-type=\"setting-card-top\"]");
		var range=information["cards"]["range"];
		var rate =information["cards"]["rate"];

		var rate_val;
		var range_val;
		var child_html;
		for(var card_id in range){

			child_html=$(instance.replaceTPL(child_tpl,{
			
				"card_id":card_id,
				"card"   :range[card_id]["card_type"],
			}));

			child_html.find("input[type=number][data-type=\"card-range\"]").val(range[card_id]["income_late_day"]);
			child_html.find("input[type=number][data-type=\"card-rate\"]").val(rate[card_id]["rate"]);
			fragment.appendChild(child_html.get(0));
		}

		add_target.append(fragment);

		return deferred.resolve(main_html,information);
	}

	var makeInvoiceCompany=function(main_html,information){

		var deferred=$.Deferred();
		var info=information["invoice"];
		var instance=TPL.getInstance(["remodal_invoice_company"]);
		var invoice_tpl=instance.get_remodal_invoice_company;
		var invoice_html;
		var fragment=document.createDocumentFragment();
		var add_target=main_html.find("div[data-type=\"setting-inovice-top\"]");

		for(var meta_key in info){
		
			invoice_html=$(instance.replaceTPL(invoice_tpl,{
			
				"meta_key":meta_key,
				"title"   :info[meta_key]["title"]
			}));

			invoice_html.find("input[type=text][data-type=\"invoice-company\"]").val(info[meta_key]["value"]);
			fragment.appendChild(invoice_html.get(0));
		}

		add_target.append(fragment);
		return deferred.resolve(main_html,information);
	}
	
	var authorityAdd=function(main_html,information){

		var deferred=$.Deferred();

		var tax=main_html.find("div[data-type=\"setting-tax-top\"]");
		var is_tax_disable=parseInt("<?php echo SETTING_EDIT_TAX?0:1 ?>")>0?true:false;
		tax.find("input[data-target-type=\"price-tax\"]").propDisable(is_tax_disable);
		if(is_tax_disable) tax.find("a[data-type=\"price-tax\"]").remove();

		var card=main_html.find("div[data-type=\"setting-card-top\"]");
		var is_card_disable=parseInt("<?php echo SETTING_EDIT_CARD?0:1 ?>")>0?true:false;
		card.find("input[type=number][data-type=\"card-range\"]").propDisable(is_card_disable);
		card.find("input[type=number][data-type=\"card-rate\"]").propDisable(is_card_disable);
		if(is_card_disable) card.find("a[data-type=\"select-card\"]").remove();

		var invoice=main_html.find("div[data-type=\"setting-inovice-top\"]");
		var is_invoice_disable=parseInt("<?php echo SETTING_EDIT_INVOICE?0:1 ?>")>0?true:false;
		invoice.find("input[type=text][data-type=\"invoice-company\"]").propDisable(is_invoice_disable);
		if(is_invoice_disable) invoice.find("a[data-type=\"select-invoice\"]").remove();

		return deferred.resolve(main_html,information);
	}

	getSettingInformation().
	then(makeSettingView).
	then(makeCreditView).
	then(makeInvoiceCompany).
	then(authorityAdd).
	done(function(main_html,information){

		var main_title="<?php echo __("全体設定"); ?>";
		var message=main_html;
		var params={};
		params["yes"]  =function(){};
		params["no"]   =params["yes"];
		params["close"]=params["yes"];

		params["remodal-close"]=function(e,type){
		
			if(type=="end") return;
		};

		params["select-invoice"]=function(e,type){
		
			if(type=="start") return;
			var target=$(e.target);
			var invoice_top=target.parents("div[data-type=\"invoice-company-top\"]");
			var meta_key=invoice_top.attr("data-meta-key");
			var meta_value=invoice_top.find("input[type=text][data-type=\"invoice-company\"]").val().trim();

			if(information["invoice"][meta_key]["value"]==meta_value){

				alert("<?php echo __("変更された項目は存在しません"); ?>");
				return;
			}

			var params={};
			params["meta_key"]  =meta_key;
			params["meta_value"]=meta_value;
			apiGeoRequests.saveSetting(params,function(status,res){

				if(!status){
				
					alert(res["message"]);
					return;
				}

				alert("<?php echo __("設定した内容が正常に登録されました"); ?>");
				information["invoice"][meta_key]["value"]=meta_value;
			});
		}

		params["select-card"]=function(e,type){
		
			if(type=="start") return;

			var target=$(e.target);
			var card_top=target.parents("div[data-type=\"card-top\"]");
			var card_id=card_top.attr("data-card-id");
			var range=card_top.find("input[type=number][data-type=\"card-range\"]");
			var rate =card_top.find("input[type=number][data-type=\"card-rate\"]");
			var range_val=Math.max(range.val().trim(),0);
			var rate_val =Math.max(rate.val().trim(),0);

			var range=information["cards"]["range"];
			var rate =information["cards"]["rate"];

			var params={"data":{}};
			params["card_id"]=card_id;
			if(range[card_id]["income_late_day"]!=range_val) params["data"]["range"]=range_val;
			if(rate[card_id]["rate"]!=rate_val) params["data"]["rate"] =rate_val;

			if(1>Object.keys(params["data"]).length){

				alert("<?php echo __("変更された項目は存在しません"); ?>");
				return;
			}

			apiGeoRequests.cardInfoSubscribe(params,function(status,res){

				if(!status){
				
					alert(res["message"]);
					return;
				}

				alert("<?php echo __("設定した内容が正常に登録されました"); ?>");
				information["cards"]["range"]=res["data"]["cards"]["range"];
				information["cards"]["rate"] =res["data"]["cards"]["rate"];
			});
		};

		params["price-tax"]=function(e,type){
		
			if(type=="start") return;
			var target   =$(e.target);
			var meta_key=target.attr("data-type");
			var parent=target.parents("div[data-type=\"setting-tax-top\"]");
			var target_html=parent.find("input[data-target-type=\""+meta_key+"\"]");
			var meta_value=Math.max(target_html.val().trim(),0);

			if(information["tax"]==meta_value){

				alert("<?php echo __("変更された項目は存在しません"); ?>");
				return;
			}

			var params={};
			params["tax"]=meta_value;
			apiGeoRequests.taxSubscribe(params,function(status,res){

				if(!status){
				
					alert(res["message"]);
					return;
				}

				//update current order histories.
				information["tax"]=res["data"]["tax"];
				alert("<?php echo __('設定した内容が正常に登録されました'); ?>");
			});
		};

		params["select-language"]=function(e,type){

			if(type=="start") return;
			var target   =$(e.target);
			var meta_key=target.attr("data-type");
			var parent=target.parents("div[data-type=\"setting-language-top\"]");
			var target_html=parent.find("select[data-target-type=\""+meta_key+"\"]");
			var meta_value=target_html.val();

			saveMetaValue(meta_key,meta_value,{
			
				"done":function(res){ 

					var res=window.confirm(res["message"]);
					if(!res) return;

					if(window["isScheduleEdit"] && $.isFunction(isScheduleEdit) && isScheduleEdit()){
					
						var message="<?php echo __("予約情報が更新されています"); ?>\n\n";
						message+="<?php echo __("更新しても宜しいですか？"); ?>";
						res=window.confirm(message);
						if(!res) return;
					}

					reloadUnbindUnload();
				},
				"fail":function(res){ alert(res["message"]); }
			});
		};

		remodalAlert("normal_800",main_title,message,params);
	}).
	fail(function(res){
	
		alert(res["message"]);
	})
}

var employeeSetting=function(){

	var auth_master_name     ='<?php echo K9MasterEmployee::$AUTH_MASTER; ?>';
	var auth_staff_name      ='<?php echo K9MasterEmployee::$AUTH_STAFF; ?>';
	var auth_chief_name      ='<?php echo K9MasterEmployee::$AUTH_CHIEF; ?>';

	var getEmploeeInformation=function(){

		var deferred=$.Deferred();

		var params={};
		apiGeoRequests.getEmployees(params,function(status,res){

			if(!status) return deferred.reject(res);
			var information=res["data"]["data"];
			var menus      =res["data"]["menu"];
			return deferred.resolve(information,menus);
		});

		return deferred.promise();
	}

	var emploeeLayout=function(information,menus){

		var deferred=$.Deferred();

		var master=information[auth_master_name];
		var staff =information[auth_staff_name];
		var chief =information[auth_chief_name];
		var instance=TPL.getInstance(["remodal_employee","remodal_employee_list_li"]);
		var main_tpl=instance.get_remodal_employee;
		var li_tpl=instance.get_remodal_employee_list_li;
		var fragment=document.createDocumentFragment();
		var main_html=$(main_tpl);
		var li_target=main_html.find("ul[data-type=\"employee-list\"]");
		var li_html;

		var bg_colors={};
		bg_colors[auth_master_name]="rgba(0,0,0,0.7)";
		bg_colors[auth_chief_name] ="#e0e0e0";
		bg_colors[auth_staff_name] ="#e0e0e0";

		var addFragment=function(auth_value,auth_key,information){

			for(var i in information){
			
				var names=[];
				var first_name =information[i]["employee"]["first_name"];
				var middle_name=information[i]["employee"]["middle_name"];
				var last_name  =information[i]["employee"]["last_name"];
				if(first_name.length>0)  names.push(first_name);
				if(middle_name.length>0) names.push(middle_name);
				if(last_name.length>0)   names.push(last_name);

				li_html=$(instance.replaceTPL(li_tpl,{
				
					"name"         :names.join(" "),
					"employee_id"  :information[i]["employee"]["id"],
					"employee_auth":information[i]["account"]["authority"],
					"auth"         :auth_value,
					"bg_color"     :bg_colors[auth_key],
					"account"      :information[i]["account"]["username"],
					"remark"       :information[i]["employee"]["remark"].length>0?information[i]["employee"]["remark"]:"&nbsp;",
					"jobtitle"     :information[i]["employee"]["jobtitle_value"]
				}));

				fragment.appendChild(li_html.get(0));
			}
		}

		addFragment(menus["authorities"][auth_master_name],auth_master_name,master);
		addFragment(menus["authorities"][auth_chief_name] ,auth_chief_name ,chief);
		addFragment(menus["authorities"][auth_staff_name] ,auth_staff_name ,staff);

		li_target.append(fragment);
		return deferred.resolve(main_html,information,menus);
	}

	getEmploeeInformation().
	then(emploeeLayout).
	done(function(main_html,information,menus){

		var main_title="<?php echo __("従業員管理"); ?>";
		var message=main_html;

		var setting_html =main_html.find("div[data-type=\"employee-setting\"]");
		var first_name   =setting_html.find("input[data-type=\"first-name\"]");
		var middle_name  =setting_html.find("input[data-type=\"middle-name\"]");
		var last_name    =setting_html.find("input[data-type=\"last-name\"]");
		var select_authority_target=setting_html.find("select[data-type=\"form-authority\"]");
		var select_jobtitle_target=setting_html.find("select[data-type=\"form-jobtitle\"]");
		var account      =setting_html.find("input[data-type=\"form-account\"]");
		var password     =setting_html.find("input[data-type=\"form-password\"]");
		var password_conf=setting_html.find("input[data-type=\"form-password-conf\"]");
		var remark       =setting_html.find("textarea[data-type=\"form-remark\"]");
	
		var params={};
		params["yes"]=function(){};
		params["no"]   =params["yes"];
		params["close"]=params["yes"];
		params["opened"]=function(){

			var select_authorities={};
			select_authorities[auth_chief_name]=menus["authorities"][auth_chief_name];
			select_authorities[auth_staff_name]=menus["authorities"][auth_staff_name];
			setMenu.call(select_authority_target.empty(),select_authorities);

			setMenu.call(select_jobtitle_target.empty(),menus["jobtitles"]);

			var employee_setting_html=main_html.find("div[data-type=\"employee-setting\"]");
			var inputs=employee_setting_html.find("input");

			inputs.focusout(function(){

				var i=$(this).attr("name");
				var isvalue=$(this).val();
				var o=i;
				var errorMessage = "";
				if(i=="first-name" || i=="middle-name" || i=="last-name"){ o="name"; }
				else if(i == "re-pass"){ o="pass";};
				if((i=="account" || i=="pass" || i=="re-pass") && isvalue!=""){
				
					var preg = /^[a-zA-Z0-9]+$/;
					if(!preg.test(isvalue) && ( o=="account" || o=="pass" )){

						errorMessage="<?php echo __("数値とアルファベットのみ入力可能です"); ?>";
					};
				
					if(i=="re-pass"){

						var pass  =$('input[name="pass"]').val();
						var repass=$('input[name="re-pass"]').val();
						if(pass != repass){
							errorMessage="<?php echo __("パスワードが一致しません"); ?>";
						};
					};

					$("."+o+" span.error").html(errorMessage);
					$("."+o+" span.error").css("display", "inline");
				}
			});   
		};

		params["staff-submit"]=function(e,type){
		
			if(type=="start") return;

			var params={"data":{},"user":{}};
			params["data"]["first_name"]   =first_name.val().trim();
			params["data"]["middle_name"]  =middle_name.val().trim();
			params["data"]["last_name"]    =last_name.val().trim();
			params["data"]["authority"]    =select_authority_target.val();
			params["data"]["jobtitle"]     =select_jobtitle_target.val();
			params["data"]["password"]     =password.val().trim();
			params["data"]["password_conf"]=password_conf.val().trim();
			params["data"]["remark"]       =remark.val().trim();
			params["data"]["account"]      =account.val().trim();

			if($.isNumeric(main_html.data("staff_id"))){

				var staff_id=main_html.data("staff_id");
				var staff_authority=main_html.data("staff_authority");
				var staff_info=information[staff_authority][staff_id];
				params["user"]["hash"]=staff_info["employee"]["hash"];
			}

			var saveEmployee=function(params){
			
				var deferred=$.Deferred();
				apiGeoRequests.saveEmployee(params,function(status,res){

					if(!status) return deferred.reject(res);
					var data=res["data"];
					deferred.resolve(data);
				});

				return deferred.promise();
			}

			saveEmployee(params).
			done(function(data){

				alert("<?php echo __("設定が登録されました、画面を更新すると反映されます"); ?>");
				employeeSetting();

			}).
			fail(function(res){
			
				alert(res["message"]);
			});
		}

		params["tab-employee-list"]=function(e,type){

			if(type=="start") return;

			var select_authorities={};
			select_authorities[auth_chief_name]=menus["authorities"][auth_chief_name];
			select_authorities[auth_staff_name]=menus["authorities"][auth_staff_name];
			setMenu.call(select_authority_target.empty(),select_authorities);

			setMenu.call(select_jobtitle_target.empty(),menus["jobtitles"]);
			main_html.removeData("staff_id");

			first_name.val("");
			middle_name.val("");
			last_name.val("");
			account.val("");
			password.val("");
			password_conf.val("");
			select_authority_target.prop("disabled",<?php echo (($authority=="master")?"false":"true"); ?>);
			password.prop("disabled",<?php echo (($authority=="master")?"false":"true"); ?>);
			password_conf.prop("disabled",<?php echo (($authority=="master")?"false":"true"); ?>);

			<?php if($authority!="master"){ ?>
			password.attr("placeholder","<?php echo __("設定出来ません"); ?>");
			password_conf.attr("placeholder","<?php echo __("設定出来ません"); ?>");
			<?php } ?>
		}

		params["remodal-close"]=function(e,type){

			if(type=="end") return;
		}

		params["staff-select"]=function(e,type){
		
			if(type=="start") return;

			var target=$(e.target);
			var parent=target.parents("li[data-type=\"parent-row-li\"]");
			var staff_id =parent.attr("data-staff-id");
			var authority=parent.attr("data-staff-auth");
			var staff_info=information[authority][staff_id];
			var toggle_button_ul=main_html.find("ul[data-type=\"toggle-buttons\"]");
			var toggle_buttons=toggle_button_ul.children("li");

			var select_authorities={};
			select_authorities[auth_chief_name]=menus["authorities"][auth_chief_name];
			select_authorities[auth_staff_name]=menus["authorities"][auth_staff_name];
			if(authority=="master") select_authorities[auth_master_name]=menus["authorities"][auth_master_name];

			main_html.data("staff_id",staff_id);
			main_html.data("staff_authority",authority);

			addOptions.call(select_authority_target.empty(),select_authorities,staff_info["account"]["authority"]);
			select_authority_target.prop("disabled",(authority=="master"?true:false));

			addOptions.call(select_jobtitle_target.empty(),menus["jobtitles"],staff_info["employee"]["jobtitle"]);
			select_jobtitle_target.prop("disabled",(authority=="master"?true:false));

			first_name.val(staff_info["employee"]["first_name"]);
			middle_name.val(staff_info["employee"]["middle_name"]);
			last_name.val(staff_info["employee"]["last_name"]);
			account.val(staff_info["account"]["username"]);

			remark.val(staff_info["employee"]["remark"]);

			<?php if($authority!="master"){ ?>
			select_authority_target.prop("disabled",true);
			select_jobtitle_target.prop("disabled",true);
			password.prop("disabled",true);
			password_conf.prop("disabled",true);
			password.attr("placeholder","<?php echo __("設定出来ません"); ?>");
			password_conf.attr("placeholder","<?php echo __("設定出来ません"); ?>");
			<?php } ?>

			toggle_buttons.removeClass("active");
			toggle_buttons.eq(toggle_buttons.size()-1).addClass("active");
		}
	
		remodalAlert("normal_1200",main_title,message,params);
	}).
	fail(function(res){
	
		alert(res["message"]);
	});
}

var priceRateSetting=function(){

	var params={};
	params["yes"]=function(){};
	params["no"]   =params["yes"];
	params["close"]=params["yes"];
	params["select-room-num"]=function(e,status){

		if(status=="start") return;

		var addRoomOptions=function(room_id){
			var room_types={};
			for(var situation_id in effect_rooms){
			
				for(var room_id in effect_rooms[situation_id]){
				
					room_types[room_id]=effect_rooms[situation_id][room_id]["room_num"]+"("+effect_rooms[situation_id][room_id]["room_type"]+")";
				}
			}
			addOptions.call(this,room_types,room_id);
		}
		var setPriceRateMainLayout=function(information){

			var deferred=$.Deferred();

			var instance=TPL.getInstance(["remodal_price_room_num_setting"]);
			var main_tpl=instance.get_remodal_price_room_num_setting;
			var main_html=$(instance.replaceTPL(main_tpl,{ "template_title":"<?php echo __("部屋番号"); ?>" }));
			var start_calendar=main_html.find("input[data-type=\"calendar-start\"]");
			var end_calendar  =main_html.find("input[data-type=\"calendar-end\"]");
			var select_target =main_html.find("select[data-type=\"price-type-list\"]");
			addRoomOptions.call(select_target);
			setCalendarForInput.call(start_calendar,{
			
				"onSelect":function(selectDate){
				
					var end_val=end_calendar.val();
					if(1>end_val.length){
					
						end_calendar.val(selectDate);
						return;
					}
					var jp_start=replaceToJpDate(selectDate);
					var jp_end  =replaceToJpDate(end_val);
					if(jp_end>=jp_start) return;
					alert("<?php echo __("以前の日付を設定して下さい"); ?>");
					start_calendar.val("");
				}
			});

			setCalendarForInput.call(end_calendar,{
			
				"onSelect":function(selectDate){
					var start_val=start_calendar.val();
					if(1>start_val.length){
						
						start_calendar.val(selectDate);
						return;
					}
					var jp_start=replaceToJpDate(start_val);
					var jp_end  =replaceToJpDate(selectDate);
					if(jp_end>=jp_start) return;
					alert("<?php echo __("以降の日付を設定して下さい"); ?>");
					end_calendar.val("");
				}
			});
			return deferred.resolve(main_html,information);
		}

		var setPriceRateList=function(main_html,information){

			var deferred=$.Deferred();
			var instance=TPL.getInstance(["remodal_price_info_tr_values"]);
			var row_tpl=instance.get_remodal_price_info_tr_values;
			var add_target=main_html.find("tbody[data-type=\"price-rate-list\"]");
			var fragment=document.createDocumentFragment();
			var room_info=information["room"];
			var room_info_ary=Object.values(room_info);
			if(1>room_info_ary.length){
			
				return deferred.resolve(main_html,information);
			}
			var room_html;
			var price_rate_value;
			var par;
			var price;
			var start;
			var end;
			var range;
			room_info_ary.sort(function(a,b){

				if(a["data"]["end"]>b["data"]["end"]) return -1;
				if(b["data"]["end"]>a["data"]["end"]) return 1;
				return 0;
			});
			for(var i in room_info_ary){
			
				start=Number(room_info_ary[i]["data"]["start"]).splitYmd();
				end  =Number(room_info_ary[i]["data"]["end"]).splitYmd();
				range=viewYmd(start[0],start[1],start[2])+"〜"+viewYmd(end[0],end[1],end[2]);
				par  =room_info_ary[i]["data"]["par"];
				price=room_info_ary[i]["data"]["price"];
				switch(true){
				
					case(par>0):
					price_rate_value="<span style=\"color:red;\">"+(par+"%")+"</span>";
					break;
					default:
					price_rate_value="<span style=\"color:blue;\">"+Number(price).toLocaleString()+"</span>";
					break;
				}

				room_html=$(instance.replaceTPL(row_tpl,{
				
					"data_id" :room_info_ary[i]["data"]["id"],
					"staff"   :room_info_ary[i]["employee"]["name"],
					"room"    :room_info_ary[i]["room"]["room_num"]+"("+room_info_ary[i]["room"]["room_type"]+")",
					"value"   :price_rate_value,
					"range"   :range
				}));
				fragment.appendChild(room_html.get(0));
			};

			add_target.append(fragment);
			return deferred.resolve(main_html,information);
		}

		getPriceRatePlans().
		then(setPriceRateMainLayout).
		then(setPriceRateList).
		fail(function(res){ alert(res["message"]); }).
		done(function(main_html,information){

			var main_title="<?php echo __("部屋別特別金額"); ?>";
			var message=main_html;
			var params={};
			params["yes"]=function(){};
			params["no"]   =params["yes"];
			params["close"]=params["yes"];

			params["menu-list"]=function(e,type){

				if(type=="start") return;
			};

			params["remodal-close"]=function(e,type){
			
				if(type=="end") return;
			};

			params["menu-price"]=function(e,type){

				if(type=="start") return;

				main_html.removeData("data_id");
				main_html.find("input[data-type=\"calendar-start\"]").val("");
				main_html.find("input[data-type=\"calendar-end\"]").val("");
				var select=main_html.find("select[data-type=\"price-type-list\"]");
				var first_val=select.children("option").eq(0).val();
				main_html.find("select[data-type=\"price-type-list\"]").val(first_val);
				main_html.find("input[data-type=\"price-rate-value\"]").val(0);
				main_html.find("input[data-type=\"price-value\"]").val(0);
			};
			params["price-value-send-a"]=function(e,type){

				if(type=="start") return;

				var remodal=this;
				var start_date=main_html.find("input[data-type=\"calendar-start\"]").val();
				var end_date  =main_html.find("input[data-type=\"calendar-end\"]").val();
				var room_id   =main_html.find("select[data-type=\"price-type-list\"]").val();
				var par       =main_html.find("input[data-type=\"price-rate-value\"]").val();
				var price     =main_html.find("input[data-type=\"price-value\"]").val();
				var data_id   =main_html.data("data_id");
				var params={"data":{}};
				params["data"]["start_date"]=start_date;
				params["data"]["end_date"]  =end_date;
				params["data"]["room_id"]   =room_id;
				params["data"]["par"]       =par;
				params["data"]["price"]     =price;
				params["data"]["data_id"]   =data_id;
				params["type"]="room";
				apiGeoRequests.savePriceRate(params,function(status,res){

					if(!status && res["type"]==0){

						alert('<?php echo __("通信状況が安定しておりません"); ?>');
						return;
					}

					if(!status && res["type"]==1){
						alert(res["message"]);
						return;
					}

					alert("<?php echo __("設定した金額情報が内容が正常に登録されました"); ?>");

					information=res["data"];
					main_html.find("tbody[data-type=\"price-rate-list\"]").empty();
					setPriceRateList(main_html,information);
				});
			}
			params["price-rate-edit"]=function(e,type){
			
				if(type=="start") return;

				var data_id=$(e.target).parents("tr").attr("data-id");
				var data=information["room"][data_id];
				var menu=main_html.find("ul[data-type=\"price-type-menu\"]");
				var menu_li=menu.children("li");
				menu_li.removeClass("active");
				menu_li.eq(menu_li.size()-1).addClass("active");
				var start_val=Number(data["data"]["start"]).splitYmd().join("-");
				var end_val  =Number(data["data"]["end"]).splitYmd().join("-");
				var locale_start_date=replaceToLocalDate(start_val);
				var locale_end_date  =replaceToLocalDate(end_val);
				main_html.find("input[data-type=\"calendar-start\"]").val(locale_start_date);
				main_html.find("input[data-type=\"calendar-end\"]").val(locale_end_date);
				main_html.find("select[data-type=\"price-type-list\"]").val(data["room"]["id"]);
				main_html.find("input[data-type=\"price-rate-value\"]").val(data["data"]["par"]);
				main_html.find("input[data-type=\"price-value\"]").val(data["data"]["price"]);
				main_html.data("data_id",data_id);
			};

			params["price-rate-delete"]=function(e,type){

				if(type=="start") return;

				var data_id=$(e.target).parents("tr").attr("data-id");
				var data=information["room"][data_id];
				var room_num=data["room"]["room_num"];
				var start_ymd=Number(data["data"]["start"]).splitYmd();
				var start_locale_date=viewYmd(start_ymd[0],start_ymd[1],start_ymd[2]);
				var message="<?php echo __("削除して宜しいですか？");?>";
				var res=window.confirm(message+"("+room_num+" "+start_locale_date+"〜)");
				if(!res) return;
				removePriceRate(data_id,"room").
				fail(function(message){ alert(message); }).
				done(function(status,data){

					var message="<?php echo __("削除が完了しました"); ?>\n";
					message+="<?php echo __("金額が変動している可能性が御座います(画面を更新すると適用されます)"); ?>";
					main_html.find("tbody[data-type=\"price-rate-list\"]").children("tr[data-id=\""+data_id+"\"]").remove();
					alert(message);
				});
			};
			params["price-rate-check"]=function(e,type){

				if(type=="start") return;

				var data_id=$(e.target).parents("tr").attr("data-id");
				checkPriceRateView.call(main_html,data_id,"room",function(){
				
					var main_html=this;
					var menu=main_html.find("ul[data-type=\"price-type-menu\"]");
					var menu_li=menu.children("li");
					menu_li.removeClass("active");
				});
			};
			remodalAlert("normal_1200",main_title,message,params);
		});
	}
	params["select-room-type"]=function(e,status){

		if(status=="start") return;

		var addRoomOptions=function(room_type_id){

			addOptions.call(this,effect_room_types,room_type_id);
		}

		var setPriceRateMainLayout=function(information){

			var deferred=$.Deferred();
			var instance=TPL.getInstance(["remodal_price_room_num_setting"]);
			var main_tpl=instance.get_remodal_price_room_num_setting;
			var main_html=$(instance.replaceTPL(main_tpl,{ "template_title":"<?php echo __("部屋タイプ"); ?>" }));
			var start_calendar=main_html.find("input[data-type=\"calendar-start\"]");
			var end_calendar  =main_html.find("input[data-type=\"calendar-end\"]");
			var select_target =main_html.find("select[data-type=\"price-type-list\"]");
			addRoomOptions.call(select_target);

			setCalendarForInput.call(start_calendar,{
			
				"onSelect":function(selectDate){
				
					var end_val=end_calendar.val();
					if(1>end_val.length){
					
						end_calendar.val(selectDate);
						return;
					}
					var jp_start=replaceToJpDate(selectDate);
					var jp_end  =replaceToJpDate(end_val);
					if(jp_end>=jp_start) return;
					alert("<?php echo __("以前の日付を設定して下さい"); ?>");
					start_calendar.val("");
				}
			});

			setCalendarForInput.call(end_calendar,{
			
				"onSelect":function(selectDate){

					var start_val=start_calendar.val();

					if(1>start_val.length){
						
						start_calendar.val(selectDate);
						return;
					}

					var jp_start=replaceToJpDate(start_val);
					var jp_end  =replaceToJpDate(selectDate);
					if(jp_end>=jp_start) return;
					alert("<?php echo __("以降の日付を設定して下さい"); ?>");
					end_calendar.val("");
				}
			});
			return deferred.resolve(main_html,information);
		}

		var setPriceRateList=function(main_html,information){

			var deferred=$.Deferred();
			var instance=TPL.getInstance(["remodal_price_info_tr_values"]);
			var row_tpl=instance.get_remodal_price_info_tr_values;
			var add_target=main_html.find("tbody[data-type=\"price-rate-list\"]");
			var fragment=document.createDocumentFragment();
			var room_type_info=information["room_type"];
			var room_type_info_ary=Object.values(room_type_info);

			if(1>room_type_info_ary.length){
			
				return deferred.resolve(main_html,information);
			}

			room_type_info_ary.sort(function(a,b){

				if(a["data"]["end"]>b["data"]["end"]) return -1;
				if(b["data"]["end"]>a["data"]["end"]) return 1;
				return 0;
			});

			var room_html;
			var price_rate_value;
			var par;
			var price;
			var start;
			var end;
			var range;
			for(var i in room_type_info_ary){
			
				start=Number(room_type_info_ary[i]["data"]["start"]).splitYmd();
				end  =Number(room_type_info_ary[i]["data"]["end"]).splitYmd();
				range=viewYmd(start[0],start[1],start[2])+"〜"+viewYmd(end[0],end[1],end[2]);
				par  =room_type_info_ary[i]["data"]["par"];
				price=room_type_info_ary[i]["data"]["price"];
				switch(true){
				
					case(par>0):
					price_rate_value="<span style=\"color:red;\">"+(par+"%")+"</span>";
					break;
					default:
					price_rate_value="<span style=\"color:blue;\">"+Number(price).toLocaleString()+"</span>";
					break;
				}

				room_html=$(instance.replaceTPL(row_tpl,{
				
					"data_id" :room_type_info_ary[i]["data"]["id"],
					"room"    :room_type_info_ary[i]["room"]["type"],
					"staff"   :room_type_info_ary[i]["employee"]["name"],
					"value"   :price_rate_value,
					"range"   :range
				}));

				fragment.appendChild(room_html.get(0));
			};

			add_target.append(fragment);
			return deferred.resolve(main_html,information);
		}

		getPriceRatePlans().
		then(setPriceRateMainLayout).
		then(setPriceRateList).
		fail(function(res){ alert(res["message"]); }).
		done(function(main_html,information){

			var main_title="<?php echo __("部屋タイプ別特別金額"); ?>";
			var message=main_html;
			var params={};
			params["yes"]=function(){};
			params["no"]   =params["yes"];
			params["close"]=params["yes"];
			params["menu-list"]=function(e,type){

				if(type=="start") return;
			};

			params["remodal-close"]=function(e,type){
			
				if(type=="end") return;
			};

			params["menu-price"]=function(e,type){

				if(type=="start") return;

				main_html.removeData("data_id");
				main_html.find("input[data-type=\"calendar-start\"]").val("");
				main_html.find("input[data-type=\"calendar-end\"]").val("");
				var select=main_html.find("select[data-type=\"price-type-list\"]");
				var first_val=select.children("option").eq(0).val();
				main_html.find("select[data-type=\"price-type-list\"]").val(first_val);
				main_html.find("input[data-type=\"price-rate-value\"]").val(0);
				main_html.find("input[data-type=\"price-value\"]").val(0);
			};
			params["price-rate-edit"]=function(e,type){
			
				if(type=="start") return;
				var data_id=$(e.target).parents("tr").attr("data-id");
				var data=information["room_type"][data_id];
				var menu=main_html.find("ul[data-type=\"price-type-menu\"]");
				var menu_li=menu.children("li");
				menu_li.removeClass("active");
				menu_li.eq(menu_li.size()-1).addClass("active");
				var start_val=Number(data["data"]["start"]).splitYmd().join("-");
				var end_val  =Number(data["data"]["end"]).splitYmd().join("-");
				var locale_start_date=replaceToLocalDate(start_val);
				var locale_end_date  =replaceToLocalDate(end_val);
				main_html.find("input[data-type=\"calendar-start\"]").val(locale_start_date);
				main_html.find("input[data-type=\"calendar-end\"]").val(locale_end_date);
				main_html.find("select[data-type=\"price-type-list\"]").val(data["room"]["id"]);
				main_html.find("input[data-type=\"price-rate-value\"]").val(data["data"]["par"]);
				main_html.find("input[data-type=\"price-value\"]").val(data["data"]["price"]);
				main_html.data("data_id",data_id);
			};
			params["price-value-send-a"]=function(e,type){

				if(type=="start") return;

				var remodal=this;
				var start_date=main_html.find("input[data-type=\"calendar-start\"]").val();
				var end_date  =main_html.find("input[data-type=\"calendar-end\"]").val();
				var room_type_id=main_html.find("select[data-type=\"price-type-list\"]").val();
				var par       =main_html.find("input[data-type=\"price-rate-value\"]").val();
				var price     =main_html.find("input[data-type=\"price-value\"]").val();
				var data_id   =main_html.data("data_id");
				var params={"data":{}};
				params["data"]["start_date"]=start_date;
				params["data"]["end_date"]  =end_date;
				params["data"]["room_type_id"]=room_type_id;
				params["data"]["par"]       =par;
				params["data"]["price"]     =price;
				params["data"]["data_id"]   =data_id;
				params["type"]="room-type";
				apiGeoRequests.savePriceRate(params,function(status,res){

					if(!status && res["type"]==0){

						alert('<?php echo __("通信状況が安定しておりません"); ?>');
						return;
					}

					if(!status && res["type"]==1){

						alert(res["message"]);
						return;
					}

					alert("<?php echo __("設定した金額情報が内容が正常に登録されました"); ?>");

					information=res["data"];
					main_html.find("tbody[data-type=\"price-rate-list\"]").empty();
					setPriceRateList(main_html,information);
				});
			}
			params["price-rate-delete"]=function(e,type){

				if(type=="start") return;

				var data_id=$(e.target).parents("tr").attr("data-id");
				var data=information["room_type"][data_id]["data"];
				var room=information["room_type"][data_id]["room"];
				var room_type=room["type"];
				var start_ymd=Number(data["start"]).splitYmd();
				var start_locale_date=viewYmd(start_ymd[0],start_ymd[1],start_ymd[2]);
				var message="<?php echo __("削除して宜しいですか？");?>";
				var res=window.confirm(message+"("+room_type+" "+start_locale_date+"〜)");
				if(!res) return;
				removePriceRate(data_id,"room-type").
				fail(function(message){ alert(message); }).
				done(function(status,data){

					var message="<?php echo __("削除が完了しました"); ?>\n";
					message+="<?php echo __("金額が変動している可能性が御座います(画面を更新すると適用されます)"); ?>";
					main_html.find("tbody[data-type=\"price-rate-list\"]").children("tr[data-id=\""+data_id+"\"]").remove();
					alert(message);
				});
			};
			var makeViewCheckPriceRate=function(information){
			
				var deferred=$.Deferred();
				var instance=TPL.getInstance(["remodal_price_value","remodal_price_title"]);
				var main_tpl=instance.get_remodal_price_title;
				var price_value_tpl=instance.get_remodal_price_value;
				var fragment=document.createDocumentFragment();
				var names;
				var first_name;
				var middle_name;
				var last_name;
				var guest_name;
				var main_html;
				var ul;
				for(var reserve_id in information){

					names=[];
					first_name =information[reserve_id]["guest"]["first_name"];
					middle_name=information[reserve_id]["guest"]["middle_name"];
					last_name  =information[reserve_id]["guest"]["last_name"];
					if(first_name.length>0)  names.push(first_name);
					if(middle_name.length>0) names.push(middle_name);
					if(last_name.length>0)   names.push(last_name);
					guest_name=names.join(" ").trim();
					main_html=instance.replaceTPL(main_tpl,{
					
						"guest_name":guest_name,
						"reserve_id":reserve_id,
					});
				}
				return deferred.resolve();
			}

			params["price-rate-check"]=function(e,type){

				if(type=="start") return;
				var data_id=$(e.target).parents("tr").attr("data-id");
				checkPriceRateView.call(main_html,data_id,"room-type",function(){
				
					var main_html=this;
					var menu=main_html.find("ul[data-type=\"price-type-menu\"]");
					var menu_li=menu.children("li");
					menu_li.removeClass("active");
				});
			};

			remodalAlert("normal_1200",main_title,message,params);
		});
	}

	var instance=TPL.getInstance(["remodal_price_type_select"]);
	var main_tpl=instance.get_remodal_price_type_select;
	var main_title="<?php echo __("金額特別設定"); ?>";
	var message=$(main_tpl);
	remodalAlert("normal_600",main_title,message,params);
}

var guestInfo=function(guest_hash){

	var target=this;

	var getHistroyInformation=function(){

		var deferred=$.Deferred();

		var params={};
		params["guest_hash"]=guest_hash;
		apiGeoRequests.getHistory(params,function(status,res){

			if(!status) return deferred.reject(res);
			var information=res["data"];
			deferred.resolve(information);
		});

		return deferred.promise();
	}

	var makeHistoryView=function(information){

		var deferred=$.Deferred();

		var guest  =information["guest"];
		var history=information["history"];
		var fragment=document.createDocumentFragment();
		var instance=TPL.getInstance(["remodal_guest_history","remodal_guest_history_li"]);
		var history_main_tpl=instance.get_remodal_guest_history;
		var history_li_tpl  =instance.get_remodal_guest_history_li;

		var name=[];
		name.push(guest["guest"]["last_name"].length  ?guest["guest"]["last_name"]:"");
		name.push(guest["guest"]["middle_name"].length?guest["guest"]["middle_name"]:"");
		name.push(guest["guest"]["first_name"].length ?guest["guest"]["first_name"]:"");

		var history_main_html=$(instance.replaceTPL(history_main_tpl,{ "guest_name":name.join(" ") }));
		var add_target_ul=history_main_html.find("ul[data-type=\"history-list\"]");

		var plans;
		var history_li_html;
		var split_ymd;
		for(var reserve_id in history){

			plans=history[reserve_id]["plan"];
			for(var i in plans){

				split_ymd=Number(plans[i]["plan"]["start"]).splitYmd();
				history_li_html=$(instance.replaceTPL(history_li_tpl,{
				
					"start_date":viewYmd(split_ymd[0],split_ymd[1],split_ymd[2]),
					"reserve_id":reserve_id,
					"room_type" :plans[i]["room"]["room_type"],
					"room_num"  :plans[i]["room"]["room_num"],
					"remark"    :plans[i]["plan"]["remarks"].length>0?plans[i]["plan"]["remarks"]:"&nbsp;"
				}));

				fragment.appendChild(history_li_html.get(0));
			}
		}

		add_target_ul.append(fragment);
		return deferred.resolve(history_main_html,information);
	}

	getHistroyInformation().
	then(makeHistoryView).
	done(function(history_main_html,information){

		var main_title="<?php echo __("宿泊履歴"); ?>";
		var message=history_main_html;
		remodalAlert("normal_800",main_title,message,{

			"yes"  :function(){},
			"no"   :function(){},
			"close":function(){},
			"remodal-close":function(e,type){

				if(type=="end") return;
			}
		});

	}).
	fail(function(res){
	
		alert(res["message"]);
	});
}

var priceTotal=function(reservation_hash,callback){

	var target=this;

	var getPriceInformation=function(){

		var deferred=$.Deferred();

		var params={};
		params["reservation_hash"]=reservation_hash;
		apiGeoRequests.getPriceHistory(params,function(status,res){
		
			var information=res["data"];
			deferred.resolve(information);
		});

		return deferred.promise();
	}

	var priceHistoryBaseView=function(information){

		var deferred=$.Deferred();

		var price_info=information["information"];
		var guest_info=information["guest"];
		var instance=TPL.getInstance(["remodal_total_price"]);
		var total_price_tpl=instance.get_remodal_total_price;

		var name=[];
		name.push(guest_info["last_name"].length  ?guest_info["last_name"]:"");
		name.push(guest_info["middle_name"].length?guest_info["middle_name"]:"");
		name.push(guest_info["first_name"].length ?guest_info["first_name"]:"");

		var view_name=name.join(" ").trim();
		if(1>view_name.length) view_name="<?php echo __("宿泊者名未設定"); ?>";

		var base_html=$(instance.replaceTPL(total_price_tpl,{
		
			"guest_name":view_name
		}));

		return deferred.resolve(base_html,information);
	}

	var priceHistoryRowView=function(base_html,information){

		var deferred=$.Deferred();
		var price_all_rows=base_html.find("tbody[data-type=\"price-all-rows\"]");
		var price_info=information["information"];
		var guest_info=information["guest"];

		var instance=TPL.getInstance(["remodal_total_price_row",
									  "remodal_total_meal_price_par_row",
								      "remodal_total_room_price_par_row"]);

		var total_price_row_tpl  =instance.get_remodal_total_price_row;
		var total_price_par_row_tpl=instance.get_remodal_total_room_price_par_row;
		var total_meal_price_par_row_tpl=instance.get_remodal_total_meal_price_par_row;

		var price_type_colors={"0":"black","3":"blue","4":"red","5":"green","6":"purple"};
		var room_type_notice={"3":"<?php echo __("部屋別特別金額"); ?>",
			                  "4":"<?php echo __("部屋タイプ別特別金額"); ?>",
							  "5":"<?php echo __("週末価格"); ?>",
							  "6":"<?php echo __("特別価格"); ?>"
		};

		var room_info;
		var room_price_info;
		var resturant_info;
		var resturant_price_info;
		var price_row_html;
		var price_par_row_html;
		var split_ymd;
		var room_price_type;
		var price_ymd_total={};
		var price_row_tpls={};
		var price_color;
		var price_type_detail;
		var price;
		var employee_info;
		for(var ymd in price_info){

			room_info      =price_info[ymd]["room"]["room"];
			room_price_info=price_info[ymd]["room"]["price"];
			employee_info=price_info[ymd]["room"]["employee"];
			room_price_type=room_price_info["room_price_status"];
			price_color      =(price_type_colors[room_price_type]!=undefined)?price_type_colors[room_price_type]:price_type_colors["0"];
			price_type_detail=(room_type_notice[room_price_type]!=undefined) ?"("+room_type_notice[room_price_type]+")":" ";
			price=Number(room_price_info["price"]).toLocaleString();
			if(room_price_info["par"]!=undefined && room_price_info["par"]>0) price+="<span style=\"color:red;\">("+room_price_info["par"]+"%)</span>";
			price_par_row_html=instance.replaceTPL(total_price_par_row_tpl,{
			
				"room_type"        :room_info["room_type"],
				"room_type_id"     :room_info["room_type_id"],
				"price"            :price,
				"price_color"      :price_color,
				"price_type_detail":price_type_detail,
				"employee_id"      :employee_info["id"],
				"staff"            :employee_info["name"],
			});

			if(price_row_tpls[ymd]==undefined) price_row_tpls[ymd]=[];
			price_row_tpls[ymd].push(price_par_row_html);

			if(price_ymd_total[ymd]==undefined) price_ymd_total[ymd]=0;
			price_ymd_total[ymd]+=parseFloat(room_price_info["price"]);
		}

		var __addOrderForTotal=function(type){

			var infos;
			var info;
			var price_par_row_html;
			var price;
			var employee_info;
			for(var ymd in price_info){

				if(price_info[ymd][type]==undefined) continue;
				infos=price_info[ymd][type];
				for(var i in infos){
				
					info=infos[i];
					price=Number(info["price"]["price"]).toLocaleString();
					price_par_row_html=$(instance.replaceTPL(total_meal_price_par_row_tpl,{
					
						"food_id"    :info["meal"]["id"],
						"name"       :info["meal"]["name"],
						"remarks"    :info["meal"]["remarks"].length>0?info["meal"]["remarks"]:"&nbsp;",
						"price"      :price,
						"employee_id":info["employee"]["id"],
						"staff"      :info["employee"]["name"],
					}));

					price_row_tpls[ymd].push(price_par_row_html);
					price_ymd_total[ymd]+=parseFloat(price);
				}
			}
		}

		__addOrderForTotal("<?php echo K9MasterFood::$CATEGORY_FOOD; ?>");
		__addOrderForTotal("<?php echo K9MasterBeverage::$CATEGORY_DRINK; ?>");
		__addOrderForTotal("<?php echo K9MasterSpa::$CATEGORY_SPA; ?>");
		__addOrderForTotal("<?php echo K9MasterTobacco::$CATEGORY_TOBACCO; ?>");
		__addOrderForTotal("<?php echo K9MasterLimousine::$CATEGORY_LIMOUSINE; ?>");
		__addOrderForTotal("<?php echo K9MasterLaundry::$CATEGORY_LAUNDRY; ?>");
		__addOrderForTotal("<?php echo K9MasterRoomservice::$CATEGORY_ROOMSERVICE; ?>");

		var rows;
		var total_price=0;
		var row_fragment=document.createDocumentFragment();
		var price_row_fragment;
		var local_ymd;
		for(var ymd in price_info){

			room_info      =price_info[ymd]["room"]["room"];
			room_price_info=price_info[ymd]["room"]["price"];

			split_ymd=Number(ymd).splitYmd();
			local_ymd=viewYmd(split_ymd[0],split_ymd[1],split_ymd[2]);
			total_price=price_ymd_total[ymd];

			price_row_html=$(instance.replaceTPL(total_price_row_tpl,{

				"room_num"   :room_info["room_num"],
				"total_price":Number(total_price).toLocaleString()+"$",
				"date"       :local_ymd,
				"count"      :1
			}));

			rows       =price_row_tpls[ymd];
			price_total=price_ymd_total[ymd];
			price_row_fragment=document.createDocumentFragment();
			for(var i in rows) price_row_fragment.appendChild($(rows[i]).get(0));
			price_row_html.find("td[data-type=\"price-rows\"]").append(price_row_fragment);
			row_fragment.appendChild(price_row_html.get(0));
		}

		price_all_rows.append(row_fragment);
		return deferred.resolve(base_html,price_ymd_total,information);
	}

	var priceHistoryTotal=function(base_html,price_ymd_total,information){

		var deferred=$.Deferred();

		var total_price=0;
		for(var ymd in price_ymd_total) total_price+=parseFloat(price_ymd_total[ymd]);
		var total_price_html=base_html.find("h3[data-type=\"price-total\"]");
		var total_price=Number(total_price).toLocaleString();
		total_price_html.children("strong").html(total_price+"$");
		return deferred.resolve(base_html,information);
	}

	var priceHistoryShow=function(base_html,information){

		var deferred=$.Deferred();

		var main_title="<?php echo __("現在の金額の集計"); ?>";
		var message=base_html;
		remodalAlert("normal_1200",main_title,message,{
		
			"opened":function(){},
			"remodal-close":function(e,type){
			
				if(type=="end") return;

				var remodal=this;
				if($.isFunction(callback)) callback.call(remodal);
			}
		});

		return deferred.resolve();
	}

	getPriceInformation(reservation_hash).
	then(priceHistoryBaseView).
	then(priceHistoryRowView).
	then(priceHistoryTotal).
	then(priceHistoryShow).

		done(function(){
	});
}

var roomSituation=function(){

	var getRoomSituations=function(){
	
		var deferred=$.Deferred();

		var params={};
		apiGeoRequests.getRoomSituation(params,function(status,res){

			if(!status) return deferred.reject(res);
			return deferred.resolve(res["data"]);
		});

		return deferred.promise();
	}

	var makeRoomSituationMainView=function(information){
	
		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_room_situation"]);
		var main_tpl=instance.get_remodal_room_situation;
		var main_html=$(main_tpl);
		return deferred.resolve(main_html,information);
	}

	var makeRoomSituationListView=function(main_html,information){

		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_room_situation_child"]);
		var child_tpl=instance.get_remodal_room_situation_child;
		var fragment=document.createDocumentFragment();
		var situations=information["situations"];
		var room_situations=information["room_situations"];

		var situation;
		var room_num;
		var room_type;
		var room_floor;
		var child_html;
		var current_situation;
		var add_select_target;
		var bgcolor;
		var fontcolor;
		var situation_id;
		var is_room_enable;
		for(var room_id in room_situations){

			situation=room_situations[room_id];
			room_num  =situation["room"]["room_num"];
			room_type =situation["room"]["room_type"];
			room_floor=situation["room"]["room_floor"];
			bgcolor   =situation["situation"]["bgcolor"];
			fontcolor =situation["situation"]["fontcolor"];

			current_situation_id=situation["situation"]["situation_id"];
			situation_id=situation["situation"]["situation_id"];
			is_room_enable=situation["room"]["is_enable"];

			child_html=$(instance.replaceTPL(child_tpl,{
			
				"room_num" :room_num,
				"room_type":room_type,
				"room_id"  :room_id,
				"bgcolor"  :bgcolor,
				"fontcolor":fontcolor
			}));

			switch(is_room_enable){
			
			case(true):
				add_select_target=child_html.find("select[data-type=\"room-situation-select\"]");
				setMenu.call(add_select_target,situations["situation"]);
				add_select_target.val(current_situation_id);
				break;
			case(false):
				add_select_target=child_html.find("select[data-type=\"room-situation-select\"]");
				add_select_target.propDisable(true);
				child_html.find("a[data-type=\"situation-edit\"]").remove();
				break;
			}

			fragment.appendChild(child_html.get(0));
		}

		main_html.find("div[data-type=\"room-list\"]").append(fragment);
		return deferred.resolve(main_html,information);
	}

	var makeRoomSituationSelectChange=function(main_html,information){
	
		var deferred=$.Deferred();

		var selects=main_html.find("select[data-type=\"room-situation-select\"]");
		selects.change(function(e){
		
			var target=$(this);
			var situation_id=target.val();
			var parent=target.parents("div[data-type=\"room-situation-row-top\"]");
			var room_id=parent.attr("data-room-id");
			var style=information["situations"]["bgcolor"][situation_id];
			parent.find("div[data-type=\"room-num\"]").css("background-color",style);
		});

		return deferred.resolve(main_html,information);
	}

	getRoomSituations().
	then(makeRoomSituationMainView).
	then(makeRoomSituationListView).
	then(makeRoomSituationSelectChange).
	done(function(main_html,information){

		var main_title="<?php echo __("部屋清掃状況"); ?>";
		var message=main_html;
		var is_edit=false;

		var params={};
		params["yes"]=function(){};
		params["no"]   =params["yes"];
		params["close"]=params["yes"];
		params["remodal-close"]=function(e,type){
		
			if(type=="end") return;
			if(!is_edit) return;
			reloadSchedule();
		}
		params["situation-edit"]=function(e,type){

			if(type=="start") return;
			var target =$(e.target);
			var parent =target.parents("div[data-type=\"room-situation-row-top\"]");
			var room_id=parent.attr("data-room-id");
			var select=parent.find("select[data-type=\"room-situation-select\"]");
			var situation_id=select.val();

			var saveCurrentSituation=function(room_id,situation_id){
			
				var deferred=$.Deferred();

				var params={};
				params["situation_id"]=situation_id;
				params["room_id"]=room_id;
				apiGeoRequests.saveRoomSituation(params,function(status,res){
				
					if(!status) return deferred.reject(res);
					var data=res["data"];
					deferred.resolve(room_id,situation_id);
				});

				return deferred.promise();
			}

			saveCurrentSituation(room_id,situation_id).
			done(function(room_id,situation_id){

				var target=main_html.find("div[data-type=\"room-situation-row-top\"][data-room-id=\""+room_id+"\"]");
				var select=target.find("select");
				select.css("background-color","#fff");

				information["room_situations"][room_id]["situation"]["situation_id"]=situation_id;
	
				alert("<?php echo __("部屋状況の変更が完了しました"); ?>");
				is_edit=true;

			}).
			fail(function(res){ alert(res["message"]); })

		};

		remodalAlert("normal_1200",main_title,message,params);

	}).
	fail(function(res){ alert(res["message"]); });
}

var viewCheckin=function(params){

	var schedule_site_box=this;

	var viewCheckin=function(){
	
		var deferred=$.Deferred();
		var instance=TPL.getInstance("remodal_checkin");
		var checkin_html=$(instance.get_remodal_checkin);
		return deferred.resolve(checkin_html);
	}

	viewCheckin().
	done(function(checkin_html){

		var main_title="<?php echo __("チェックイン"); ?>";
		var message=checkin_html;
		remodalAlert("normal_600",main_title,message,{

			"yes"  :function(){},
			"no"   :function(){},
			"close":function(){},
			"remodal-close":function(e,type){
			
				if(type=="end") return;
				checkin_html=null;
			},
			"select-checkin-yes":function(e,type){

				if(type=="start") return;
				params["yes"].call(this,e);
			},
			"select-checkin-no" :function(e,type){

				if(type=="start") return;
				params["no"].call(this,e);
			}
		});
	});
}

var viewCheckout=function(params){

	var viewCheckout=function(){
	
		var deferred=$.Deferred();
		var instance=TPL.getInstance("remodal_checkout");
		var checkin_html=$(instance.get_remodal_checkout);
		return deferred.resolve(checkin_html);
	}

	viewCheckout().
	done(function(checkin_html){

		var main_title="<?php echo __("チェックアウト"); ?>";
		var message=checkin_html;
		remodalAlert("normal_600",main_title,message,{

			"yes"  :function(){},
			"no"   :function(){},
			"close":function(){},
			"remodal-close":function(e,type){
			
				if(type=="end") return;
				checkin_html=null;
			},
			"select-checkin-yes":function(e,type){

				if(type=="start") return;
				params["yes"].call(this,e);
			},
			"select-checkin-no" :function(e,type){

				if(type=="start") return;
				params["no"].call(this,e);
			},
		});
	});
}

var replaceToLocalDate=function(date,jp_separator,en_separator){

	<?php if(Configure::read('Config.language')=="eng"){ ?>
	return replaceToEngDate(date,en_separator);
	<?php }elseif((Configure::read('Config.language')=="jpn")){?>
	return replaceToJpDate(date,jp_separator);
	<?php } ?>
	return date;
}

var replaceToLocaleFormatWithYmd=function(ymd){

	var split_ymd=Number(ymd).splitYmd();
	<?php if(Configure::read('Config.language')=="jpn"){ ?>
	var locale_ymd=split_ymd.join("/");
	<?php }elseif((Configure::read('Config.language')=="eng")){?>
	var dates=[];
	dates.push(split_ymd[1]);
	dates.push(split_ymd[2]);
	dates.push(split_ymd[0]);
	var locale_ymd=dates.join("/");
	<?php } ?>
	return locale_ymd;
}

var replaceToYmd=function(date){

	var dates=replaceToYmdSplit(date);
	return dates.join("");
}

var dateSplitLocaleSaparator=function(date){

	var reg=/[-\/]/;
	var date_split=date.split(reg);
	return date_split;
}

var getYmdWithLocaleSplitdates=function(split_ymd){

	<?php if(Configure::read('Config.language')=="jpn"){ ?>
	var locale_ymd=split_ymd.join("");
	<?php }elseif((Configure::read('Config.language')=="eng")){?>
	var dates=[];
	dates.push(split_ymd[2]);
	dates.push(split_ymd[0]);
	dates.push(split_ymd[1]);
	var locale_ymd=dates.join("");
	<?php } ?>
	return locale_ymd;
}

var replaceToYmdSplit=function(date){

	var date_split=dateSplitLocaleSaparator(date);
	var is_jp=date_split[0].length==4;
	if(is_jp) return date_split;

	var dates=[];
	dates.push(date_split[2]);
	dates.push(date_split[0]);
	dates.push(date_split[1]);
	return dates;
}

var replaceToJpDate=function(date,separator){

	if(separator==undefined) separator="-";

	var ymd=replaceToYmd(date);

	var dates=[];
	var y=ymd.substr(0,4);
	var m=ymd.substr(4,2);
	var d=ymd.substr(6,2);
	dates.push(y);
	dates.push(m);
	dates.push(d);
	return dates.join(separator);
}

var replaceToEngDate=function(date,separator){

	if(separator==undefined) separator="/";

	var ymd=replaceToYmd(date);

	var dates=[];
	var y=ymd.substr(0,4);
	var m=ymd.substr(4,2);
	var d=ymd.substr(6,2);
	dates.push(m);
	dates.push(d);
	dates.push(y);
	return dates.join(separator);
}

var itemCharge=function(reservation_hash,main_title,menu_type){

	var target=this;

	var schedule_site_box=target.parents("div[data-type=\"schedule-site-box\"]");
	var reserve_id       =schedule_site_box.attr("data-reservation-id");
	var guest_id         =schedule_site_box.attr("data-guest-id");
	var ymd              =schedule_site_box.attr("data-time");
	var schedule_id      =schedule_site_box.attr("data-schedule-id");

	var allow_types=[

		"<?php echo K9MasterFood::$CATEGORY_FOOD; ?>",
		"<?php echo K9MasterBeverage::$CATEGORY_DRINK; ?>",
		"<?php echo K9MasterSpa::$CATEGORY_SPA; ?>",
		"<?php echo K9MasterTobacco::$CATEGORY_TOBACCO; ?>",
		"<?php echo K9MasterLimousine::$CATEGORY_LIMOUSINE; ?>",
		"<?php echo K9MasterLaundry::$CATEGORY_LAUNDRY; ?>",
		"<?php echo K9MasterReststay::$CATEGORY_RESTSTAY; ?>",
		"<?php echo K9MasterRoomservice::$CATEGORY_ROOMSERVICE; ?>"
	];

	if(0>allow_types.indexOf(menu_type)) alert("miss menu type.");

	var setFoodTemplates=function(){
		
		var deferred=$.Deferred();
		var instance=TPL.getInstance(["list_main_menus","select_menu_row","menu_row","menu_list","menu_tab_list"]);
		return deferred.resolve(instance);
	}

	var getInformations=function(tpl){

		var deferred=$.Deferred();

		var params={};
		params["reservation_hash"]=reservation_hash;
		params["date"]=ymd;
		params["type"]=menu_type;
		apiGeoRequests.getOrderInformations(params,function(status,res){

			if(!status) return deferred.reject(res);
			var informations=res["data"];
			var menus=informations["list"]["menus"];
			var information=informations["list"]["list"];
			var order=informations["order"]["data"];
			var prices=informations["price"]["data"];
			var cash_types=informations["menus"]["cash_types"];
			deferred.resolve(tpl,information,menus,order,prices,cash_types);
		});

		return deferred.promise();
	}

	var setMenuTabFragment=function(tpl,menus){

		var category;
		var aliase;
		var menu_tab_html;
		var menu_tab_tpl=tpl.get_menu_tab_list;
		var tab_fragment=document.createDocumentFragment();
		for(var aliase in menus){

			menu=menus[aliase];
			menu_tab_html=$(tpl.replaceTPL(menu_tab_tpl,{
			
				"category_aliase":aliase,
				"name":menu
			}));

			tab_fragment.appendChild(menu_tab_html.get(0));
		}

		return tab_fragment;
	}

	var setDataTabFragment=function(tpl,aliases,menus,information,prices,order,cash_types,fragment){
	
		if(1>aliases.length) return fragment;

		var fn=arguments.callee;
		var aliase=aliases.shift();
		var category=menus[aliase];
		var data_tab_tpl=tpl.get_menu_list;
		var data_row_tpl=tpl.get_menu_row;
		var data_tab_html=$(tpl.replaceTPL(data_tab_tpl,{
		
			"category_aliase":aliase,
			"category":category
		}));

		fragment=(fragment==undefined)?document.createDocumentFragment():fragment;

		var row_fragment=document.createDocumentFragment();
		var data_tbody=data_tab_html.find("tbody[data-type=\"data-tbody\"]");
		var category_information=information[aliase];
		var data_row_html;
		var remarks;
		var cash_type_select;
		var master_id;
		var count;
		var cash_type_id;
		var is_cash_type_id;

		for(var counter_index in category_information){

			master_id=category_information[counter_index]["master_id"];
			if($.isArray(prices[master_id]) && 1>prices[master_id].length) continue;

			remarks=(category_information[counter_index]["remarks"].length>0?category_information[counter_index]["remarks"]:"&nbsp;");
			data_row_html=$(tpl.replaceTPL(data_row_tpl,{
			
				"meal_id"  :counter_index,
				"master_id":master_id,
				"title"    :category_information[counter_index]["name"],
				"item_num" :category_information[counter_index]["item_num"],
				"price"    :prices[master_id]["data"]["price"],
				"staff"    :prices[master_id]["employee"]["name"],
				"remarks"  :remarks,
				"aliase"   :aliase
			}));

			count=(order[aliase]!=undefined && order[aliase][master_id]!=undefined)?order[aliase][master_id]["data"]["count"]:0;
			data_row_html.find("input[type=number]").val(count);

			var cash_type_select=data_row_html.find("select[data-type=\"select-cash\"]");
			setMenu.call(cash_type_select,cash_types);

			is_cash_type_id=(order[aliase]!=undefined && order[aliase][master_id]!=undefined);
			cash_type_id=(is_cash_type_id)?order[aliase][master_id]["cash"]["id"]:cash_type_select.children("option").eq(0).val();
			cash_type_select.val(cash_type_id);

			row_fragment.appendChild(data_row_html.get(0));
		}

		data_tbody.append(row_fragment);
		fragment.appendChild(data_tab_html.get(0));
		return fn(tpl,aliases,menus,information,prices,order,cash_types,fragment);
	}

	var setLayout=function(tpl,information,menus,order,prices,cash_types){

		var deferred=$.Deferred();
		var date=replaceToLocalDate(Number(ymd).splitYmd().join("-"));
		var main_tpl=tpl.replaceTPL(tpl.get_list_main_menus,{ "date":date });
		var main_html=$(main_tpl);
		var menu_list=main_html.find("div[data-type=\"menu-list\"]");
		var menu_tab_list=main_html.find("ul[data-type=\"menu-tab-list\"]");
		var main_fragment=document.createDocumentFragment();
		var tab_fragment=document.createDocumentFragment();
		var tab_fragment=setMenuTabFragment(tpl,menus);
		menu_tab_list.append(tab_fragment);
		var aliases=Object.keys(menus);
		var data_fragment=setDataTabFragment(tpl,aliases,menus,information,prices,order,cash_types);
		menu_list.append(data_fragment);

		return deferred.resolve(tpl,main_html,information,menus,order,prices,cash_types);
	}

	var getSelectedValueForEditNeeded=function(order,information){

		var main_html=this;
		var edit_values={}; 
		var data_rows=main_html.find("tr[data-type=\"data-menu-row\"]");
		data_rows.each(function(){
		
			var target=$(this);
			var aliase=target.parents("div[data-type=\"food-menu-list\"]").attr("data-aliase-type");
			var counter_index=target.attr("data-id");
			var input=target.find("input");
			var cash_type_select=target.find("select[data-type=\"select-cash\"]");
			var cash_type_id=cash_type_select.val();
			var count=Math.max(input.val().trim(),0);
			var master_id=information[aliase][counter_index]["master_id"];

			if(count>0 && (order[aliase]==undefined || order[aliase][master_id]==undefined)){

				if(edit_values[master_id]==undefined) edit_values[master_id]={};
				edit_values[master_id]["count"]=count;
				edit_values[master_id]["cash_type_id"]=cash_type_id;
				return;
			}

			if(order[aliase]==undefined) return;
			if(order[aliase][master_id]==undefined) return;

			if(order[aliase][master_id]["data"]["count"]!=count || order[aliase][master_id]["cash"]["id"]!=cash_type_id){

				if(edit_values[master_id]==undefined) edit_values[master_id]={};
				edit_values[master_id]["count"]=count;
				edit_values[master_id]["cash_type_id"]=cash_type_id;
				return;	
			}
		});

		return edit_values;
	}

	var viewFoodRemodal=function(tpl,main_html,information,menus,order,prices,cash_types){

		var deferred=$.Deferred();

		var message=main_html;

		var params={};
		params["yes"]=function(){};
		params["no"]=function(){};
		params["close"]=function(){};
		params["remodal-close"]=function(e,type){
		
			if(type=="end") return;
		};

		params["select_menu_row_a"]=function(e,type){
		
			if(type=="start") return;
			var target=$(e.target);
			var data_select_row=target.parents("tr[data-type=\"data-select-row\"]");
			var counter_index=data_select_row.attr("data-id");
			var aliase=data_select_row.attr("data-aliase-type");
			var master_id=data_select_row.attr("data-master-id");

			var row=main_html.find("tr[data-type=\"data-menu-row\"][data-aliase-type=\""+aliase+"\"][data-master-id=\""+master_id+"\"]");

			var input=row.find("input[type=number]");
			var menu_tab_list=main_html.find("ul[data-type=\"menu-tab-list\"]");
			var tab_lis=menu_tab_list.children("li");
			tab_lis.removeClass("active");
			var category_aliase=row.parents("div[data-type=\"food-menu-list\"]").attr("data-aliase-type");
			var target_tab_li=tab_lis.filter("[data-aliase-type=\""+category_aliase+"\"]");
			target_tab_li.addClass("active");

			var focus=function(){

				var input=this;
				var fn=arguments.callee;
				setTimeout(function(){

					if(input.is(":visible")) return input.focus();
					fn.call(input);

				},100);

			}.bind(input);

			focus();
		};

		params["other-item"]=function(e,type){

			if(type=="start") return;

			var remodal=this;
			var edit_values=getSelectedValueForEditNeeded.call(main_html,order,information);
			if(Object.keys(edit_values).length>0){

				var res=window.confirm("<?php echo __("変更された情報は保存されませんが宜しいですか？"); ?>");
				if(!res) return;
			}

			order=null;
			remodal.close(null,function(){

				mealSetting.call(target,reservation_hash);
			});
			return;
		}

		params["order-save"]=function(e,type){
		
			if(type=="start") return;

			var edit_values=getSelectedValueForEditNeeded.call(main_html,order,information);
			if(1>Object.keys(edit_values).length){
			
				alert("<?php echo __('変更されたメニューは存在しません'); ?>");
				return;
			}

			var params={};
			params["order"]=edit_values;
			params["schedule_id"]=schedule_id;
			params["type"]=menu_type;
			params["reservation_hash"]=reservation_hash;
			apiGeoRequests.orderSubscribe(params,function(status,res){

				if(!status){
				
					alert(res["message"]);
					return;
				}

				//update current order histories.
				order=res["data"]["order"];

				alert("<?php echo __('設定した内容が正常に登録されました'); ?>");
			});
		}

		params["tab-selected"]=function(e,type){
		
			if(type=="start") return;
		}

		remodalAlert("normal_1200",main_title,message,params);

		return deferred.resolve(tpl,main_html,information,menus,order,prices,cash_types);
	}
	
	var getOrderFragment=function(tpl,order,prices,information){

		var select_row_tpl=tpl.get_select_menu_row;
		var select_row_html;
		var fragment=document.createDocumentFragment();
		var food_id;
		var count;
		var cash_type_id;
		var aliase;
		var counter_index;

		for(var aliase in order){
		
			for(var master_id in order[aliase]){

				aliase   =order[aliase][master_id]["category"]["aliase"];
				count    =order[aliase][master_id]["data"]["count"];
				remarks  =(order[aliase][master_id]["menu"]["remarks"].length>0?order[aliase][master_id]["menu"]["remarks"]:"&nbsp;");

				select_row_html=tpl.replaceTPL(select_row_tpl,{
				
					"meal_id"  :counter_index,
					"master_id":master_id,
					"title"    :order[aliase][master_id]["menu"]["name"],
					"price"    :prices[master_id]["data"]["price"],
					"count"    :order[aliase][master_id]["data"]["count"],
					"staff"    :prices[master_id]["employee"]["name"],
					"remarks"  :remarks,
					"cash_type":order[aliase][master_id]["cash"]["card_type"],
					"category_aliase":order[aliase][master_id]["category"]["aliase"]
				});

				fragment.appendChild($(select_row_html).get(0));
			}
		}
	
		return fragment;
	}

	var setOrder=function(tpl,main_html,information,menus,order,prices,cash_types){

		var deferred=$.Deferred();

		if(1>Object.keys(order).length) return deferred.resolve(tpl,main_html,information,menus,order,prices,cash_types);

		var target=main_html.find("div[id=\"selected_food\"]");
		var target_tbody=target.find("tbody[data-type=\"data-tbody\"]");

		var fragment=getOrderFragment(tpl,order,prices,information);
		target_tbody.append(fragment);

		return deferred.resolve(tpl,main_html,information,menus,order,prices,cash_types);
	}

	var setSelectedMenu=function(tpl,main_html,information,menus,order,prices,cash_types){
	
		var deferred=$.Deferred();
		var food_ids=Object.keys(order);
		if(1>food_ids.length) return deferred.resolve(tpl,main_html,information,menus,order,prices,cash_types);

		var selectors=[];
		for(var i in food_ids) selectors.push("tr[data-type=\"data-menu-row\"][data-id=\""+food_ids[i]+"\"]");
		var rows=main_html.find(selectors.join(","));

		rows.each(function(){

			var target=$(this);
			var data_id=target.attr("data-id");
			var data=order[data_id];
			var count=data["data"]["count"];
			target.find("input").val(count);
			target.find("select[data-type=\"select-cash\"]").val(data["cash"]["id"]);
		});

		return deferred.resolve(tpl,main_html,information,menus,order,prices,cash_types);
	}

	var setEvents=function(tpl,main_html,information,menus,order,prices,cash_types){

		var deferred=$.Deferred();
		var data_menu_row=main_html.find("tr[data-type=\"data-menu-row\"]");
		var data_select_row=main_html.find("tr[data-type=\"data-select-row\"]");
		var input_menu_rows=data_menu_row.find("input[type=number]");
		var input_select_rows=data_select_row.find("input[type=number]");
		var select_row=main_html.find("div[id=\"selected_food\"]");
		var select_cash_types=main_html.find("select[data-type=\"select-cash\"]");

		select_cash_types.on("change",function(e){
		
			var target=$(e.target);
			var fn=arguments.callee;

			var target_tbody=main_html.find("div[id=\"selected_food\"]").find("tbody[data-type=\"data-tbody\"]");
			var data_row=target.parents("tr[data-type=\"data-menu-row\"]");
			var parent_row=data_row.parents("div[data-type=\"food-menu-list\"]");
			var aliase=parent_row.attr("data-aliase-type");
			var master_id=data_row.attr("data-master-id");
			var count=data_row.find("input[type=number]").val();

			var counter_index=data_row.attr("data-id");
			var current_selected_elem=target_tbody.find("tr[data-aliase-type=\""+aliase+"\"][data-master-id=\""+master_id+"\"]");
			var cash_type_id=$(this).val();

			switch(true){
			
				case(1>count):

					if(1>current_selected_elem.size()) return;
					current_selected_elem.remove();
					return;
					break;

				default:

					if(current_selected_elem.size()>0){
					
						current_selected_elem.find("input").val(count);
						current_selected_elem.find("div[data-type=\"select-cash\"]").text(cash_types[cash_type_id]);
						return;
					}
					
					var category_aliase=target.parents("div[data-type=\"food-menu-list\"]").attr("data-aliase-type");
					var menu_info=information[category_aliase][counter_index];

					var this_order={};
					this_order[category_aliase]={};
					this_order[category_aliase][master_id]={"menu":{},"category":{},"data":{},"cash":{}};
					this_order[category_aliase][master_id]["menu"]["menu_id"]=counter_index;
					this_order[category_aliase][master_id]["menu"]["name"]   =menu_info["name"];
					this_order[category_aliase][master_id]["menu"]["remarks"]=(menu_info["remarks"].length>0?menu_info["remarks"]:"&nbsp;");
					this_order[category_aliase][master_id]["data"]["count"]  =count;
					this_order[category_aliase][master_id]["category"]["aliase"]=category_aliase;
					this_order[category_aliase][master_id]["cash"]["card_type"]=cash_types[cash_type_id];
	
					var row_fragment=getOrderFragment(tpl,this_order,prices,information);
					var target=main_html.find("div[id=\"selected_food\"]");
					var target_tbody=target.find("tbody[data-type=\"data-tbody\"]");
					target_tbody.append(row_fragment);
					break;
			}

		});

		input_menu_rows.on("change",function(e){
		
			var target=$(e.target);
			var fn=arguments.callee;

			var target_tbody=main_html.find("div[id=\"selected_food\"]").find("tbody[data-type=\"data-tbody\"]");
			var data_row=target.parents("tr[data-type=\"data-menu-row\"]");
			var parent_row=data_row.parents("div[data-type=\"food-menu-list\"]");
			var aliase=parent_row.attr("data-aliase-type");

			var count=target.val();
			var counter_index=data_row.attr("data-id");
			var master_id=data_row.attr("data-master-id");
			var current_selected_elem=target_tbody.find("tr[data-aliase-type=\""+aliase+"\"][data-master-id=\""+master_id+"\"]");
			var cash_type_select=data_row.find("select[data-type=\"select-cash\"]");
			var cash_type_id=cash_type_select.val();

			switch(true){
			
			case(1>count):

				if(1>current_selected_elem.size()) return;
				current_selected_elem.remove();
				return;
				break;

			default:

				if(current_selected_elem.size()>0){
				
					current_selected_elem.find("input").val(count);
					current_selected_elem.find("div[data-type=\"select-cash\"]").text(cash_types[cash_type_id]);
					return;
				}
				
				var category_aliase=target.parents("div[data-type=\"food-menu-list\"]").attr("data-aliase-type");
				var menu_info=information[category_aliase][counter_index];

				var this_order={};
				this_order[category_aliase]={};
				this_order[category_aliase][master_id]={"menu":{},"category":{},"data":{},"cash":{}};
				this_order[category_aliase][master_id]["menu"]["menu_id"]=counter_index;
				this_order[category_aliase][master_id]["menu"]["name"]   =menu_info["name"];
				this_order[category_aliase][master_id]["menu"]["remarks"]=(menu_info["remarks"].length>0?menu_info["remarks"]:"&nbsp;");
				this_order[category_aliase][master_id]["data"]["count"]  =count;
				this_order[category_aliase][master_id]["category"]["aliase"]=category_aliase;
				this_order[category_aliase][master_id]["cash"]["card_type"]=cash_types[cash_type_id];
	
				var row_fragment=getOrderFragment(tpl,this_order,prices,information);
				var target=main_html.find("div[id=\"selected_food\"]");
				var target_tbody=target.find("tbody[data-type=\"data-tbody\"]");
				target_tbody.append(row_fragment);
				break;
			}
		});

		return deferred.resolve(tpl,main_html,information);
	}

	setFoodTemplates().
	then(getInformations).
	then(setLayout).
	then(setOrder).
	then(setSelectedMenu).
	then(viewFoodRemodal).
	then(setEvents).
	done(function(){
	
	}).
	fail(function(res){ alert(res["message"]); });
}

var mealSetting=function(reservation_hash){

	var params={};
	var target=this;
	params["yes"]=function(){};
	params["no"]   =params["yes"];
	params["close"]=params["yes"];
	params["select-food"]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("フードメニュー"); ?>";
		itemCharge.call(target,reservation_hash,main_title,"<?php echo K9MasterFood::$CATEGORY_FOOD; ?>");
	}

	params["select-drink"]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("ドリンクメニュー"); ?>";
		itemCharge.call(target,reservation_hash,main_title,"<?php echo K9MasterBeverage::$CATEGORY_DRINK; ?>");
	}

	params["select-tobacco"]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("タバコ"); ?>";
		itemCharge.call(target,reservation_hash,main_title,"<?php echo K9MasterTobacco::$CATEGORY_TOBACCO; ?>");
	}

	params["select-roomservice"]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("ルームサービス"); ?>";
		itemCharge.call(target,reservation_hash,main_title,"<?php echo K9MasterRoomservice::$CATEGORY_ROOMSERVICE; ?>");
	}

	params["select-spa"]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("SPA"); ?>";
		itemCharge.call(target,reservation_hash,main_title,"<?php echo K9MasterSpa::$CATEGORY_SPA; ?>");
	}

	params["select-limousine"]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("送迎"); ?>";
		itemCharge.call(target,reservation_hash,main_title,"<?php echo K9MasterLimousine::$CATEGORY_LIMOUSINE; ?>");
	}

	params["select-laundry"]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("洗濯"); ?>";
		itemCharge.call(target,reservation_hash,main_title,"<?php echo K9MasterLaundry::$CATEGORY_LAUNDRY; ?>");
	}

	params["select-reststay"]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("休憩"); ?>";
		itemCharge.call(target,reservation_hash,main_title,"<?php echo K9MasterReststay::$CATEGORY_RESTSTAY; ?>");
	}

	var instance=TPL.getInstance(["remodal_meal_select"]);
	var main_tpl=instance.get_remodal_meal_select;
	var main_title="<?php echo __("注文関連"); ?>";
	var message=$(main_tpl);
	remodalAlert("normal_600",main_title,message,params);
}

var viewPurchaseSearchButton=function(reserve_id,is_html_view,is_search_on){

	var instance=TPL.getInstance(["reservation_search_view","reservation_search_unview"]);
	var target=window["action_lastmodified"].find("a[data-type=\"reservation-search-button\"]");
	target[(!is_html_view?"hide":"show")]();
	var span=target.children("span");

	if(reserve_id==undefined && span.size()>0){

		reserve_id=span.attr("data-reservation-id");
		if(!reserve_id) throw new Exception("no reservation id.");
	}

	var view_tpl=instance.replaceTPL(instance[!is_search_on?"get_reservation_search_unview":"get_reservation_search_view"],{
	
		"reserve_id":reserve_id
	});

	var view_html=$(view_tpl);
	target.empty().append(view_html);
}

var invoiceDiposit=function(reservation_hash){

	var getInvoice=function(){
	
		var deferred=$.Deferred();

		var params={}
		params["reservation_hash"]=reservation_hash;
		apiGeoRequests.invoiceDiposit(params,function(status,res){
		
			if(!status) return deferred.reject(res);
			var data=res["data"];
			return deferred.resolve(data);
		});

		return deferred.promise();
	}

	getInvoice().
	done(function(data){
	
		location.href=data["url"];

	}).
	fail(function(res){ alert(res["message"]); });
}

var invoiceRecode=function(reservation_hash){

	var getInvoice=function(){
	
		var deferred=$.Deferred();

		var params={}
		params["reservation_hash"]=reservation_hash;
		apiGeoRequests.invoiceItem(params,function(status,res){
		
			if(!status) return deferred.reject(res);
			var data=res["data"];
			return deferred.resolve(data);
		});

		return deferred.promise();
	}

	getInvoice().
	done(function(data){
	
		location.href=data["url"];

	}).
	fail(function(res){ alert(res["message"]); });
}

var viewCheckinRemodal=function(reserve_id,reservation_hash,callback){

	var schedule_site_box=this;

	viewCheckin({
	
		"yes":function(e){

			var remodal=this;
			var checkin=function(){
			
				var deferred=$.Deferred();

				var params={}
				params["id"]=reserve_id;
				params["hash"]=reservation_hash;
				apiGeoRequests.checkin(params,function(status,res){
				
					if(!status) return deferred.reject(res);
					var data=res["data"];
					deferred.resolve(data);
				});

				return deferred.promise();
			}

			checkin(reserve_id).
			done(function(data){

				alert("<?php echo __("チェックインが完了しました"); ?>");
				if(!$.isFunction(callback)) return;
				callback(true);
			}).
			fail(function(res){ callback(false,res["message"]); });

		},
		"no" :function(e){
			
			var remodal=this;
			remodal.close();
		},
	});
}

var viewCheckoutRemodal=function(reserve_id,reservation_hash,callback){

	var schedule_site_box=this;

	viewCheckout({
	
		"yes":function(e){

			var remodal=this;
			var checkout=function(){
			
				var deferred=$.Deferred();

				var params={}
				params["id"]=reserve_id;
				params["hash"]=reservation_hash;
				apiGeoRequests.checkout(params,function(status,res){
				
					if(!status) return deferred.reject(res);
					var data=res["data"];
					deferred.resolve(data);
				});

				return deferred.promise();
			}

			checkout(reserve_id).
			done(function(data){

				alert("<?php echo __("チェックアウトが完了しました"); ?>");
				if(!$.isFunction(callback)) return;
				callback(true,data);
			}).
			fail(function(res){ callback(false,res["message"]); });
		},
		"no" :function(e){
			
			var remodal=this;
			remodal.close();
			callback();
		},
	});
}

var actionActionStart=function(user_id,callback){

	var action_button=this;
	actionStart.call(action_button,user_id,function(status,errorNo,error){

		switch(status){

			case(true):

			cacheData().set(MANAGED_AUTHORITY,{"is_managed":status});
			bodyColor(1);
			callback();

		break;
			default:

			var action_button=window["schedule_action_button"];
			addActionButton.call(action_button,0,function(save_button){

				if(errorNo==undefined){

					alert('<?php echo __("通信状況が安定しておりません"); ?>');
					reloadUnbindUnload();
					return;
				}

				alert(error["message"]);

				switch(parseInt(errorNo)){
				
				case(0):
					callback();
					break;
				case(2):
					reloadUnbindUnload();
					break;
				default:
					callback();
					break;
				}
			});

		break;
		}
	});
}

var actionStart=function(user_id,callback){

	var action_button=this;

	if(!is_edit){

		callback(false,1,{

			"message":"<?php echo __("編集する権限がありません"); ?>",
		});
		return;
	}

	var params={};
	params["user_id"]=user_id;
	params["last_edit_time"]=cacheData().get(CACHE_LAST_EDIT_TIME).last_edit_time;
	params["local_time_key"]=localKeyTime(LOCAL_STORAGE_TIMEKEY);
	apiGeoRequests.editStart(params,function(status,res){

		if(!status && res["type"]==0){

			callback(false);
			return;
		}

		if(!status && res["type"]==1){

			callback(false,res["errorNo"],{

				"title"  :res["title"],
				"message":res["message"]
			});
			return;
		}

		var time_key=res["time_key"];
		var current_time_ms=res["last_modified_ms"];
		var last_edit_time=res["last_edit_time"];
		addActionButton.call(action_button,1,function(save_button){

			localKeyTime(LOCAL_STORAGE_TIMEKEY,time_key);
			cacheData().set(MANAGED_LIMITED_TIMER,{"timer":current_time_ms});
			cacheData().set(CACHE_LAST_EDIT_TIME,{ "last_edit_time":last_edit_time });
			callback(true);
		});
	});
}

var actionActionInitSave=function(user_id,callback){

	var params={};
	params["user_id"]=user_id;
	params["last_edit_time"]=cacheData().get(CACHE_LAST_EDIT_TIME).last_edit_time;
	params["local_time_key"]=localKeyTime(LOCAL_STORAGE_TIMEKEY);
	apiGeoRequests.initScheduleLog(params,function(status,res){

		if(!status && res["type"]==0){

			alert('<?php echo __("通信状況が安定しておりません"); ?>');
			reloadUnbindUnload();
			return;
		}

		if(!status && res["type"]==1){

			var main_title=res["title"];
			var message=res["message"];
			remodalAlert("modal",main_title,message,{

				"yes"  :function(){ reloadUnbindUnload(); },
				"no"   :function(){ reloadUnbindUnload(); },
				"close":function(){ reloadUnbindUnload(); }
			});
			return;
		}

		var action_button=window["schedule_action_button"];
		addActionButton.call(action_button,0,function(start_button){

			var time_key=res["time_key"];
			var last_edit_time=res["last_edit_time"];
			localKeyTime(LOCAL_STORAGE_TIMEKEY,time_key);
			cacheData().set(CACHE_LAST_EDIT_TIME,{ "last_edit_time":last_edit_time });
			cacheData().set(MANAGED_AUTHORITY,{"is_managed":false});
			bodyColor(0);
			callback();
		});
	});
}

var actionActionSave=function(callback){

	saveAction(true,function(status,errorNo,error){
		
		$(window).off("beforeunload");

		if(!status && error==undefined){

			alert('<?php echo __("通信状況が安定しておりません"); ?>');
			callback();
			return;
		}

		if(!status && errorNo!=undefined){

			var __action=function(){

				if([2,3,6].indexOf(parseInt(errorNo))>-1){

					reloadUnbindUnload();
					return;
				}
			}

			var main_title="<?php echo __("エラー"); ?>";
			var message   ="<?php echo __("登録処理に失敗しました"); ?>";
			remodalAlert("modal",main_title,message,{

				"yes"  :function(){ __action(); },
				"no"   :function(){ __action(); },
				"close":function(){ __action(); }
			});
			return;
		}

		var message="<?php echo __("予約情報の登録、及び編集が完了しました"); ?>";
		alert(message);

		var action_button=window["schedule_action_button"];
		addActionButton.call(action_button,0,function(start_button){

			cacheData().set(MANAGED_AUTHORITY,{"is_managed":false});
			bodyColor(0);
			callback();
		});
	});
}

var roomOpacityEnable=function(schedules,room_id){

	var is_add=(room_id!=undefined);
	if(is_add) schedules=schedules.filter(":not([data-room-id=\""+room_id+"\"])");
	schedules[(is_add?"addClass":"removeClass")]("workerEnableOpacity");
}

var reservationOpacityEnable=function(schedules,reserve_id){

	var is_add=(reserve_id!=undefined);
	if(is_add) schedules=schedules.filter(":not([data-reservation-id=\""+reserve_id+"\"])");
	schedules[(is_add?"addClass":"removeClass")]("workerEnableOpacity");
}

var purchaseOpacityEnable=function(schedules,purchase_flg){

	var is_add=(purchase_flg==undefined)?false:true;
	if(is_add) schedules=schedules.filter(":not([data-purchase-flg=\""+purchase_flg+"\"])");
	schedules[(is_add?"addClass":"removeClass")]("workerEnableOpacity");
}

var roomTypeOpacityEnable=function(schedules,room_type_id){

	var is_add=(room_type_id!=undefined);
	if(is_add) schedules=schedules.filter(":not([data-room-type-id=\""+room_type_id+"\"])");
	schedules[(is_add?"addClass":"removeClass")]("workerEnableOpacity");
}

var allCancelSearchButtons=function(is_purchase){

	var parent=this;
	var instance=TPL.getInstance(["purchase_search_view",
								  "purchase_search_unview"]);

	var cancel_purchase_tpl=instance.get_purchase_search_unview;
	var purchase_tpl=instance.get_purchase_search_view;
	var __purchase_search=parent.children("[data-button-type=\"purchase-search-button\"]");

	switch(is_purchase==undefined){
	
		case(true):

			if(__purchase_search.is("div[data-type=\"purchase-search-cancel\"]")) __purchase_search.replaceWith($(purchase_tpl));
			break;

		case(false):

			if(__purchase_search.is("a[data-type=\"purchase-search\"]")) __purchase_search.replaceWith($(cancel_purchase_tpl));
			break;
	}

	cacheData().get(CACHE_SEARCH_ACTION)["is_purchase"]=(is_purchase==undefined)?0:is_purchase;
}

var addScheduleRoomLi=function(rooms,callback){

	var ul=this;
	var fn=arguments.callee;
	var instance=TPL.getInstance("schedule_memo_li");
	var li_tpl=instance.get_schedule_memo_li;
	var fragment=document.createDocumentFragment();

	var li_html;
	for(var room_id in rooms){
	
		li_html=$(instance.replaceTPL(li_tpl,{
		
			"room_id" :room_id,
			"room_num":rooms[room_id]["room_num"]
		}));

		fragment.appendChild(li_html.get(0));
	}

	ul.append(fragment);
	if($.isFunction(callback)) callback();
}

var viewYmd=function(year,month,day){

	var format={};

	<?php if(Configure::read('Config.language')=="eng"){ ?>

		format[1]="<?php echo __("1月"); ?>";
		format[2]="<?php echo __("2月"); ?>";
		format[3]="<?php echo __("3月"); ?>";
		format[4]="<?php echo __("4月"); ?>";
		format[5]="<?php echo __("5月"); ?>";
		format[6]="<?php echo __("6月"); ?>";
		format[7]="<?php echo __("7月"); ?>";
		format[8]="<?php echo __("8月"); ?>";
		format[9]="<?php echo __("9月"); ?>";
		format[10]="<?php echo __("10月"); ?>";
		format[11]="<?php echo __("11月"); ?>";
		format[12]="<?php echo __("12月"); ?>";

	<?php } ?>

    var instance=TPL.getInstance([]);

	year=parseInt(year);
	month=parseInt(month);
	day=parseInt(day);

	var tpl_jpn="<<month>>/<<day>>";
	var tpl_eng="<<day>>/<<month>>";
	var is_jp=parseInt("<?php echo Configure::read('Config.language')=="jpn"?1:0; ?>")==1;

	if(!!year && !is_jp) tpl_eng+="/<<year>>";
	if(!!year && is_jp)  tpl_jpn=("<<year>>/"+tpl_jpn);
	var tpl=is_jp?tpl_jpn:tpl_eng;

	var view_year =year;
	var view_month=(format[month]==undefined?month:format[month]);
	var view_day  =day;
	return instance.replaceTPL(tpl,{
	
		"year" :view_year,
		"month":view_month,
		"day"  :view_day
	});
}

var priceMasterSetting=function(type){

	var params={};
	params["yes"]=function(){};
	params["no"]   =params["yes"];
	params["close"]=params["yes"];
	params["master-room-"+type]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("部屋"); ?>";

		switch(type){
		
		case("price"):

			masterPriceChage(main_title,"<?php echo K9MasterRoom::$CATEGORY_ROOM; ?>");
			break;

		case("item"):

			masterItemChange(main_title,"<?php echo K9MasterRoom::$CATEGORY_ROOM; ?>");
			break;
		}
	}

	params["master-roomtype-"+type]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("部屋タイプ"); ?>";

		switch(type){
		
		case("price"):

			masterPriceChage(main_title,"<?php echo K9MasterRoomType::$CATEGORY_ROOMTYPE; ?>");
			break;

		case("item"):

			masterItemChange(main_title,"<?php echo K9MasterRoomType::$CATEGORY_ROOMTYPE; ?>");
			break;
		}
	}

	params["master-food-"+type]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("フード"); ?>";

		switch(type){
		
		case("price"):

			masterPriceChage(main_title,"<?php echo K9MasterFood::$CATEGORY_FOOD; ?>");
			break;

		case("item"):

			masterItemChange(main_title,"<?php echo K9MasterFood::$CATEGORY_FOOD ?>");
			break;
		}
	}

	params["master-drink-"+type]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("ドリンク"); ?>";

		switch(type){
		
		case("price"):

			masterPriceChage(main_title,"<?php echo K9MasterBeverage::$CATEGORY_DRINK; ?>");
			break;

		case("item"):

			masterItemChange(main_title,"<?php echo K9MasterBeverage::$CATEGORY_DRINK; ?>");
			break;
		}
	}

	params["master-tobacco-"+type]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("タバコ"); ?>";

		switch(type){
		
		case("price"):

			masterPriceChage(main_title,"<?php echo K9MasterTobacco::$CATEGORY_TOBACCO; ?>");
			break;

		case("item"):

			masterItemChange(main_title,"<?php echo K9MasterTobacco::$CATEGORY_TOBACCO; ?>");
			break;
		}
	}

	params["master-roomservice-"+type]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("ルームサービス"); ?>";

		switch(type){
		
		case("price"):

			masterPriceChage(main_title,"<?php echo K9MasterRoomservice::$CATEGORY_ROOMSERVICE; ?>");
			break;

		case("item"):

			masterItemChange(main_title,"<?php echo K9MasterRoomservice::$CATEGORY_ROOMSERVICE; ?>");
			break;
		}
	}

	params["master-spa-"+type]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("SPA"); ?>";

		switch(type){
		
		case("price"):

			masterPriceChage(main_title,"<?php echo K9MasterSpa::$CATEGORY_SPA; ?>");
			break;

		case("item"):

			masterItemChange(main_title,"<?php echo K9MasterSpa::$CATEGORY_SPA; ?>");
			break;
		}
	}

	params["master-laundry-"+type]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("洗濯"); ?>";

		switch(type){
		
		case("price"):

			masterPriceChage(main_title,"<?php echo K9MasterLaundry::$CATEGORY_LAUNDRY; ?>");
			break;

		case("item"):

			masterItemChange(main_title,"<?php echo K9MasterLaundry::$CATEGORY_LAUNDRY; ?>");
			break;
		}
	}

	params["master-limousine-"+type]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("送迎"); ?>";

		switch(type){
		
		case("price"):

			masterPriceChage(main_title,"<?php echo K9MasterLimousine::$CATEGORY_LIMOUSINE; ?>");
			break;

		case("item"):

			masterItemChange(main_title,"<?php echo K9MasterLimousine::$CATEGORY_LIMOUSINE; ?>");
			break;
		}
	}

	params["master-reststay-"+type]=function(e,status){

		if(status=="start") return;
		var main_title="<?php echo __("休憩"); ?>";

		switch(type){
		
		case("price"):

			masterPriceChage(main_title,"<?php echo K9MasterReststay::$CATEGORY_RESTSTAY; ?>");
			break;

		case("item"):

			masterItemChange(main_title,"<?php echo K9MasterReststay::$CATEGORY_RESTSTAY; ?>");
			break;
		}
	}

	var instance=TPL.getInstance(["remodal_masterprice_type_select"]);
	var main_tpl=instance.replaceTPL(instance.get_remodal_masterprice_type_select,{ "type":type });
	var message=$(main_tpl);

	switch(type){
	
	case("price"):

		var main_title="<?php echo __("標準金額設定"); ?>";
		break;

	case("item"):

		var main_title="<?php echo __("各種項目設定"); ?>";
		break;
	}

	remodalAlert("normal_600",main_title,message,params);
}

var masterPriceChage=function(main_title,menu_type){

	var allow_types=[

		"<?php echo K9MasterRoomType::$CATEGORY_ROOMTYPE; ?>",
		"<?php echo K9MasterRoom::$CATEGORY_ROOM; ?>",
		"<?php echo K9MasterFood::$CATEGORY_FOOD; ?>",
		"<?php echo K9MasterBeverage::$CATEGORY_DRINK; ?>",
		"<?php echo K9MasterSpa::$CATEGORY_SPA; ?>",
		"<?php echo K9MasterRoomservice::$CATEGORY_ROOMSERVICE; ?>",
		"<?php echo K9MasterTobacco::$CATEGORY_TOBACCO; ?>",
		"<?php echo K9MasterLimousine::$CATEGORY_LIMOUSINE; ?>",
		"<?php echo K9MasterLaundry::$CATEGORY_LAUNDRY; ?>",
		"<?php echo K9MasterReststay::$CATEGORY_RESTSTAY; ?>",
	];

	if(0>allow_types.indexOf(menu_type)) alert("miss menu type.");

	var setFoodTemplates=function(){
		
		var deferred=$.Deferred();
		var instance=TPL.getInstance(["list_main_mastermenus",
			                          "master_price_menu_noitem_row",
			                          "select_menu_row",
			                          "master_price_menu_row",
			                          "menu_list",
			                          "menu_tab_list"]);

		return deferred.resolve(instance);
	}

	var getInformations=function(tpl){

		var deferred=$.Deferred();

		var params={};
		params["type"]=menu_type;
		apiGeoRequests.getMasterData(params,function(status,res){

			if(!status) return deferred.reject(res);
			var informations=res["data"];
			var menus=informations["list"]["menus"];
			var information=informations["list"]["list"];
			var prices=informations["price"]["data"];
			deferred.resolve(tpl,information,menus,prices);
		});

		return deferred.promise();
	}

	var setMenuTabFragment=function(tpl,menus){

		var category;
		var aliase;
		var menu_tab_html;
		var menu_tab_tpl=tpl.get_menu_tab_list;
		var tab_fragment=document.createDocumentFragment();
		for(var aliase in menus){

			menu=menus[aliase];
			menu_tab_html=$(tpl.replaceTPL(menu_tab_tpl,{
			
				"category_aliase":aliase,
				"name":menu
			}));

			tab_fragment.appendChild(menu_tab_html.get(0));
		}

		return tab_fragment;
	}

	var setDataTabFragment=function(tpl,aliases,menus,information,prices,fragment){
	
		if(1>aliases.length) return fragment;

		var fn=arguments.callee;
		var aliase=aliases.shift();
		var category=menus[aliase];
		var data_tab_tpl=tpl.get_menu_list;
		var data_row_tpl=tpl.get_master_price_menu_row;
		var data_row_nonitem_tmp=tpl.get_master_price_menu_noitem_row;

		var use_tpl=["<?php echo K9MasterRoomType::$CATEGORY_ROOMTYPE; ?>",
			         "<?php echo K9MasterRoom::$CATEGORY_ROOM; ?>",
			         "<?php echo K9MasterReststay::$CATEGORY_RESTSTAY; ?>"].indexOf(menu_type)>-1?data_row_nonitem_tmp:data_row_tpl;


		var data_tab_html=$(tpl.replaceTPL(data_tab_tpl,{
		
			"category_aliase":aliase,
			"category":category
		}));

		fragment=(fragment==undefined)?document.createDocumentFragment():fragment;

		var row_fragment=document.createDocumentFragment();
		var data_tbody=data_tab_html.find("tbody[data-type=\"data-tbody\"]");
		var category_information=information[aliase];
		var data_row_html;
		var remarks;
		var is_remarks_enable;
		var master_id;

		for(var meal_id in category_information){

			master_id=category_information[meal_id]["id"];
			is_remarks_enable=prices[master_id]["data"]["remarks"].length>0;
			remarks=(is_remarks_enable?prices[master_id]["data"]["remarks"]:"&nbsp;");
			data_row_html=$(tpl.replaceTPL(use_tpl,{
			
				"meal_id" :meal_id,
				"title"   :category_information[meal_id]["name"],
				"item_num":category_information[meal_id]["item_num"],
				"price"   :prices[master_id]["data"]["price"],
				"staff"   :prices[master_id]["employee"]["name"],
				"aliase"  :aliase
			}));

			data_row_html.find("input[type=text][data-type=\"menu-remarks\"]").val(is_remarks_enable?remarks:"");
			row_fragment.appendChild(data_row_html.get(0));
		}

		data_tbody.append(row_fragment);
		fragment.appendChild(data_tab_html.get(0));
		return fn(tpl,aliases,menus,information,prices,fragment);
	}

	var setLayout=function(tpl,information,menus,prices){

		var deferred=$.Deferred();
		var main_tpl=tpl.get_list_main_mastermenus;
		var main_html=$(main_tpl);
		var menu_list=main_html.find("div[data-type=\"menu-list\"]");
		var menu_tab_list=main_html.find("ul[data-type=\"menu-tab-list\"]");
		var main_fragment=document.createDocumentFragment();
		var tab_fragment=document.createDocumentFragment();
		var tab_fragment=setMenuTabFragment(tpl,menus);
		menu_tab_list.append(tab_fragment);
		var aliases=Object.keys(menus);
		var data_fragment=setDataTabFragment(tpl,aliases,menus,information,prices);
		menu_list.append(data_fragment);

		return deferred.resolve(tpl,main_html,information,prices);
	}

	var getSelectedValueForEditNeeded=function(information,prices){

		var main_html=this;
		var edit_values={}; 
		var data_rows=main_html.find("tr[data-type=\"data-menu-row\"]");
		data_rows.each(function(){
		
			var target=$(this);
			var aliase=target.attr("data-aliase-type");
			var counter_index=target.attr("data-id");
			var price_input=target.find("input[type=number][data-type=\"menu-baseprice\"]");
			var remark_input=target.find("input[type=text][data-type=\"menu-remarks\"]");
			var price=price_input.val().trim();
			var remarks=remark_input.val().trim();
			var master_id=information[aliase][counter_index]["id"];

			var is_edit=false;
			if(prices[master_id]["data"]["remarks"]!=remarks) is_edit=true;

			var origin_price=Math.max(prices[master_id]["data"]["price"],0);
			price=((1>price.length)?origin_price:Math.max(price,0));
			var origin_price=Math.max(prices[master_id]["data"]["price"],0);

			if(!is_edit && (price!=origin_price)) is_edit=true;
			if(!is_edit) return;

			edit_values[master_id]={};
			edit_values[master_id]["data_id"]=counter_index;
			edit_values[master_id]["price"]  =price;
			edit_values[master_id]["remarks"]=remarks;
			edit_values[master_id]["aliase"] =aliase;
		});

		return edit_values;
	}

	var viewFoodRemodal=function(tpl,main_html,information,prices){

		var deferred=$.Deferred();

		var message=main_html;

		var params={};
		params["yes"]=function(){};
		params["no"]=function(){};
		params["close"]=function(){};
		params["select_menu_row_a"]=function(e,type){
		
			if(type=="start") return;
			var target=$(e.target);
			var counter_index=target.parents("tr[data-type=\"data-select-row\"]").attr("data-id");
			var row=main_html.find("tr[data-type=\"data-menu-row\"][data-id=\""+counter_index+"\"]");
			var input=row.find("input");
			var menu_tab_list=main_html.find("ul[data-type=\"menu-tab-list\"]");
			var tab_lis=menu_tab_list.children("li");
			tab_lis.removeClass("active");
			var category_aliase=row.parents("div[data-type=\"food-menu-list\"]").attr("data-aliase-type");
			var target_tab_li=tab_lis.filter("[data-aliase-type=\""+category_aliase+"\"]");
			target_tab_li.addClass("active");

			var focus=function(){

				var input=this;
				var fn=arguments.callee;
				setTimeout(function(){

					if(input.is(":visible")) return input.focus();
					fn.call(input);

				},100);

			}.bind(input);

			focus();
		};

		params["other-item"]=function(e,type){

			if(type=="start") return;

			var remodal=this;
			var edit_values=getSelectedValueForEditNeeded.call(main_html,information,prices);
			if(Object.keys(edit_values).length>0){

				var res=window.confirm("<?php echo __("変更された情報は保存されませんが宜しいですか？"); ?>");
				if(!res) return;
			}

			prices=null;

			remodal.close(null,function(){

				priceMasterSetting("price");
			});
			return;
		}

		params["order-save"]=function(e,type){
		
			if(type=="start") return;

			var edit_values=getSelectedValueForEditNeeded.call(main_html,information,prices);
			if(1>Object.keys(edit_values).length){
			
				alert("<?php echo __('変更されたメニューは存在しません'); ?>");
				return;
			}

			var params={};
			params["order"]=edit_values;
			params["type"] =menu_type;
			apiGeoRequests.masterPriceSubscribe(params,function(status,res){

				if(!status){
				
					alert(res["message"]);
					return;
				}

				//update current order histories.
				var selectors=[];
				var category_aliase;
				var data_id;
				for(var master_id in edit_values){

					//edit for original data.
					prices[master_id]["data"]["price"]  =(edit_values[master_id]["price"]+"");
					prices[master_id]["data"]["remarks"]=edit_values[master_id]["remarks"];

					data_id=edit_values[master_id]["data_id"];
					category_aliase=edit_values[master_id]["aliase"];
					selectors.push("[data-id=\""+data_id+"\"]");
				}

				var data_rows=main_html.find("tr[data-type=\"data-menu-row\"]").filter(selectors.join(","));
				data_rows.css("background-color","#fff");
				alert("<?php echo __('設定した内容が正常に登録されました'); ?>");
			});
		}

		remodalAlert("normal_1200",main_title,message,params);

		return deferred.resolve(tpl,main_html,information,prices);
	}

	var setSelectedMenu=function(tpl,main_html,information,prices){
	
		var deferred=$.Deferred();

		var ids;
		var rows;
		var selectors=[];
		for(var aliase in information){

			ids=Object.keys(information[aliase]);
			for(var i in ids) selectors.push("tr[data-type=\"data-menu-row\"][data-aliase-type=\""+aliase+"\"][data-id=\""+ids[i]+"\"]");

			var rows=main_html.find(selectors.join(","));
			rows.each(function(){

				var target=$(this);
				var data_id=target.attr("data-id");
				var aliase=target.attr("data-aliase-type");
				var master_id=information[aliase][data_id]["id"];
				var price=prices[master_id]["data"]["price"];
				target.find("input[type=number]").val(price);
			});
		}

		return deferred.resolve(tpl,main_html,information,prices);
	}

	var setEvents=function(tpl,main_html,information,prices){

		var deferred=$.Deferred();
		var data_menu_row=main_html.find("tr[data-type=\"data-menu-row\"]");
		var data_select_row=main_html.find("tr[data-type=\"data-select-row\"]");
		var input_menu_rows=data_menu_row.find("input[type=number]");
		var input_select_rows=data_select_row.find("input[type=number]");

		input_menu_rows.on("change",function(e){
		
			var target=$(e.target);
			var fn=arguments.callee;
			var data_row=target.parents("tr[data-type=\"data-menu-row\"]");
			var aliase=data_row.attr("data-aliase-type");
			var data_id=data_row.attr("data-id");
			var master_id=information[aliase][data_id]["id"];
			var price=target.val();
			var prev_price=prices[master_id]["price"];
			var is_same_price=(price==prev_price);
			data_row.css("background-color",(is_same_price?"#fff":"red"));
		});

		return deferred.resolve(tpl,main_html,information);
	}

	var viewFirstCategory=function(tpl,main_html,information,prices){
		
		var deferred=$.Deferred();
		var first_li=main_html.find("ul[data-type=\"menu-tab-list\"]").children("li").eq(0);
		var aliase=first_li.attr("data-aliase-type");
		first_li.addClass("active");
		return deferred.resolve(tpl,main_html,information,prices,aliase);
	}

	var viewFirstMenu=function(tpl,main_html,information,prices,aliase){

		var deferred=$.Deferred();
		var menu_list=main_html.find("div[data-type=\"menu-list\"]");
		var target_list=menu_list.find("div[id=\""+aliase+"\"]");
		target_list.addClass("in active");
		return deferred.resolve(tpl,main_html,information,prices);
	}

	setFoodTemplates().
	then(getInformations).
	then(setLayout).
	then(setSelectedMenu).
	then(viewFoodRemodal).
	then(viewFirstCategory).
	then(viewFirstMenu).
	then(setEvents).
	done(function(){
	
	}).
	fail(function(res){ alert(res["message"]); });
}

var agentSetting=function(){

	var params={};
	params["yes"]=function(){};
	params["no"]   =params["yes"];
	params["close"]=params["yes"];
	
	params["agent-add"]=function(e,type){
	
		if(type=="start") return;
		addAgent();
	};

	params["agent-list"]=function(e,type){
	
		if(type=="start") return;
		agentList();
	};

	var instance=TPL.getInstance(["remodal_agent"]);
	var main_tpl=instance.get_remodal_agent;
	var main_title="<?php echo __("各種項目設定"); ?>";
	var message=$(main_tpl);
	remodalAlert("normal_600",main_title,message,params);
}

var addAgent=function(agent_id,agency_type_id){

	var mainView=function(information,menus){
	
		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_agent_add"]);
		var main_html=$(instance.get_remodal_agent_add);
		return deferred.resolve(main_html,information,menus);
	}

	var getElements=function(){ this.elements={}; }
	getElements.getElements=function(main_html){

		if(!!this["instance"] && this.instance instanceof this){ return this.instance.elements; }

		var agent_companyname   =main_html.find("input[type=text][data-type=\"agent-companyname\"]");
		var agent_contact       =main_html.find("input[type=text][data-type=\"agent-contact\"]");
		var agent_fax           =main_html.find("input[type=text][data-type=\"agent-fax\"]");
		var agent_type          =main_html.find("select[data-type=\"agent-type\"]");
		var agent_salesource    =main_html.find("select[data-type=\"agent-salesource\"]");
		var agent_credit_limited=main_html.find("input[type=text][data-type=\"agent-credit-limited\"]");
		var agent_number_duedate=main_html.find("input[type=text][data-type=\"agent-number-duedate\"]");
		var agent_registdate    =main_html.find("input[type=text][data-type=\"agent-registdate\"]");
		var agent_vatno         =main_html.find("input[type=text][data-type=\"agent-vatno\"]");
		var agent_address       =main_html.find("textarea[data-type=\"agent-address\"]");

		this.instance=new this();
		this.instance.elements["agent_companyname"]=agent_companyname;
		this.instance.elements["agent_contact"]    =agent_contact;
		this.instance.elements["agent_fax"]        =agent_fax;
		this.instance.elements["agent_salesource"] =agent_salesource;
		this.instance.elements["agent_type"]       =agent_type;
		this.instance.elements["agent_credit_limited"]=agent_credit_limited;
		this.instance.elements["agent_number_duedate"]=agent_number_duedate;
		this.instance.elements["agent_registdate"]    =agent_registdate;
		this.instance.elements["agent_vatno"]         =agent_vatno;
		this.instance.elements["agent_address"]       =agent_address;
		return this.instance.elements;
	}

	var getValues=function(){

		var values={};
		var elements=getElements.getElements(this);
		for(var i in elements) values[i]=elements[i].val().trim();
		return values;
	}

	var viewModal=function(main_html,information,menus){

		var deferred=$.Deferred();

		var main_title="<?php echo __("企業情報"); ?>"
		var message=main_html;
		remodalAlert("normal_1000",main_title,message,{
		
			"agent-tolist":function(e,type){
			
				if(type=="start") return;
				var remodal=this;
				remodal.close(null,function(){
	
					agentList(agent_id);
				});
			},
			"agent-save":function(e,type){
			
				if(type=="start") return;

				var is_error=false;
				var values  =getValues.call(main_html);
				var elements=getElements.getElements(main_html);
				if(1>values["agent_companyname"].length){

					is_error=true;
					elements["agent_companyname"].inputError();
				}

				if(is_error) return;

				var params={};
				if(agent_id!=undefined) params["agent_id"]=agent_id;
				params["data"]=values;
				apiGeoRequests.agentSubscribe(params,function(status,res){

					if(!status){
					
						alert(res["message"]);
						return;
					}

					alert("<?php echo __("設定した内容が正常に登録されました"); ?>");
					agent_id=res["data"]["id"];
				});
			},
			"remodal-close":function(e,type){

				if(type=="end") return;
			},
		});

		return deferred.resolve(main_html,information);
	}

	var setCalendar=function(main_html,information,menus){

		var deferred=$.Deferred();
		var calendar=main_html.find("input[type=text][data-type=\"agent-registdate\"]");

		setCalendarForInput.call(calendar,{
		
			"onSelect":function(selectDate){
	
				var calendar=$(this);
				var date_split=dateSplitLocaleSaparator(selectDate);
				var ymd=getYmdWithLocaleSplitdates(date_split);
			}
	
		},{ "minDate":"-12m","maxDate":"+0d" });

		return deferred.resolve(main_html,information,menus);
	}

	var setCalendarDefault=function(main_html,information,menus){

		var deferred=$.Deferred();
		var calendar=main_html.find("input[type=text][data-type=\"agent-registdate\"]");
		calendar.val('<?php echo localDateNormalUtime(time()); ?>');
		return deferred.resolve(main_html,information,menus);
	}

	var setAgents=function(main_html,information,menus){

		var deferred=$.Deferred();
		var agent_type=main_html.find("select[data-type=\"agent-type\"]");
		setMenu.call(agent_type,menus["agents"]);
		return deferred.resolve(main_html,information,menus);
	}

	var setSalesources=function(main_html,information,menus){

		var deferred=$.Deferred();
		var agent_type=main_html.find("select[data-type=\"agent-salesource\"]");
		setMenu.call(agent_type,menus["salesources"]);
		return deferred.resolve(main_html,information);
	}

	var getInformations=function(){

		var deferred=$.Deferred();

		if(agent_id==undefined){

			var params={};
			apiGeoRequests.getAgentMenus(params,function(status,res){

				if(!status) return deferred.reject(res);
				var menus=res["data"];
				deferred.resolve(undefined,menus);
			});
			return deferred.promise();
		}

		var params={};
		if(agent_id!=undefined) params["agent_id"]=agent_id;
		apiGeoRequests.getAgentInformation(params,function(status,res){

			if(!status) return deferred.reject(res);
			var information=res["data"];
			var menus=res["data"]["menu"];
			deferred.resolve(information,menus);
		});

		return deferred.promise();
	}
	
	var setInformations=function(main_html,information){

		var deferred=$.Deferred();
		if(information==undefined || 1>information["data"].length) return deferred.resolve(main_html,information);

		var elements=getElements.getElements(main_html);
		var data=information["data"][agency_type_id][agent_id];
		elements["agent_companyname"].val(data["agency"]["name"]);
		elements["agent_contact"].val(data["agency"]["phone"]);
		elements["agent_fax"].val(data["agency"]["fax"]);
		elements["agent_type"].val(data["agency"]["id"]);
		elements["agent_credit_limited"].val(data["agency"]["credit_limited"]);
		elements["agent_number_duedate"].val(data["agency"]["number_due_date"]);
		elements["agent_registdate"].val(data["agency"]["register_date"]);
		elements["agent_address"].val(data["agency"]["address"]);
		elements["agent_vatno"].val(data["agency"]["vtno"]);
		return deferred.resolve(main_html,information);
	}

	getInformations().
	then(mainView).
	then(setCalendar).
	then(setCalendarDefault).
	then(setAgents).
	then(setSalesources).
	then(setInformations).
	then(viewModal).
	done(function(main_html,information){
	
	}).
	fail(function(){
	
	});
}

var baseBasePriceSetting=function(){

	var params={};
	params["yes"]=function(){};
	params["no"]   =params["yes"];
	params["close"]=params["yes"];
	
	params["select-item"]=function(e,type){
	
		if(type=="start") return;
		priceMasterSetting("item");
	};

	params["select-baseprice"]=function(e,type){
	
		if(type=="start") return;
		priceMasterSetting("price");
	};

	var instance=TPL.getInstance(["remodal_base_price_types"]);
	var main_tpl=instance.get_remodal_base_price_types;
	var main_title="<?php echo __("各種項目設定"); ?>";
	var message=$(main_tpl);
	remodalAlert("normal_600",main_title,message,params);
}

var masterItemChange=function(main_title,menu_type){

	var allow_types=[

		"<?php echo K9MasterFood::$CATEGORY_FOOD; ?>",
		"<?php echo K9MasterBeverage::$CATEGORY_DRINK; ?>",
		"<?php echo K9MasterSpa::$CATEGORY_SPA; ?>",
		"<?php echo K9MasterRoomservice::$CATEGORY_ROOMSERVICE; ?>",
		"<?php echo K9MasterTobacco::$CATEGORY_TOBACCO; ?>",
		"<?php echo K9MasterLimousine::$CATEGORY_LIMOUSINE; ?>",
		"<?php echo K9MasterLaundry::$CATEGORY_LAUNDRY; ?>",
		"<?php echo K9MasterReststay::$CATEGORY_RESTSTAY; ?>",
		"<?php echo K9MasterRoomType::$CATEGORY_ROOMTYPE; ?>",
		"<?php echo K9MasterRoom::$CATEGORY_ROOM; ?>"
	];

	if(0>allow_types.indexOf(menu_type)) alert("miss menu type.");

	var setFoodTemplates=function(){
		
		var deferred=$.Deferred();
		var instance=TPL.getInstance(["list_main_mastermenus",
			                          "select_baseprice_row",
			                          "baseprice_add_row",
			                          "baseprice_check_row",
									  "baseprice_check_nonitem_row",
									  "baseprice_check_nonitem_room_row",
									  "baseprice_add_nonitem_row",
			                          "menu_list",
			                          "menu_tab_list"]);

		return deferred.resolve(instance);
	}

	var getInformations=function(tpl,informations){

		var deferred=$.Deferred();

		if(informations!=undefined){

			var menus=informations["list"]["menus"];
			var information=informations["list"]["list"];
			var prices=informations["price"]["data"];
			return deferred.resolve(tpl,information,menus,prices);
		}

		var params={};
		params["type"]=menu_type;
		apiGeoRequests.getMasterData(params,function(status,res){

			if(!status) return deferred.reject(res);
			var informations=res["data"];
			var menus=informations["list"]["menus"];
			var information=informations["list"]["list"];
			var prices=informations["price"]["data"];
			deferred.resolve(tpl,information,menus,prices);
		});

		return deferred.promise();
	}

	var setMenuTabFragment=function(tpl,menus){

		var category;
		var aliase;
		var menu_tab_html;
		var menu_tab_tpl=tpl.get_menu_tab_list;
		var tab_fragment=document.createDocumentFragment();
		for(var aliase in menus){

			menu=menus[aliase];
			menu_tab_html=$(tpl.replaceTPL(menu_tab_tpl,{
			
				"category_aliase":aliase,
				"name":menu
			}));

			tab_fragment.appendChild(menu_tab_html.get(0));
		}

		return tab_fragment;
	}

	var setDataTabRoomFragment=function(tpl,aliases,menus,information,fragment){
	
		if(1>aliases.length) return fragment;

		var fn=arguments.callee;
		var aliase=aliases.shift();
		var category=menus[aliase];
		var data_tab_tpl=tpl.get_menu_list;

		var data_row_nonitem_room_tpl=tpl.get_baseprice_check_nonitem_room_row;
		var use_tpl=data_row_nonitem_room_tpl;
		var data_tab_html=$(tpl.replaceTPL(data_tab_tpl,{
		
			"category_aliase":aliase,
			"category":category
		}));

		fragment=(fragment==undefined)?document.createDocumentFragment():fragment;

		var row_fragment=document.createDocumentFragment();
		var data_tbody=data_tab_html.find("tbody[data-type=\"data-tbody\"]");
		var category_information=information[aliase];
		var data_row_html;
		var remarks;
		var master_id;
		var menu_types    =information["menu_types"];
		var resident_types=information["residence_types"];
		var menu_type_html;
		var resident_type_html;
		var floor_html;
		var remark_html;

		for(var meal_id in category_information){

			master_id=category_information[meal_id]["id"];
			remarks=(category_information[meal_id]["remarks"].length>0?category_information[meal_id]["remarks"]:"");
			data_row_html=$(tpl.replaceTPL(use_tpl,{
			
				"room_num":category_information[meal_id]["name"],
				"meal_id" :meal_id,
				"aliase"  :aliase,
				"staff"   :category_information[meal_id]["employee"]["name"]
			}));

			menu_type_html=data_row_html.find("select[data-type=\"room-type\"]");
			resident_type_html=data_row_html.find("select[data-type=\"room-residence\"]");
			floor_html=data_row_html.find("input[data-type=\"room-floor\"]");
			remark_html=data_row_html.find("input[type=text][data-type=\"room-remarks\"]");

			setMenu.call(menu_type_html,menu_types);
			setMenu.call(resident_type_html,resident_types);

			menu_type_html.val(category_information[meal_id]["room_type_id"]);
			resident_type_html.val(category_information[meal_id]["type"]);
			floor_html.val(category_information[meal_id]["floor"]);
			remark_html.val(category_information[meal_id]["remarks"]);

			data_row_html.children("td").eq(0).css("width","5px !important");

			data_row_html.find("input[type=text][data-type=\"data-remarks\"]").val(remarks);
			data_row_html.find("input[type=text][data-type=\"data-itemtitle\"]").val(category_information[meal_id]["name"]);
			data_row_html.find("input[type=text][data-type=\"data-itemnum\"]").val(category_information[meal_id]["item_num"]);
			row_fragment.appendChild(data_row_html.get(0));
		}

		data_tbody.append(row_fragment);
		fragment.appendChild(data_tab_html.get(0));
		return fn(tpl,aliases,menus,information,fragment);
	}

	var setDataTabFragment=function(tpl,aliases,menus,information,prices,fragment){
	
		if(1>aliases.length) return fragment;

		var fn=arguments.callee;
		var aliase=aliases.shift();
		var category=menus[aliase];
		var data_tab_tpl=tpl.get_menu_list;

		var data_row_tpl=tpl.get_baseprice_check_row;
		var data_row_nonitem_tpl=tpl.get_baseprice_check_nonitem_row;
		var data_row_nonitem_room_tpl=tpl.get_baseprice_check_nonitem_room_row;

		var othertpl_types={};
		othertpl_types["<?php echo K9MasterReststay::$CATEGORY_RESTSTAY; ?>"]=data_row_nonitem_tpl;
		othertpl_types["<?php echo K9MasterRoomType::$CATEGORY_ROOMTYPE; ?>"]=data_row_nonitem_tpl;
		var use_tpl=othertpl_types[menu_type]==undefined?data_row_tpl:othertpl_types[menu_type];

		var data_tab_html=$(tpl.replaceTPL(data_tab_tpl,{
		
			"category_aliase":aliase,
			"category":category
		}));

		fragment=(fragment==undefined)?document.createDocumentFragment():fragment;

		var row_fragment=document.createDocumentFragment();
		var data_tbody=data_tab_html.find("tbody[data-type=\"data-tbody\"]");
		var category_information=information[aliase];
		var data_row_html;
		var remarks;
		var master_id;

		for(var meal_id in category_information){

			master_id=category_information[meal_id]["id"];
			remarks=(category_information[meal_id]["remarks"].length>0?category_information[meal_id]["remarks"]:"");
			data_row_html=$(tpl.replaceTPL(use_tpl,{
			
				"meal_id" :meal_id,
				"item_num":category_information[meal_id]["item_num"],
 				"price"   :prices[master_id]["data"]["price"],
				"staff"   :category_information[meal_id]["employee"]["name"],
				"aliase"  :aliase,
			}));

			data_row_html.children("td").eq(0).css("width","5px !important");
			data_row_html.find("input[type=text][data-type=\"data-remarks\"]").val(remarks);
			data_row_html.find("input[type=text][data-type=\"data-itemtitle\"]").val(category_information[meal_id]["name"]);
			data_row_html.find("input[type=text][data-type=\"data-itemnum\"]").val(category_information[meal_id]["item_num"]);
			row_fragment.appendChild(data_row_html.get(0));
		}

		var data_add_row_html=addButtonRowElement(tpl,aliase);
		row_fragment.append(data_add_row_html.get(0));

		data_tbody.append(row_fragment);
		fragment.appendChild(data_tab_html.get(0));

		var last_num=getLastItemNum(aliase,information);
		if(!!last_num) data_add_row_html.find("input[type=text][data-type=\"menu-itemnum\"]").val(last_num);

		return fn(tpl,aliases,menus,information,prices,fragment);
	}

	// 次の番号(フォーマットに沿ってなければNG)
	var getLastItemNum=function(aliase,information){

		if(information[aliase]==undefined) return false;
		var last_index=information[aliase].length-1;

		var latest_itemnum=information[aliase][last_index]["item_num"];
		if(information[aliase][last_index]["item_num"]==undefined) return false;

		var split_latest_itenum=latest_itemnum.split("-");
		if(2>split_latest_itenum.length) return false;

		var prefix=split_latest_itenum[0];
		var num=split_latest_itenum[1];

		var alpha_match=prefix.match(/^[a-zA-Z]+$/);
		if(!alpha_match) return false;
		var num_match=(num+"").match(/^[0-9]+$/);
		if(!num_match) return false;

		var num=parseInt(num);
		var next_num=num+1;
		next_num=Number(next_num).addZero();
		next_num=prefix+"-"+next_num;
		return next_num;
	}

	var addButtonRowElement=function(tpl,aliases){

		var data_add_row_tpl=tpl.get_baseprice_add_row;
		var data_add_nomitem_row_tpl=tpl.get_baseprice_add_nonitem_row;

		var othertpl_types={};
		othertpl_types["<?php echo K9MasterReststay::$CATEGORY_RESTSTAY; ?>"]=data_add_nomitem_row_tpl;
		othertpl_types["<?php echo K9MasterRoomType::$CATEGORY_ROOMTYPE; ?>"]=data_add_nomitem_row_tpl;
		var use_tpl=othertpl_types[menu_type]==undefined?data_add_row_tpl:othertpl_types[menu_type];

		var data_add_row_html=$(tpl.replaceTPL(use_tpl,{ "staff":"<?php echo $first_name; ?>" }));
		return data_add_row_html;
	}

	var setLayout=function(tpl,information,menus,prices){

		var deferred=$.Deferred();
		var main_tpl=tpl.get_list_main_mastermenus;
		var main_html=$(main_tpl);
		var menu_list=main_html.find("div[data-type=\"menu-list\"]");
		var menu_tab_list=main_html.find("ul[data-type=\"menu-tab-list\"]");
		var main_fragment=document.createDocumentFragment();
		var tab_fragment=document.createDocumentFragment();
		var tab_fragment=setMenuTabFragment(tpl,menus);
		menu_tab_list.append(tab_fragment);
		var aliases=Object.keys(menus);

		switch(menu_type){
		
		case("<?php echo K9MasterRoom::$CATEGORY_ROOM?>"):

			var data_fragment=setDataTabRoomFragment(tpl,aliases,menus,information);
			break;

		default:

			var data_fragment=setDataTabFragment(tpl,aliases,menus,information,prices);
			break;
		}

		menu_list.append(data_fragment);

		return deferred.resolve(tpl,main_html,information,menus,prices);
	}

	var getSelectedValueForEditNeeded=function(prices){

		var main_html=this;
		var edit_values={}; 
		var data_rows=main_html.find("tr[data-type=\"data-menu-row\"]");
		data_rows.each(function(){
		
			var target=$(this);
			var data_id=target.attr("data-id");
			var input=target.find("input");
			var input_price=input.val().trim();
			if(1>input_price.length) return;

			var price=Math.max(input_price,0);
			if(price==prices[data_id]["data"]["price"]) return;
			edit_values[data_id]=price;
		});

		return edit_values;
	}

	var viewFoodRemodal=function(tpl,main_html,information,menus,prices){

		var deferred=$.Deferred();

		var message=main_html;

		var params={};
		params["yes"]=function(){};
		params["no"]=function(){};
		params["close"]=function(){};

		params["menu-add-button"]=function(e,type){

			if(type=="start") return;
			var target=$(e.target);
			var aliase=target.parents("div[data-type=\"food-menu-list\"]").attr("data-aliase-type");
			var data_add_row_html=addButtonRowElement(tpl,aliase);
			var add_target_tbody=target.parents("tbody[data-type=\"data-tbody\"]");

			var last_num=getLastItemNum(aliase,information);
			if(!!last_num) data_add_row_html.find("input[type=text][data-type=\"menu-itemnum\"]").val(last_num);

			add_target_tbody.append(data_add_row_html);
		};

		params["data-menu-checkbox"]=function(e,type){
		
			if(type=="start") return;
			var target=$(e.target);
			var menu_row=target.parents("tr[data-type=\"data-menu-row\"]");
			var menu_top=menu_row.parents("div[data-type=\"food-menu-list\"]");
			var aliase=menu_top.attr("data-aliase-type");
			var is_checked=target.is(":checked");
			target.prop("checked",(is_checked)?false:true);

			is_checked=target.is(":checked");
			menu_row.css("background-color",(is_checked)?"#fff":"red");
		};

		params["other-item"]=function(e,type){

			if(type=="start") return;

			var remodal=this;
			var is_edit=false;
			var checkboxs=main_html.find("input[type=checkbox][data-type=\"data-menu-checkbox\"]").not(":checked");
			var add_data_rows=main_html.find("tr[data-type=\"data-add-menu-row\"]");
			var enable_add_data_rows=add_data_rows.filter(function(){
			
				var data_row=$(this);
				var menu_title_ja  =data_row.find("input[type=\"text\"][data-type=\"menu-title-ja\"]");
				var menu_title_en  =data_row.find("input[type=\"text\"][data-type=\"menu-title-en\"]");
				var menu_price  =data_row.find("input[type=\"number\"][data-type=\"menu-price\"]");
				var menu_title_value_ja=menu_title_ja.val().trim();
				var menu_title_value_en=menu_title_en.val().trim();
				var menu_price_value=menu_price.val().trim();
				menu_price_value=parseFloat(menu_price_value);
				menu_price_value=Math.max(0,menu_price_value);

				if(0.1>menu_price_value) return false;
				if(1>menu_title_value_ja.length) return false;
				if(1>menu_title_value_en.length) return false;
				return true;
			});

			var size=checkboxs.size();
			if(size>0) is_edit=true;
			if(enable_add_data_rows.size()>0) is_edit=true;

			if(is_edit){

				var res=window.confirm("<?php echo __("変更された情報は保存されませんが宜しいですか？"); ?>");
				if(!res) return;
			}

			prices=null;
			remodal.close(null,function(){

				priceMasterSetting("item");
			})
			return;
		}

		var subscribeMenuItems=function(type,current_aliase){

			var remodal=this;
			var getRemoveItemValues=function(){
			
				var deferred=$.Deferred();
				var checkboxs=main_html.find("input[type=checkbox][data-type=\"data-menu-checkbox\"]").not(":checked");
				var remove_menu_ids=[];
				checkboxs.each(function(){

					var target=$(this);
					var data_row=target.parents("tr[data-type=\"data-menu-row\"]");
					var aliase=data_row.attr("data-aliase-type");
					var data_id=data_row.attr("data-id");
					var target_information=information[aliase][data_id];
					var master_id=target_information["id"];
					remove_menu_ids.push(master_id);
				});

				return deferred.resolve(remove_menu_ids);
			}
			
			var getEditItems=function(){

				var deferred=$.Deferred();

				var edit_menu_objects=[];
				var menu_list=main_html.find("div[data-type=\"food-menu-list\"]");
				var data_rows=menu_list.find("tr[data-type=\"data-menu-row\"]");
				data_rows.each(function(){
				
					var target=$(this);
					var aliase =target.attr("data-aliase-type");
					var data_id=target.attr("data-id");
					var target_info=information[aliase][data_id];
					var master_id=target_info["id"];
					var remarks=target.find("input[type=text][data-type=\"data-remarks\"]").val().trim();
					var item   =target.find("input[type=text][data-type=\"data-itemtitle\"]").val().trim();
					var item_num=target.find("input[type=text][data-type=\"data-itemnum\"]").val().trim();

					var is_edit=false;
					if(remarks!=target_info["remarks"]) is_edit=true;
					if(!is_edit && item!=target_info["name"]) is_edit=true;
					if(!is_edit && item_num!=target_info["item_num"]) is_edit=true;
					if(!is_edit) return;

					edit_menu_objects.push({
					
						"id"      :master_id,
						"remarks" :remarks,
						"name"    :item,
						"item_num":item_num
					});
				});

				return deferred.resolve(edit_menu_objects);
			}

			var getNewItems=function(){

				var deferred=$.Deferred();

				var add_menu_objects=[];
				var menu_list=main_html.find("div[data-type=\"food-menu-list\"]");
				var add_data_rows=menu_list.find("tr[data-type=\"data-add-menu-row\"]");
				add_data_rows.each(function(){

					var data_row=$(this);
					var menu_top=data_row.parents("div[data-type=\"food-menu-list\"]");
					var aliase=menu_top.attr("data-aliase-type");

					var menu_title_ja  =data_row.find("input[type=\"text\"][data-type=\"menu-title-ja\"]");
					var menu_title_en  =data_row.find("input[type=\"text\"][data-type=\"menu-title-en\"]");
					var menu_price  =data_row.find("input[type=\"number\"][data-type=\"menu-price\"]");
					var menu_remarks=data_row.find("input[type=\"text\"][data-type=\"menu-remarks\"]");
					var menu_itemnum=data_row.find("input[type=\"text\"][data-type=\"menu-itemnum\"]");

					var menu_title_value_ja  =menu_title_ja.val().trim();
					var menu_title_value_en  =menu_title_en.val().trim();
					var menu_price_value  =Math.max(menu_price.val().trim(),0);
					var menu_remarks_value=menu_remarks.val().trim();

					var menu_itemnum_value="";
					if(menu_itemnum.size()>0) menu_itemnum_value=menu_itemnum.val().trim();

					menu_price_value=parseFloat(menu_price_value);
					menu_price_value=Math.max(0,menu_price_value);

					if(0.1>menu_price_value) return;
					if(1>menu_title_value_ja.length) return;
					if(1>menu_title_value_en.length) return;

					add_menu_objects.push({
					
						"title_ja"  :menu_title_value_ja,
						"title_eng" :menu_title_value_en,
						"price"     :menu_price_value,
						"remarks"   :menu_remarks_value,
						"itemnum"   :menu_itemnum_value,
						"aliase"    :aliase
					});
				});

				return deferred.resolve(add_menu_objects);
			}

			$.when(getNewItems(),getRemoveItemValues(),getEditItems()).
			done(function(add_menu_objects,remove_menu_ids,edit_menu_objects){
			
				if(remove_menu_ids.length>0){
	
					var message="<?php echo __("項目が削除される様設定されています、宜しいですか？"); ?>";
					message   +="<?php echo __("※再度表示する場合は開発元に問い合わせ下さい"); ?>";
					var res=window.confirm(message);
					if(!res) return;
				}

				if(1>remove_menu_ids.length && 1>add_menu_objects.length && 1>edit_menu_objects.length){

					alert("<?php echo __("変更された項目は存在しません"); ?>");
					return;
				}

				var lis=main_html.find("ul[data-type=\"menu-tab-list\"]").children("li");
				var li_active=lis.filter(function(){ return $(this).hasClass("active"); });
				var aliase=li_active.attr("data-aliase-type");

				var params={"data":{}};
				params["type"]=menu_type;
				params["data"]["remove_menu_ids"]  =remove_menu_ids;
				params["data"]["add_menu_objects"] =add_menu_objects;
				params["data"]["edit_menu_objects"]=edit_menu_objects;
				apiGeoRequests.masterItemSubscribe(params,function(status,res){

					if(!status){
					
						alert(res["message"]);
						return;
					}

					alert("<?php echo __("設定した内容が正常に登録されました"); ?>");

					main_html.remove();

					var informations=res["data"];
					remodal.close(null,function(){

						make(informations["data"],current_aliase);
					});
				});
			});
		}

		var subscribeMenuRoomItems=function(type,current_aliase){

			var remodal=this;

			var editInformations=function(){
			
				var deferred=$.Deferred();

				var edit_values=[];
				var data_tbodies=main_html.find("tbody[data-type=\"data-tbody\"]");
				data_tbodies.each(function(){
				
					var data_tbody=$(this);
					var data_trs=data_tbody.children("tr");
					data_trs.each(function(){
					
						var data_tr=$(this);
						var data_id            =data_tr.attr("data-id");
						var aliase             =data_tr.attr("data-aliase-type");
						var room_type_val      =data_tr.find("select[data-type=\"room-type\"]").val();
						var room_regidence_val =data_tr.find("select[data-type=\"room-residence\"]").val();
						var room_floor_val     =data_tr.find("input[type=number][data-type=\"room-floor\"]").val().trim();
						var room_remark_val    =data_tr.find("input[type=text][data-type=\"room-remarks\"]").val().trim();
						var current_information=information[aliase][data_id];
						var master_id=current_information["id"];

						var is_edit=false;
						if(current_information["floor"]!=room_floor_val) is_edit=true;
						if(!is_edit && current_information["room_type_id"]!=room_type_val) is_edit=true;
						if(!is_edit && current_information["type"]!=room_regidence_val)    is_edit=true;
						if(!is_edit && current_information["remarks"]!=room_remark_val)    is_edit=true;
						if(!is_edit) return;

						edit_values.push({
						
							"master_id"   :master_id,
							"floor"       :room_floor_val,
							"room_type_id":room_type_val,
							"type"        :room_regidence_val,
							"remarks"     :room_remark_val
						});
					});
				});

				return deferred.resolve(edit_values);
			}

			var editRoomInformation=function(edit_values){

				var deferred=$.Deferred();

				if(1>edit_values.length){

					return deferred.reject({ "message":"<?php echo __("変更された項目は存在しません"); ?>" });
				}

				var params={"data":{}};
				params["data"]["edit_values"]=edit_values;
				params["type"]=menu_type;
				apiGeoRequests.masterItemSubscribeForRoom(params,function(status,res){
		
					if(!status) return deferred.reject(res);
					return deferred.resolve(res["data"]);
				});

				return deferred.promise();
			}

			editInformations().
			then(editRoomInformation).
			done(function(information){

				alert("<?php echo __("設定した内容が正常に登録されました"); ?>");

				main_html.remove();
				remodal.close(null,function(){ 
					
					make(information["data"],current_aliase); 
				});
			}).
			fail(function(res){
			
				alert(res["message"]);
			});
		}

		params["order-save"]=function(e,type){
		
			if(type=="start") return;

			var button=$(e.target);
			var current_aliase=button.parents("div[data-type=\"food-menu-list\"]").attr("data-aliase-type");

			switch(menu_type){

			case("<?php echo K9MasterRoom::$CATEGORY_ROOM?>"):

				subscribeMenuRoomItems.call(this,type,current_aliase);
				break;

			default:

				subscribeMenuItems.call(this,type,current_aliase);
				break;
			}
		}

		params["tab-selected"]=function(e,type){
		
			if(type=="start") return;
		}

		remodalAlert("normal_1200",main_title,message,params);

		return deferred.resolve(tpl,main_html,information,menus,prices);
	}

	var setEvents=function(tpl,main_html,information,prices){

		var deferred=$.Deferred();
		var data_menu_row=main_html.find("tr[data-type=\"data-menu-row\"]");
		var data_select_row=main_html.find("tr[data-type=\"data-select-row\"]");
		var input_menu_rows=data_menu_row.find("input[type=number]");
		var input_select_rows=data_select_row.find("input[type=number]");

		input_menu_rows.on("change",function(e){
		
			var target=$(e.target);
			var fn=arguments.callee;
			var data_row=target.parents("tr[data-type=\"data-menu-row\"]");
			var data_id=data_row.attr("data-id");
			var price=target.val();
			var prev_price=prices[data_id]["price"];
			var is_same_price=(price==prev_price);
			data_row.css("background-color",(is_same_price?"#fff":"red"));
		});

		return deferred.resolve(tpl,main_html,information);
	}

	var viewFirstCategoryByAlias=function(aliase){

		var main_html=this;
		var target_lis=main_html.find("ul[data-type=\"menu-tab-list\"]").children("li");
		var target_li=target_lis.filter("li[data-aliase-type=\""+aliase+"\"]");
		target_li.addClass("active");
	}

	var viewFirstMenuByAliase=function(aliase){

		var main_html=this;
		var menu_list=main_html.find("div[data-type=\"menu-list\"]");
		var target_list=menu_list.find("div[id=\""+aliase+"\"]");
		target_list.addClass("in active");
	}

	var make=function(information,first_aliase){

		setFoodTemplates().
		then(function(tpl){

			switch(information==undefined){
			
			case(true):
				return getInformations(tpl,undefined);
				break;
			case(false):
				return getInformations(tpl,information);
				break;
			}
		
		}).
		then(setLayout).
		then(viewFoodRemodal).
		then(function(tpl,main_html,information,menus,prices){ 

			switch(first_aliase==undefined){
			
			case(true):

				var deferred=$.Deferred();
				first_aliase=Object.keys(menus)[0];
				viewFirstCategoryByAlias.call(main_html,first_aliase);
				return deferred.resolve(tpl,main_html,information,menus,prices);
				break;

			case(false):
				
				var deferred=$.Deferred();
				viewFirstCategoryByAlias.call(main_html,first_aliase);
				return deferred.resolve(tpl,main_html,information,menus,prices);
				break;
			}
		}).
		then(function(tpl,main_html,information,menus,prices,aliase){

			switch(first_aliase==undefined){
			
			case(true):

				var deferred=$.Deferred();
				first_aliase=Object.keys(menus)[0];
				viewFirstMenuByAliase.call(main_html,first_aliase);
				return deferred.resolve(tpl,main_html,information,prices);
				break;

			case(false):
				
				var deferred=$.Deferred();
				viewFirstMenuByAliase.call(main_html,first_aliase);
				return deferred.resolve(tpl,main_html,information,prices);
				break;
			}
		}).
		then(setEvents).
		done(function(){
		
		}).
		fail(function(res){ alert(res["message"]); });
	}

	make(null);
}

var creditSituation=function(reservation_hash,reserve_id,information){

	var getCreditSituations=function(information){
	
		var deferred=$.Deferred();

		if(information!=undefined){
		
			return deferred.resolve(information);
		}

		var params={};
		params["reservation_hash"]=reservation_hash;
		apiGeoRequests.getCreditSituation(params,function(status,res){

			if(!status) return deferred.reject(res);
			return deferred.resolve(res["data"]);
		});

		return deferred.promise();
	}

	var makeCreditSituationMainView=function(information){
	
		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_credit_situation"]);
		var main_tpl=instance.replaceTPL(instance.get_remodal_credit_situation,{
		
			"reserve_id":reserve_id,
		});
		var main_html=$(main_tpl);
		return deferred.resolve(main_html,information);
	}

	var makeCreditSituationListView=function(main_html,information){

		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_credit_situation_child"]);
		var child_tpl=instance.get_remodal_credit_situation_child;
		var fragment=document.createDocumentFragment();
		var credit   =information["credit"];
		var date_menu=information["date"];

		if($.isArray(credit) && 1>credit.length){
		
			return deferred.resolve(main_html,information);
		}

		var items;
		var item;
		var employee;
		var child_html;
		for(var ymd in credit){
		
			items=credit[ymd];
			for(var i in items){

				item    =items[i];
				child_html=$(instance.replaceTPL(child_tpl,{

					"credit_id"    :item["credit"]["id"],
					"current_price":item["credit"]["price"],
					"staff"        :item["employee"]["name"],
					"time"         :item["credit"]["enter_date"],
					"ymd"          :ymd
				}));

				fragment.appendChild(child_html.get(0));
			}
		}

		main_html.find("div[data-type=\"credit-list\"]").append(fragment);
		return deferred.resolve(main_html,information);
	}
	
	var makeCreditSituationSelectOptions=function(main_html,information){

		var deferred=$.Deferred();
		var date=information["date"];
		var credit=information["credit"];
		var cashtypes=information["cashtypes"];

		var selects=main_html.find("select[data-type=\"credit-select\"]");
		setMenu.call(selects,date);

		var cashtype_select=main_html.find("select[data-type=\"credit-payment-type\"]");
		setMenu.call(cashtype_select,cashtypes);

		return deferred.resolve(main_html,information);
	}

	var makeCreditSituationSelectValue=function(main_html,information){
	
		var deferred=$.Deferred();
		var row_tops=main_html.find("div[data-type=\"credit-situation-row-top\"]");

		row_tops.each(function(){
		
			var row_top=$(this);
			var ymd       =row_top.attr("data-ymd");
			var credit_id =row_top.attr("data-credit-id");

			if(credit_id>0){

				var credit         =information["credit"][ymd][credit_id]["credit"];
				var cash_type_id   =credit["cash_type_id"];
				var cashtype_select=row_top.find("select[data-type=\"credit-payment-type\"]");
				cashtype_select.val(cash_type_id);
			}

			if(ymd>0){

				var select=row_top.find("select[data-type=\"credit-select\"]");
				select.val(ymd);
				select.prop("disabled",true).css("background-color","#ccc");
			}
		});

		return deferred.resolve(main_html,information);
	}

	var makeCreditSituationRemarkValue=function(main_html,information){

		var deferred=$.Deferred();
		var row_tops=main_html.find("div[data-type=\"credit-situation-row-top\"]");

		row_tops.each(function(){
		
			var row_top=$(this);
			var ymd=row_top.attr("data-ymd");
			if(1>ymd) return;

			var credit_id=row_top.attr("data-credit-id");
			var remarks=row_top.find("input[type=text][data-type=\"credit-remarks\"]");
			var remark_value=information["credit"][ymd][credit_id]["credit"]["remarks"];
			remarks.val(remark_value);
		});

		return deferred.resolve(main_html,information);
	}

	var makeCreditSituationAddView=function(main_html,information){

		var deferred=$.Deferred();

		var instance=TPL.getInstance(["remodal_credit_situation_child_add"]);
		var add_child_tpl=instance.get_remodal_credit_situation_child_add;
		var add_child_html=$(instance.replaceTPL(add_child_tpl,{
		
			"staff":"<?php echo $first_name; ?>",
			"time" :"<?php echo localDateNormalUtime(time()); ?>"
		}));

		main_html.find("div[data-type=\"credit-list\"]").append(add_child_html);

		return deferred.resolve(main_html,information);
	}

	getCreditSituations(information).
	then(makeCreditSituationMainView).
	then(makeCreditSituationListView).
	then(makeCreditSituationAddView).
	then(makeCreditSituationSelectOptions).
	then(makeCreditSituationSelectValue).
	then(makeCreditSituationRemarkValue).
	done(function(main_html,information){

		var message=main_html;

		var params={};

		params["credit-checkbox"]=function(e,type){
		
			if(type=="start") return;

			var target=$(e.target);
			var menu_row=target.parents("div[data-type=\"credit-situation-row-top\"]");
			var is_checked=target.is(":checked");
			target.prop("checked",(is_checked)?false:true);
			is_checked=target.is(":checked");
			menu_row.css("background-color",(is_checked)?"#fff":"red");
		};

		params["credit-add-button"]=function(e,type){

			if(type=="start") return;

			var target=$(e.target);
			var menu_row=target.parents("div[data-type=\"credit-situation-row-top\"]");
			makeCreditSituationAddView(main_html,information).done(function(main_html,information){

				var date  =information["date"];
				var selects=main_html.find("select[data-type=\"credit-select\"]");
				var last_select=selects.eq(selects.size()-1);
				setMenu.call(last_select,date);
			})
		};

		params["credit-save"]=function(e,type){

			if(type=="start") return;

			var remodal=this;
			var credit=information["credit"];

			var new_credits={};
			var current_credits={};
			var remove_menu_ids=[];
			var menu_tops=main_html.find("div[data-type=\"credit-situation-row-top\"]");

			menu_tops.each(function(){

				var menu_row=$(this);
				var menu_id =menu_row.attr("data-credit-id");
				var ymd     =menu_row.attr("data-ymd");
				var is_add_row =(1>menu_id);
				var price=menu_row.find("input[type=number][data-type=\"credit-price\"]").val().trim();
				var remarks=menu_row.find("input[type=text][data-type=\"credit-remarks\"]").val().trim();
				var cashtype=menu_row.find("select[data-type=\"credit-payment-type\"]");
				var cash_type_id=cashtype.val();

				switch(is_add_row){
				
				case(true):

					if(1>price.length) return;
					if(0.1>price) return;

					var select_date=menu_row.find("select[data-type=\"credit-select\"]").val();
					if(new_credits[select_date]==undefined) new_credits[select_date]=[];
					new_credits[select_date].push({
					
						"price"  :Math.max(price,0),
						"remarks":remarks,
						"cash_type_id":cash_type_id
					});
					break;

				case(false):

					var is_checked=menu_row.find("input[type=checkbox][data-type=\"credit-checkbox\"]").is(":checked");
					if(!is_checked){

						remove_menu_ids.push(menu_id);
						return;
					}

					if(1>price.length) return;

					var is_price_same   =(credit[ymd][menu_id]["credit"]["price"]==price);
					var is_remark_same  =(credit[ymd][menu_id]["credit"]["remarks"]==remarks);
					var is_cashtype_same=(credit[ymd][menu_id]["credit"]["cash_type_id"]==cash_type_id);
					if(is_price_same && is_remark_same && is_cashtype_same) return;

					current_credits[menu_id]={};
					current_credits[menu_id]["price"]       =price;
					current_credits[menu_id]["remarks"]     =remarks;
					current_credits[menu_id]["cash_type_id"]=cash_type_id;
					break;
				}
			});

			if(1>Object.keys(new_credits).length && 1>Object.keys(current_credits) && 1>remove_menu_ids.length){
			
				alert("<?php echo __("変更された項目は存在しません"); ?>");
				return;
			}

			var params={"data":{}};
			params["data"]["new"]    =new_credits;
			params["data"]["current"]=current_credits;
			params["data"]["remove_menu_ids"]=remove_menu_ids;
			params["reservation_hash"]=reservation_hash;
			apiGeoRequests.creditSubscribe(params,function(status,res){

				if(!status) return deferred.reject(res);

				alert("<?php echo __("設定した内容が正常に登録されました"); ?>");

				remodal.close(null,function(){

					creditSituation(reservation_hash,reserve_id,res["data"]["data"]);
				});
			});
		};

		var main_title="<?php echo __("クレジット設定"); ?>";
		remodalAlert("normal_1200",main_title,message,params);

	});
}

var viewCheckoutPayment=function(reservation_hash,callback){

	var viewCheckoutPayment=function(information){
	
		var deferred=$.Deferred();
		var instance=TPL.getInstance("remodal_payment_way");
		var payment_html=$(instance.get_remodal_payment_way);
		return deferred.resolve(payment_html,information);
	}

	var setEventForCheckoutPayment=function(payment_html,information){

		var deferred=$.Deferred();

		var howto_payment_select=payment_html.find("select[data-type=\"howto-payment\"]");
		var payment_cards_select=payment_html.find("select[data-type=\"payment-cards\"]");
		var payment_card_parent=payment_cards_select.parents("div[data-type=\"select-block\"]");

		howto_payment_select.change(function(e){
		
			var target=$(e.target);
			var value=target.val();
			var option=target.children("option").eq(value);
			var type=option.text();

			switch(type){
			
			case("card"):

				payment_card_parent.show();
				break;

			case("cash"):

				payment_card_parent.hide();
				break;
			}
		});

		return deferred.resolve(payment_html,information);
	}
	
	var setSelectedTypeValues=function(payment_html,information){

		var deferred=$.Deferred();

		var howto_payment_select=payment_html.find("select[data-type=\"howto-payment\"]");
		var purchase_progress_select=payment_html.find("select[data-type=\"purchase-progress\"]");
		var payment_cards_select=payment_html.find("select[data-type=\"payment-cards\"]");
		var payment_card_parent=payment_cards_select.parents("div[data-type=\"select-block\"]");

		var cashtypes=Object.keys(information["menus"]);
		var current=information["data"];
		var cardtypes=information["menus"]["card"];
		setMenu.call(howto_payment_select,cashtypes);
		setMenu.call(payment_cards_select,cardtypes);
		setMenu.call(purchase_progress_select,{ "0":'<?php echo __("未支払"); ?>',"1":'<?php echo __("支払済"); ?>' });

		if(current["type"]!=undefined) howto_payment_select.val((current["type"]=="cash"?0:1));
		if(current["purchase_flg"]!=undefined) purchase_progress_select.val(current["purchase_flg"]);
		if(current["cash_type_id"]!=undefined && current["cash_type_id"]!=1) payment_cards_select.val(current["cash_type_id"]);
		payment_card_parent[howto_payment_select.val()==1?"show":"hide"]();

		return deferred.resolve(payment_html,information);
	}

	var getCashtypeInformations=function(){

		var deferred=$.Deferred();

		var params={};
		params["reservation_hash"]=reservation_hash;
		apiGeoRequests.getCheckoutPayment(params,function(status,res){

			var information=res["data"];
			deferred.resolve(information);
		});

		return deferred.promise();
	}

	getCashtypeInformations().
	then(viewCheckoutPayment).
	then(setSelectedTypeValues).
	then(setEventForCheckoutPayment).
	done(function(payment_html,information){

		var main_title="<?php echo __("支払いに関して"); ?>";
		var message=payment_html;
		remodalAlert("normal_800",main_title,message,{

			"yes"  :function(){},
			"no"   :function(){},
			"close":function(){},
			"remodal-close":function(e,type){

				if(type=="start") return;

				var remodal=this;
				remodal.close(null,function(){
				
					callback();
				});
			},
			"payment-save":function(e,type){

				if(type=="start") return;
				var howto_payment_select=payment_html.find("select[data-type=\"howto-payment\"]");
				var payment_cards_select=payment_html.find("select[data-type=\"payment-cards\"]");
				var purchase_progress_select=payment_html.find("select[data-type=\"purchase-progress\"]");

				var payment_type_val=howto_payment_select.val();
				var payment_type=howto_payment_select.children("option").eq(payment_type_val).text();
				var purchase_flg=purchase_progress_select.val();

				var data={};
				switch(payment_type){
				
				case("cash"):

					data["cash_type_id"]=1;
					data["purchase_flg"]=purchase_flg;
					break;

				case("card"):

					data["cash_type_id"]=payment_cards_select.val();
					data["purchase_flg"]=purchase_flg;
					break;
				}

				var params={};
				params["data"]=data;
				params["reservation_hash"]=reservation_hash;
				apiGeoRequests.paymentWaySubscribe(params,function(status,res){

					if(!status){
					
						alert(res["message"]);
						return;
						return;
					}

					alert("<?php echo __("設定した内容が正常に登録されました"); ?>");
					callback();
				});
			},
			"howto-payment" :function(e,type){

				if(type=="start") return;
			}
		});
	});
}

var outputPayment=function(ymd){

	var mainView=function(information,menus){
	
		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_outputpayment_situation"]);
		var main_html=$(instance.get_remodal_outputpayment_situation);
		return deferred.resolve(main_html,information,menus);
	}

	var setCalendar=function(main_html,information,menus){

		var deferred=$.Deferred();
		var calender_input=main_html.find("input[data-type=\"outputpayment-date-calendar\"]");

		setCalendarForInput.call(calender_input,{
		
			"onSelect":function(selectedDate){
			
				var calendar=this;
				var ymd=replaceToYmd(selectedDate);

				main_html  =null;
				information=null;

				outputPayment(ymd);
			}
		},{
		
			"minDate":"-60d"
		});

		return deferred.resolve(main_html,information,menus);
	}

	var viewModal=function(main_html,information,menus){

		var deferred=$.Deferred();

		var main_title="<?php echo __("支出設定"); ?>"
		var message=main_html;
		remodalAlert("normal_1200",main_title,message,{
		
			"outputpayment-save":function(e,type){
			
				if(type=="start") return;

				var data={};
				var new_data=[];
				var remove_ids=[];
				var rows=main_html.find("div[data-type=\"row-top\"]");
				var remodal=this;

				var store;
				var item;
				var price;
				var remarks;
				var store_val;
				var item_val;
				var price_val;
				var remarks_value;
				var buyer;

				rows.each(function(){

					var target=$(this);
					var data_id       =target.attr("data-payment-id");
					var is_current_row=data_id>0;

					switch(is_current_row){
					
					case(true):

						var is_remove=!(target.find("input[type=checkbox][data-type=\"outputpayment-status\"]").is(":checked"));

						if(is_remove){
						
							remove_ids.push(data_id);
							return;
						}

						store  =target.find("input[type=text][data-type=\"outputpayment-store\"]");
						item   =target.find("input[type=text][data-type=\"outputpayment-item\"]");
						price  =target.find("input[type=number][data-type=\"outputpayment-value\"]");
						remarks=target.find("input[type=text][data-type=\"outputpayment-remarks\"]");
						buyer  =target.find("select[data-type=\"outputpayment-buyer\"]");

						store_val=store.val().trim();
						item_val =item.val().trim();
						price_val=price.val().trim();
						buyer_id=buyer.val();
						remarks_val=remarks.val().trim();

						if(1>price_val.length) return;

						var is_diffrent=false;
						if(information[data_id]["data"]["store"]!=store_val)                     is_diffrent=true;
						if(!is_diffrent && information[data_id]["data"]["item"]!=item_val)       is_diffrent=true;
						if(!is_diffrent && information[data_id]["data"]["price"]!=price_val)     is_diffrent=true;
						if(!is_diffrent && information[data_id]["data"]["buyer_id"]!=buyer_id)   is_diffrent=true;
						if(!is_diffrent && information[data_id]["data"]["remarks"]!=remarks_val) is_diffrent=true;
						if(!is_diffrent) return;

						data[data_id]={};
						data[data_id]["store"]   =store_val;
						data[data_id]["item"]    =item_val;
						data[data_id]["price"]   =price_val;
						data[data_id]["remarks"] =remarks_val;
						data[data_id]["buyer_id"]=buyer_id;
						break;

					case(false):

						store  =target.find("input[type=text][data-type=\"outputpayment-store\"]");
						item   =target.find("input[type=text][data-type=\"outputpayment-item\"]");
						price  =target.find("input[type=number][data-type=\"outputpayment-value\"]");
						remarks=target.find("input[type=text][data-type=\"outputpayment-remarks\"]");
						buyer  =target.find("select[data-type=\"outputpayment-buyer\"]");

						store_val=store.val().trim();
						item_val =item.val().trim();
						price_val=price.val().trim();
						buyer_id=buyer.val();

						if(1>price_val.length) return;

						remarks_val=remarks.val().trim();
						new_data.push({

							"store"   :store_val,
							"item"    :item_val,
							"price"   :price_val,
							"remarks" :remarks_val,
							"buyer_id":buyer_id
						});
						break;
					}
				});

				if(1>remove_ids.length && 1>new_data.length && 1>Object.keys(data).length){

					alert("<?php echo __('変更された項目は存在しません'); ?>");
					return;
				}

				var params={"data":{}};
				params["data"]["remove_ids"]=remove_ids;
				params["data"]["current_data"]=data;
				params["data"]["new_data"]=new_data;
				params["ymd"]=ymd;
				apiGeoRequests.outputPaymentSubscribe(params,function(status,res){
		
					if(!status){
					
						alert(res["message"]);
						return;
					}

					alert("<?php echo __("設定した内容が正常に登録されました"); ?>");

					remodal.close(null,function(){

						main_html  =null;
						information=null;
						outputPayment(ymd);
					});
				});
			},
			"remodal-close":function(e,type){

				if(type=="end") return;
			},
			"outputpayment-status":function(e,type){

				if(type=="start") return;
				var target=$(e.target);
				var is_checked=target.is(":checked");
				target.prop("checked",(is_checked)?false:true);
				is_checked=target.is(":checked");

				var child_html=target.parents("div[data-type=\"row-top\"]");
				var store=child_html.find("input[type=text][data-type=\"outputpayment-store\"]");
				var item =child_html.find("input[type=text][data-type=\"outputpayment-item\"]");
				var price=child_html.find("input[type=number][data-type=\"outputpayment-value\"]");
				var remarks=child_html.find("input[type=text][data-type=\"outputpayment-remarks\"]");

				store.prop("disabled"  ,(is_checked?false:true));
				item.prop("disabled"   ,(is_checked?false:true));
				price.prop("disabled"  ,(is_checked?false:true));
				remarks.prop("disabled",(is_checked?false:true));

			},
			"outputpayment-add":function(e,type){

				if(type=="start") return;
				setInformationsAdd(main_html,information,menus).done(function(){
				
				});
			}
		});

		return deferred.resolve(main_html,information);
	}

	var getInformations=function(ymd){

		var deferred=$.Deferred();

		var params={};
		params["ymd"]=ymd;
		apiGeoRequests.getOutputPayment(params,function(status,res){

			if(!status) return deferred.reject(res["message"]);
			var information=res["data"]["data"];
			var menus=res["data"]["menu"];
			deferred.resolve(information,menus);
		});

		return deferred.promise();
	}
	
	var setCalendarDefault=function(main_html,information,menus){

		var deferred=$.Deferred();

		var calender_input=main_html.find("input[data-type=\"outputpayment-date-calendar\"]");
		var locale_date=replaceToLocaleFormatWithYmd(ymd);
		calender_input.val(locale_date);
		return deferred.resolve(main_html,information,menus);
	}

	var setInformations=function(main_html,information,menus){

		var deferred=$.Deferred();

		var instance=TPL.getInstance(["remodal_outputpayment_situation_child"]);
		var child_tpl=instance.get_remodal_outputpayment_situation_child;
		var fragment=document.createDocumentFragment();
		var add_target=main_html.find("div[data-type=\"outputpayment-list\"]");

		var child_html;
		var store;
		var item;
		var price;
		var remarks;
		var buyer;
		for(var data_id in information){

			child_html=$(instance.replaceTPL(child_tpl,{ "data_id":data_id,"staff":information[data_id]["employee"]["first_name"] }));
			store=child_html.find("input[type=text][data-type=\"outputpayment-store\"]");
			item =child_html.find("input[type=text][data-type=\"outputpayment-item\"]");
			price=child_html.find("input[type=number][data-type=\"outputpayment-value\"]");
			remarks=child_html.find("input[type=text][data-type=\"outputpayment-remarks\"]");
			buyer=child_html.find("select[data-type=\"outputpayment-buyer\"]");

			setMenu.call(buyer,menus["employee"]);
			buyer.val(information[data_id]["data"]["buyer_id"]);

			store.val(information[data_id]["data"]["store"]);
			item.val(information[data_id]["data"]["item"]);
			price.val(information[data_id]["data"]["price"]);
			remarks.val(information[data_id]["data"]["remarks"]);
			fragment.appendChild(child_html.get(0));
		}

		add_target.append(fragment);
		return deferred.resolve(main_html,information,menus);
	}

	var setInformationsAdd=function(main_html,information,menus){

		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_outputpayment_situation_child_add"]);
		var child_add_tpl=instance.get_remodal_outputpayment_situation_child_add;
		var child_add_html=$(child_add_tpl);

		var buyer_html=child_add_html.find("select[data-type=\"outputpayment-buyer\"]");
		setMenu.call(buyer_html,menus["employee"]);

		var add_target=main_html.find("div[data-type=\"outputpayment-list\"]");
		add_target.append(child_add_html);
		return deferred.resolve(main_html,information,menus);
	}

	getInformations(ymd).
	then(mainView).
	then(setCalendar).
	then(setCalendarDefault).
	then(setInformations).
	then(setInformationsAdd).
	then(viewModal).
	done(function(main_html,information){
	
	}).
	fail(function(){
	
	});
}

var dailyReport=function(){

	var params={};
	params["yes"]=function(){};
	params["no"]   =params["yes"];
	params["close"]=params["yes"];
	params["select-room-num"]=function(e,status){

		if(status=="start") return;
	}

	params["monthly-download"]=function(e,status){
	
		if(status=="start") return;

		var monthly_year =main_html.find("select[data-type=\"monthly-year\"]");
		var monthly_month=main_html.find("select[data-type=\"monthly-month\"]");
		var language=main_html.find("select[data-type=\"daily-report-language\"]");

		var year =monthly_year.val();
		var month=monthly_month.val();

		var params={"data":{}};
		params["data"]["year"] =year;
		params["data"]["month"]=month;
		params["lang"]=language.val();
		apiGeoRequests.reportByMonth(params,function(status,res){ location.href=res["data"]["url"]; });
	};

	var instance=TPL.getInstance(["remodal_daily_report"]);
	var main_tpl=instance.get_remodal_daily_report;
	var main_title="<?php echo __("レポート"); ?>";
	var main_html=$(main_tpl);
	var daily_calendar=main_html.find("input[type=text][data-type=\"daily-report-calendar\"]");

	var language_menus={};
	language_menus["eng"]="<?php echo __("英語"); ?>";
	language_menus["jpn"]="<?php echo __("日本語"); ?>";
	var language=main_html.find("select[data-type=\"daily-report-language\"]");
	setMenu.call(language,language_menus);

	var monthly_year =main_html.find("select[data-type=\"monthly-year\"]");
	var monthly_month=main_html.find("select[data-type=\"monthly-month\"]");

	var years={};
	var before="<?php echo date("Y",strtotime("- 1 year",time())); ?>";
	var current="<?php echo date("Y"); ?>";
	years[current]=current;
	years[before] =before;

	var months={};
	months[1]="<?php echo __("1月"); ?>";
	months[2]="<?php echo __("2月"); ?>";
	months[3]="<?php echo __("3月"); ?>";
	months[4]="<?php echo __("4月"); ?>";
	months[5]="<?php echo __("5月"); ?>";
	months[6]="<?php echo __("6月"); ?>";
	months[7]="<?php echo __("7月"); ?>";
	months[8]="<?php echo __("8月"); ?>";
	months[9]="<?php echo __("9月"); ?>";
	months[10]="<?php echo __("10月"); ?>";
	months[11]="<?php echo __("11月"); ?>";
	months[12]="<?php echo __("12月"); ?>";

	setMenu.call(monthly_year,years);
	setMenu.call(monthly_month,months);
	monthly_year.val(current);
	monthly_month.val("<?php echo date("n"); ?>");

	setCalendarForInput.call(daily_calendar,{
	
		"onSelect":function(selectDate){

			var calendar=$(this);
			var date_split=dateSplitLocaleSaparator(selectDate);
			var ymd=getYmdWithLocaleSplitdates(date_split);
			var language=main_html.find("select[data-type=\"daily-report-language\"]");

			var params={};
			params["day"]=ymd;
			params["lang"]=language.val();
			apiGeoRequests.dailyReport(params,function(status,res){ location.href=res["data"]["url"]; });
		}

	},{ "minDate":"-12m","maxDate":"+0d" });

	var message=main_html;
	remodalAlert("normal_600",main_title,message,params);
}

var employeeRemodal=function(){

	var params={};
	params["yes"]=function(){};
	params["no"]   =params["yes"];
	params["close"]=params["yes"];

	params["select-attendance"]=function(e,status){

		if(status=="start") return;

		var date=new Date("<?php echo $today; ?>");
		var dates=[];
		dates.push(date.getFullYear());
		dates.push(Number(date.getMonth()+1).addZero());
		dates.push(Number(date.getDate()).addZero());
		var ymd=dates.join("");
		attendanceSetting(ymd);
	}

	params["select-account"]=function(e,status){

		if(status=="start") return;
		employeeSetting();
	}

	var instance=TPL.getInstance(["remodal_emploee_management_select"]);
	var main_tpl=instance.get_remodal_emploee_management_select;
	var main_title="<?php echo __("従業員管理"); ?>";
	var message=$(main_tpl);
	remodalAlert("normal_600",main_title,message,params);
}

var attendanceSetting=function(ymd){

	var mainView=function(information){
	
		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_attendance_situation"]);
		var main_html=$(instance.get_remodal_attendance_situation);
		return deferred.resolve(main_html,information);
	}

	var setCalendar=function(main_html,information){

		var deferred=$.Deferred();
		var calender_input=main_html.find("input[data-type=\"attendance-date-calendar\"]");

		setCalendarForInput.call(calender_input,{
		
			"onSelect":function(selectedDate){
			
				var calendar=this;
				var ymd=replaceToYmd(selectedDate);

				main_html  =null;
				information=null;
				attendanceSetting(ymd);
			}
		},{

			"minDate":"-12m",
			"maxDate":"+0d",
		});

		return deferred.resolve(main_html,information);
	}

	var viewModal=function(main_html,information){

		var deferred=$.Deferred();

		var main_title="<?php echo __("勤怠管理"); ?>"
		var message=main_html;
		remodalAlert("normal_1200",main_title,message,{

			"remodal-close":function(e,type){

				if(type=="end") return;
			},
			"attendance-save":function(e,type){
			
				if(type=="start") return;

				var remodal=this;
				var values={};
				var data_rows=main_html.find("div[data-type=\"row-top\"]");
				var attendance=information["attendance"];
				data_rows.each(function(){
				
					var data_row=$(this);
					var employee_id=data_row.attr("data-staff-id");
					current_attendance=attendance[employee_id];

					var attendance_enter_h=data_row.find("select[data-type=\"attendance-enter-h\"]").val();
					var attendance_enter_m=data_row.find("select[data-type=\"attendance-enter-m\"]").val();
					var attendance_leave_h=data_row.find("select[data-type=\"attendance-leave-h\"]").val();
					var attendance_leave_m=data_row.find("select[data-type=\"attendance-leave-m\"]").val();
					var rest_min=data_row.find("input[type=number][data-type=\"attendance-resttime\"]").val();
					var remarks=data_row.find("input[data-type=\"attendance-remarks\"]").val().trim();
					var is_dayoff=!data_row.find("input[type=checkbox][data-type=\"attendance-dayoff\"]").is(":checked");

					var is_edit=false;
					if(!current_attendance) is_edit=true;
					if(!is_edit && current_attendance["enter_hour"]!=attendance_enter_h)      is_edit=true;
					if(!is_edit && current_attendance["enter_min"] !=attendance_enter_m)      is_edit=true;
					if(!is_edit && current_attendance["leave_hour"]   !=attendance_leave_h)   is_edit=true;
					if(!is_edit && current_attendance["leave_min"]   !=attendance_leave_m)    is_edit=true;
					if(!is_edit && ((is_dayoff?true:false)!=current_attendance["is_dayoff"])) is_edit=true;
					if(!is_edit && remarks!=current_attendance["remarks"])                    is_edit=true;
					if(!is_edit && Math.max(current_attendance["rest_min"],0)!=Math.max(rest_min,0)) is_edit=true;

					if(!is_edit) return;

					if(values[employee_id]==undefined) values[employee_id]={};
					values[employee_id]["is_dayoff"]=is_dayoff?1:0;
					values[employee_id]["enter_hour"]   =attendance_enter_h;
					values[employee_id]["enter_min"]    =attendance_enter_m;
					values[employee_id]["leave_hour"]   =attendance_leave_h;
					values[employee_id]["leave_min"]    =attendance_leave_m;
					values[employee_id]["rest_min"]     =Math.max(rest_min,0);
					values[employee_id]["remarks"]=remarks;
				});

				if(1>Object.values(values)){
				
					alert("<?php echo __('変更された項目は存在しません'); ?>");
					return;
				}

				var params={};
				params["values"]=values;
				params["date"]  =ymd;
				apiGeoRequests.saveAttendance(params,function(status,res){

					if(!status && res["type"]==0){

						alert('<?php echo __("通信状況が安定しておりません"); ?>');
						return;
					}

					if(!status && res["type"]==1){

						alert(res["message"]);
						return;
					}

					alert("<?php echo __("設定した内容が正常に登録されました"); ?>");

					remodal.close(null,function(){

						make(ymd,res["data"]);
					});
				});
			},
			"attendance-dayoff-div":function(e,type){

				if(type=="start") return;
			},
			"attendance-dayoff":function(e,type){

				if(type=="start") return;

				var target=$(e.target);
				var is_checked=target.is(":checked");
				target.prop("checked",(is_checked)?false:true);
				is_checked=target.is(":checked");

				var data_row=target.parents("div[data-type=\"row-top\"]");
				data_row.find("select").propDisable(is_checked?false:true);
				data_row.find("input[type=text]").propDisable(is_checked?false:true);
				data_row.find("input[type=number]").propDisable(is_checked?false:true);
			}

		});

		return deferred.resolve(main_html,information);
	}

	var getInformations=function(ymd,information){

		var deferred=$.Deferred();
		if(information!=undefined) return deferred.resolve(information);

		var params={};
		params["day"]=ymd;
		apiGeoRequests.getMemberList(params,function(status,res){

			if(!status) return deferred.reject(res["message"]);
			var information=res["data"];
			deferred.resolve(information);
		});

		return deferred.promise();
	}
	
	var setCalendarDefault=function(main_html,information){

		var deferred=$.Deferred();

		var calender_input=main_html.find("input[data-type=\"attendance-date-calendar\"]");
		var locale_date=replaceToLocaleFormatWithYmd(ymd);
		calender_input.val(locale_date);

		return deferred.resolve(main_html,information);
	}

	var setTimeSelects=function(enter_h,enter_m,leave_h,leave_m){
	
		var target=this;
		var hours={};
		for(var i=0;i<24;i++) hours[(i+"")]=(i+"");
		//>
		
		var mins={};
		for(var i=0;i<60;i++) mins[(i+"")]=(i+"");
		//>

		var select_enter_h=target.find("select[data-type=\"attendance-enter-h\"]");
		var select_enter_m=target.find("select[data-type=\"attendance-enter-m\"]");
		var select_leave_h=target.find("select[data-type=\"attendance-leave-h\"]");
		var select_leave_m=target.find("select[data-type=\"attendance-leave-m\"]");

		setMenu.call(select_enter_h,hours);
		setMenu.call(select_enter_m,mins);
		setMenu.call(select_leave_h,hours);
		setMenu.call(select_leave_m,mins);

		select_enter_h.val(enter_h);
		select_enter_m.val(enter_m);
		select_leave_h.val(leave_h);
		select_leave_m.val(leave_m);
	}

	var setInformations=function(main_html,information){

		var deferred=$.Deferred();

		var instance=TPL.getInstance(["remodal_attendance_situation_child"]);
		var child_tpl=instance.get_remodal_attendance_situation_child;
		var fragment=document.createDocumentFragment();
		var add_target=main_html.find("div[data-type=\"attendance-list\"]");
		var members=information["members"];
		var attendance_records=information["attendance"];
		var registerd_records =information["registerd"];

		var child_html;
		var attendance;
		var select_h;
		var select_m;
		var enter_h;
		var enter_m;
		var is_dayoff;
		var is_checked;
		var checkbox;
		var restmin;
		var remarks;
		for(var employee_id in members){

			attendance=(attendance_records[employee_id]==undefined)?false:attendance_records[employee_id];
			child_html=$(instance.replaceTPL(child_tpl,{

				"staff"    :members[employee_id],
				"registerd":!!attendance?registerd_records[attendance["final_employee_entered"]]:'<?php echo __("記録無"); ?>',
				"staff_id" :employee_id,
				"hour"     :!!attendance?attendance["work_time"]["hour"]+"":"0",
				"min"      :!!attendance?attendance["work_time"]["min"]+"" :"0"
			}));

			is_dayoff=(!attendance || !attendance["is_dayoff"])?true:false;
			checkbox=child_html.find("input[type=checkbox][data-type=\"attendance-dayoff\"]");
			checkbox.prop("checked",is_dayoff);

			is_checked=checkbox.is(":checked");
			child_html.find("select").propDisable(is_checked?false:true);

			remarks=child_html.find("input[type=text]").propDisable(is_checked?false:true);
			if(!!attendance) remarks.val(attendance["remarks"]);

			restmin=child_html.find("input[type=number]").propDisable(is_checked?false:true);
			if(!!attendance && attendance["rest_min"]>0) restmin.val(attendance["rest_min"]);

			enter_h=(!!attendance?attendance["enter_hour"]:0)+"";
			enter_m=(!!attendance?attendance["enter_min"] :0)+"";
			leave_h=(!!attendance?attendance["leave_hour"]:0)+"";
			leave_m=(!!attendance?attendance["leave_min"] :0)+"";
			setTimeSelects.call(child_html,enter_h,enter_m,leave_h,leave_m);
			fragment.appendChild(child_html.get(0));
		}

		add_target.append(fragment);

		return deferred.resolve(main_html,information);
	}

	var make=function(ymd,information){

		getInformations(ymd,information).
		then(mainView).
		then(setCalendar).
		then(setCalendarDefault).
		then(setInformations).
		then(viewModal).
		done(function(main_html,information){
		
		}).
		fail(function(){
		
		});
	}

	make(ymd);
}

var reloadSchedule=function(){

	var day_tops=window["schedule_top_inner"].children("div[data-type=\""+TYPE_DAYTOP+"\"]:visible");
	var day_top=day_tops.eq(0);
	var ymd=day_top.attr("data-time");
	var base_url="<?php echo "K9Site".DS."index".DS; ; ?>";
	base_url+=ymd;
	location.href=base_url;
}

var afterCheckoutSettings=function(reservation_hash,informations){

	var instance=TPL.getInstance(["remodal_aftercheckout"]);

	var prices=informations["price"];
	var hotel_cash_price=prices["hotel"]["cash"];
	var hotel_card_price=prices["hotel"]["card"];
	var order_cash_price=prices["order"]["cash"];
	var order_card_price=prices["order"]["card"];
	var hotel_total=hotel_cash_price+hotel_card_price;
	var order_total=order_cash_price+order_card_price;

	var tax=prices["tax"];
	var total=hotel_total+order_total;
	var cash_total=hotel_cash_price+order_cash_price;
	var grand_cash_total=cash_total+(cash_total*tax/100);
	var main_tpl=instance.replaceTPL(instance.get_remodal_aftercheckout,{

		"hotel_fee"  :Number(hotel_total).toLocaleString(),
		"other_cash_fee":Number(order_cash_price).toLocaleString(),
		"other_card_fee":Number(order_card_price).toLocaleString(),
		"cash_total" :Number(cash_total).toLocaleString(),
		"grand_cash_total":Number(grand_cash_total).toLocaleString(),
		"total"      :Number(total).toLocaleString(),
		"tax"        :tax+"",
		"grand_total":Number(total+(total*tax/100)).toLocaleString()
	});

	var main_title="<?php echo __("各種項目設定"); ?>";
	var main_html=$(main_tpl);
	remodalAlert("normal_600",main_title,main_html,{

		"remodal-close":function(e,type){

			if(type=="end") return;
			reloadSchedule();
		},
		"howto-payment":function(e,type){
		
			if(type=="start") return;

			var remodal=this;
			remodal.close(null,function(){

				viewCheckoutPayment(reservation_hash,function(status){

					afterCheckoutSettings(reservation_hash,informations);
				});
			});
		},
		"price-detail":function(e,type){

			if(type=="start") return;

			var remodal=this;
			remodal.close(null,function(){

				priceTotal(reservation_hash,function(){

					var remodal=this;
					remodal.close(null,function(){

						afterCheckoutSettings(reservation_hash,informations);
					});
				});
			});
		},
	});
}

var balanceSetting=function(ymd){

	var params={};
	params["yes"]=function(){};
	params["no"]   =params["yes"];
	params["close"]=params["yes"];

	params["select-outputpayment"]=function(e,status){

		if(status=="start") return;
		outputPayment(ymd);
	}

	params["select-balance"]=function(e,status){

		if(status=="start") return;
		balanceEdit();
	}

	var instance=TPL.getInstance(["remodal_outputpayment_select"]);
	var main_tpl=instance.get_remodal_outputpayment_select;
	var main_title="<?php echo __("財務管理"); ?>";
	var message=$(main_tpl);
	remodalAlert("normal_600",main_title,message,params);
}

var balanceEdit=function(){

	var mainView=function(information){
	
		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_balance_situation"]);
		var main_html=$(instance.replaceTPL(instance.get_remodal_balance_situation,{
		
			"staff":"<?php echo $first_name; ?>"
		}));

		return deferred.resolve(main_html,information);
	}

	var viewModal=function(main_html,information){

		var deferred=$.Deferred();

		var main_title="<?php echo __("各種残高修正"); ?>"
		var message=main_html;
		remodalAlert("normal_1200",main_title,message,{

			"remodal-close":function(e,type){

				if(type=="end") return;
			},
			"balance-save":function(e,type){
			
				if(type=="start") return;

				var remodal=this;
				var target=$(e.target);
				var cash=main_html.find("div[data-type=\"data-cash\"]");
				var bank=main_html.find("div[data-type=\"data-bank\"]");
				var cash_val=cash.find("input[type=number]").val().trim();
				var bank_val=bank.find("input[type=number]").val().trim();

				var params={"data":{}};
				if(bank_val.length>0) params["data"]["bank"]=Math.max(bank_val,0);
				if(cash_val.length>0) params["data"]["cash"]=Math.max(cash_val,0);

				apiGeoRequests.balanceSubscribe(params,function(status,res){
		
					if(!status) return deferred.reject(res["message"]);

					alert("<?php echo __("設定した内容が正常に登録されました"); ?>");

					remodal.close(null,function(){

						make(res["data"]);
					});
				});
			},
		});

		return deferred.resolve(main_html,information);
	}

	var getInformations=function(information){

		var deferred=$.Deferred();
		if(information!=undefined) return deferred.resolve(information);

		var params={};
		params["month"]=2;
		apiGeoRequests.getBalanceHistory(params,function(status,res){

			if(!status) return deferred.reject(res["message"]);
			var information=res["data"];
			deferred.resolve(information);
		});

		return deferred.promise();
	}

	var getFragment=function(data){

		var instance=TPL.getInstance(["remodal_balance_row"]);
		var fragment=document.createDocumentFragment();
		var child_tpl=instance.get_remodal_balance_row;

		var child_html;
		for(var i in data){

			child_html=$(instance.replaceTPL(child_tpl,{
			
				"date" :data[i]["data"]["enter_time"],
				"price":(data[i]["data"]["cash"]+""),
				"staff":data[i]["employee"]["name"]
			}));

			fragment.appendChild(child_html.get(0));
		}

		return fragment;
	}

	var setCashInformations=function(main_html,information){

		var deferred=$.Deferred();

		var data_top=main_html.find("div[data-type=\"data-cash\"]");
		var add_target=data_top.find("div[data-type=\"data-row-top\"]");
		var cash_info=information["cash"];
		var fragment=getFragment(cash_info);

		add_target.append(fragment);
		return deferred.resolve(main_html,information);
	}

	var setBankInformations=function(main_html,information){

		var deferred=$.Deferred();

		var data_top=main_html.find("div[data-type=\"data-bank\"]");
		var add_target=data_top.find("div[data-type=\"data-row-top\"]");
		var bank_info=information["bank"];

		var fragment=getFragment(bank_info);
		add_target.append(fragment);
		return deferred.resolve(main_html,information);
	}

	var make=function(information){

		getInformations(information).
		then(mainView).
		then(setBankInformations).
		then(setCashInformations).
		then(viewModal).
		done(function(main_html,information){
		
		}).
		fail(function(){
		
		});
	}

	make();
}

var agentList=function(agency_id){

	var getInformations=function(){

		var deferred=$.Deferred();

		var params={};
		apiGeoRequests.getAgentInformation(params,function(status,res){

			if(!status) return deferred.reject(res);
			var informations=res["data"]["data"];
			var menus=res["data"]["menu"];
			deferred.resolve(informations,menus);
		});

		return deferred.promise();
	}

	var setLayout=function(informations,menus){

		var deferred=$.Deferred();
		var instance=TPL.getInstance("agency_main");
		var main_tpl=instance.get_agency_main;
		var main_html=$(main_tpl);
		return deferred.resolve(main_html,informations,menus);
	}

	var setDataTabFragment=function(informations,agency_type_ids,agency_menus,main_fragment){

		if(1>agency_type_ids.length) return main_fragment;

		var agency_type_id=agency_type_ids.shift();
		var fn=arguments.callee;
		if(informations[agency_type_id]==undefined) return fn(informations,agency_type_ids,agency_menus,main_fragment);

		var information=informations[agency_type_id];
		var instance=TPL.getInstance(["agency_menu_row","agency_table"]);
		var table_tpl=instance.get_agency_table;
		var row_tpl  =instance.get_agency_menu_row;
		var agency_name=agency_menus["agents"][agency_type_id];
		var salesources=agency_menus["salesources"];
		var table_html=$(instance.replaceTPL(table_tpl,{ "agency_type_id":agency_type_id,"agency_name":agency_name }));
		var fragment=document.createDocumentFragment();
		var tbody=table_html.find("tbody[data-type=\"data-tbody\"]");

		var row_html;
		var agencyname;
		var agencyvtno
		var agencysalesource;
		var agencyregisterdate;
		var agencyaddress;

		for(var agency_id in information){

			row_html=$(instance.replaceTPL(row_tpl,{
			
				"agency_id":agency_id,
				"staff"    :information[agency_id]["staff"]["name"],
			}));

			agencyname =row_html.find("input[type=text][data-type=\"agency-name\"]");
			agencyvtno =row_html.find("input[type=text][data-type=\"agency-vtno\"]");

			agencyregisterdate=row_html.find("input[type=text][data-type=\"agency-registerdate\"]");
			agencyaddress=row_html.find("input[type=text][data-type=\"agency-address\"]");
			agencysalesource=row_html.find("select[data-type=\"agency-salesource\"]");
			setMenu.call(agencysalesource,salesources);
			agencysalesource.val(information[agency_id]["agency"]["salesource_id"]);

			agencyname.val(information[agency_id]["agency"]["name"]);
			agencyvtno.val(information[agency_id]["agency"]["vtno"]);
			agencyregisterdate.val(information[agency_id]["agency"]["register_date"]);
			agencyaddress.val(information[agency_id]["agency"]["address"]);

			setCalendarForInput.call(agencyregisterdate,{
			
				"onSelect":function(selectDate){
	
					var calendar=$(this);
					var date_split=dateSplitLocaleSaparator(selectDate);
					var ymd=getYmdWithLocaleSplitdates(date_split);
				}
	
			},{ "minDate":"-12m","maxDate":"+0d" });

			tbody.append(row_html);
		}

		main_fragment.append(table_html.get(0));
		return fn(informations,agency_type_ids,agency_menus,main_fragment);
	}

	var setInformations=function(main_html,informations,menus){

		var deferred=$.Deferred();
		var menu_ids=Object.keys(menus["agents"]);
		var main_fragment=document.createDocumentFragment();
		setDataTabFragment(informations,menu_ids,menus,main_fragment);
		main_html.find("div[data-type=\"data-table-top\"]").append(main_fragment);
		return deferred.resolve(main_html,informations);
	}

	var viewFoodRemodal=function(main_html,informations){

		var deferred=$.Deferred();

		var message=main_html;
		var main_title="<?php echo __("企業情報"); ?>";

		var params={};
		params["yes"]=function(){};
		params["no"]=function(){};
		params["close"]=function(){};

		params["save-items"]=function(e,type){

			if(type=="start") return;

			var target=$(e.target);
			var menu_rows=main_html.find("tr[data-type=\"data-menu-row\"]");

			var remove_items=[];
			var edit_items=[];
			menu_rows.each(function(){

				var data_row=$(this);
				var agency_type_top=data_row.parents("div[data-type=\"data-agency-top\"]");
				var agency_type_id=agency_type_top.attr("data-agency-type-id");
	
				var agency_id         =data_row.attr("data-id");
				var agencyname        =data_row.find("input[type=text][data-type=\"agency-name\"]");
				var agencyvtno        =data_row.find("input[type=text][data-type=\"agency-vtno\"]");
				var agencyaddress     =data_row.find("input[type=text][data-type=\"agency-address\"]");
				var agencyremove      =data_row.find("input[type=checkbox][data-type=\"agency-remove\"]");
				var agencyregisterdate=data_row.find("input[type=text][data-type=\"agency-registerdate\"]");
				var agency_salesource =data_row.find("select[data-type=\"agency-salesource\"]");

				if(!agencyremove.is(":checked")) remove_items.push(agency_id);

				var agencyname_val        =agencyname.val();
				var agencyvtno_val        =agencyvtno.val();
				var agencyaddress_val     =agencyaddress.val();
				var agencyregisterdate_val=agencyregisterdate.val();
				var agency_salesource_val =agency_salesource.val();

				if(1>agencyname_val.length)         return;
				if(1>agencyregisterdate_val.length) return;

				var is_diffrence=false;
				if(informations[agency_type_id][agency_id]["agency"]["name"]!=agencyname_val) is_diffrence=true;
				if(!is_diffrence && informations[agency_type_id][agency_id]["agency"]["vtno"]!=agencyvtno_val) is_diffrence=true;
				if(!is_diffrence && informations[agency_type_id][agency_id]["agency"]["address"]!=agencyaddress_val) is_diffrence=true;
				if(!is_diffrence && informations[agency_type_id][agency_id]["agency"]["register_date"]!=agencyregisterdate_val) is_diffrence=true;
				if(!is_diffrence && informations[agency_type_id][agency_id]["agency"]["salesource_id"]!=agency_salesource_val)  is_diffrence=true;
				if(!is_diffrence) return;

				edit_items.push({
				
					"id"           :agency_id,
					"name"         :agencyname_val,
					"vtno"         :agencyvtno_val,
					"address"      :agencyaddress_val,
					"register_date":agencyregisterdate_val,
					"salesource_id":agency_salesource_val
				});
			});

			var remove_items_length=remove_items.length;
			var edit_items_length  =edit_items.length;
			if(1>remove_items_length && 1>edit_items_length){

				alert("<?php echo __("変更された項目は存在しません"); ?>");
				return;
			}

			var params={"data":{}};
			if(remove_items_length>0) params["data"]["remove_items"]=remove_items;
			if(edit_items_length>0)   params["data"]["edit_items"]  =edit_items;
			apiGeoRequests.agentListSubscribe(params,function(status,res){

				if(!status){
				
					alert(res["message"]);
					return;
				}

				alert("<?php echo __("設定した内容が正常に登録されました"); ?>");
				informations=res["data"];
				if(1>remove_items_length) return;

				var selectors=[];
				for(var i in remove_items) selectors.push("[data-type=\"data-menu-row\"][data-id=\""+remove_items[i]+"\"]");
				main_html.find(selectors.join(",")).remove();
			});
		}

		params["new-items"]=function(e,type){

			if(type=="start") return;
			var remodal=this;
			remodal.close(null,function(){

				addAgent();
			});
			return;
		}

		params["agency-detail"]=function(e,type){

			if(type=="start") return;
			var remodal=this;
			var target=$(e.target);
			var agency_type_top=target.parents("div[data-type=\"data-agency-top\"]");
			var agency_id=target.parents("tr[data-type=\"data-menu-row\"]").attr("data-id");
			var agency_type_id=agency_type_top.attr("data-agency-type-id");
			remodal.close(null,function(){

				addAgent(agency_id,agency_type_id);
			});
			return;
		}

		params["agency-remove"]=function(e,type){

			if(type=="start") return;
			var remodal=this;
			var target=$(e.target);
			var is_checked=target.is(":checked");
			target.prop("checked",(is_checked)?false:true);
			is_checked=target.is(":checked");
			return;
		}

		remodalAlert("normal_1200",main_title,message,params);
		return deferred.resolve(main_html);
	}

	var setActive=function(main_html){

		var deferred=$.Deferred();
		if(agency_id==undefined) return deferred.resolve(main_html);
		return deferred.resolve(main_html);
	}

	getInformations().
	then(setLayout).
	then(setInformations).
	then(viewFoodRemodal).
	then(setActive).
	done(function(){
	
	}).
	fail(function(res){ alert(res["message"]); });
}

var extraOrderCharge=function(ymd){

	var mainView=function(information){
	
		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_extraorder_situation"]);
		var main_html=$(instance.get_remodal_extraorder_situation);
		return deferred.resolve(main_html,information);
	}

	var setGroups=function(main_html,information){

		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_extraorder_group"]);
		var group_tpl=instance.get_remodal_extraorder_group;
		var fragment=document.createDocumentFragment();
		var group=information["menu"]["group"];
		var add_target=main_html.find("div[data-type=\"extraorder-list\"]");
		var group_html;
		var enter_date;
		var title;

		for(var group_id in group){
		
			title="<?php echo __('注文ID'); ?>"+":"+group_id;
			enter_date=group[group_id];
			group_html=$(instance.replaceTPL(group_tpl,{ "group_id":group_id,"title":title,"enter_date":enter_date }));
			fragment.appendChild(group_html.get(0));
		}

		add_target.append(fragment);
		return deferred.resolve(main_html,information);
	}

	var setCalendar=function(main_html,information){

		var deferred=$.Deferred();
		var calender_input=main_html.find("input[data-type=\"extraorder-date-calendar\"]");

		setCalendarForInput.call(calender_input,{
		
			"onSelect":function(selectedDate){
			
				var calendar=this;
				var ymd=replaceToYmd(selectedDate);
				var remodal=main_html.data("remodal");
				remodal.close(null,function(){ extraOrderCharge(ymd); });
			}

		},{ "minDate":"-60d" });

		return deferred.resolve(main_html,information);
	}

	var getInformations=function(ymd,informations){

		var deferred=$.Deferred();
		if(informations!=undefined) return deferred.resolve(informations);

		var params={};
		params["ymd"]=ymd;
		apiGeoRequests.getExtraInformations(params,function(status,res){
		
			var informations=res["data"];
			deferred.resolve(informations);
		});

		return deferred.promise();
	}

	var setCalendarDefault=function(main_html,information){

		var deferred=$.Deferred();

		var calender_input=main_html.find("input[data-type=\"extraorder-date-calendar\"]");
		var locale_date=replaceToLocaleFormatWithYmd(ymd);
		calender_input.val(locale_date);
		return deferred.resolve(main_html,information);
	}

	var setInformations=function(main_html,information){

		var deferred=$.Deferred();
		var order=information["data"]["order"];

		var food       =order["<?php echo K9MasterFood::$CATEGORY_FOOD; ?>"];
		var beverage   =order["<?php echo K9MasterBeverage::$CATEGORY_DRINK; ?>"];
		var roomservice=order["<?php echo K9MasterRoomservice::$CATEGORY_ROOMSERVICE; ?>"];
		var tobacco    =order["<?php echo K9MasterTobacco::$CATEGORY_TOBACCO; ?>"];

		var data_list_html=main_html.find("div[data-type=\"extraorder-list\"]");

		addRowInformations.call(data_list_html,food,information["menu"]);
		addRowInformations.call(data_list_html,beverage,information["menu"]);
		addRowInformations.call(data_list_html,roomservice,information["menu"]);
		addRowInformations.call(data_list_html,tobacco,information["menu"]);
		return deferred.resolve(main_html,information);
	}

	var setAddRowForGroups=function(main_html,information){

		var deferred=$.Deferred();

		var groups=main_html.find(":not(div[data-group-id=\"0\"])").find("div[data-type=\"extraorder-group-top\"]");
		groups.each(function(){
		
			var self=$(this);
			var group_id=self.parents("div[data-type=\"extraorder-group\"]").attr("data-group-id");
			var add_html=addRowForEachGroup(group_id,information["menu"]);
			self.append(add_html);
		});

		return deferred.resolve(main_html,information);
	}

	var setSelectEvents=function(main_html,information){

		var deferred=$.Deferred();

		var extraorder_maincategory=main_html.find("select[data-type=\"extraorder-maincategory\"]");
		var extraorder_category=main_html.find("select[data-type=\"extraorder-category\"]");
		var extraorder_item    =main_html.find("select[data-type=\"extraorder-item\"]");

		extraorder_maincategory.change(function(e){
		
			var target=$(this);
			var row_top            =target.parents("div[data-type=\"row-top\"]");
			var grpup_id           =row_top.attr("data-group-id");
			var initial_order_id   =row_top.attr("data-initial-order-id");
			var initial_category_id=row_top.attr("data-initial-category-id");

			var type=target.val();
			var categories=information["menu"]["categories"]["menu"][type];
			var category_html=row_top.find("select[data-type=\"extraorder-category\"]");
			var item_html=row_top.find("select[data-type=\"extraorder-item\"]");
			var aliases=information["menu"]["categories"]["aliases"];

			setMenu.call(category_html.empty(),categories);

			var category_id=category_html.val();
			var aliase=aliases[type][category_id];
			var item_menu=information["menu"]["menus"][type][aliase] || {};
			setMenu.call(item_html.empty(),item_menu);
		});

		extraorder_category.change(function(e){

			var target=$(this);
			var row_top=target.parents("div[data-type=\"row-top\"]");
			var grpup_id           =row_top.attr("data-group-id");
			var initial_order_id   =row_top.attr("data-initial-order-id");
			var initial_category_id=row_top.attr("data-initial-category-id");
			var extraorder_maincategory=row_top.find("select[data-type=\"extraorder-maincategory\"]");

			var category_id=target.val();
			var type=information["menu"]["categories"]["types"][category_id];
			setMenu.call(extraorder_maincategory.empty(),information["menu"]["main_categories"]);
			extraorder_maincategory.val(type);

			var item_html=row_top.find("select[data-type=\"extraorder-item\"]");
			var aliases=information["menu"]["categories"]["aliases"];

			var aliase=aliases[type][category_id];
			var item_menu=information["menu"]["menus"][type][aliase] || {};
			setMenu.call(item_html.empty(),item_menu);
		});

		return deferred.resolve(main_html,information);
	}

	var addRowInformations=function(data,menus){
	
		var target=this;
		var data_list=target.find("div[data-type=\"extraorder-list\"]");

		var instance=TPL.getInstance(["remodal_extraorder_situation_child","remodal_extraorder_situation_child_add"]);
		var child_tpl=instance.get_remodal_extraorder_situation_child;
		var child_html;
		var group_html;
		var row_data;
		var type;
		var maincateogry_html;
		var category_html;
		var item_html;
		var cashtype_html;
		var type;
		var category_id;
		var aliase;
		var master_id;
		var cashtype_id;
		var count;
		var count_html;
		var remark;
		var remark_html;
		var staff;
		var order_id;
		var elements;

		var child_add_html;
		var child_add_tpl =instance.get_remodal_extraorder_situation_child_add;
	
		for(var group_id in data){
		
			group_html=target.find("div[data-group-id=\""+group_id+"\"]").find("div[data-type=\"extraorder-group-top\"]");

			for(var category_id in data[group_id]){
			
				for(var order_id in data[group_id][category_id]){

					type=data[group_id][category_id][order_id]["category"]["type"];
					staff=data[group_id][category_id][order_id]["employee"]["name"];

					count      =data[group_id][category_id][order_id]["order"]["count"];
					type       =data[group_id][category_id][order_id]["category"]["type"];
					category_id=data[group_id][category_id][order_id]["category"]["id"];
					aliase     =data[group_id][category_id][order_id]["category"]["aliase"];
					master_id  ="_"+data[group_id][category_id][order_id]["master"]["id"];
					cashtype_id=data[group_id][category_id][order_id]["order"]["cash_type_id"];
					remarks    =data[group_id][category_id][order_id]["order"]["remarks"];

					child_html=$(instance.replaceTPL(child_tpl,{ "type":type,"data_id":order_id,"staff":staff,"category_id":category_id,"group_id":group_id }));
					elements=getElements.call(child_html);

					setMenu.call(elements["maincateogry_html"].empty(),menus["main_categories"]);
					elements["maincateogry_html"].val(type);

					setMenu.call(elements["category_html"].empty(),menus["categories"]["menu"][type]);
					elements["category_html"].val(category_id);

					setMenu.call(elements["item_html"].empty(),menus["menus"][type][aliase]);
					elements["item_html"].val(master_id);

					setMenu.call(elements["cashtype_html"].empty(),menus["cashtype"]);
					elements["cashtype_html"].val(cashtype_id);

					elements["count_html"].val(count);
					elements["remark_html"].val(remarks);

					group_html.append(child_html);
				}
			}
		}
	}

	var addRowForEachGroup=function(group_id,menus){

		var instance      =TPL.getInstance(["remodal_extraorder_situation_child_add"]);
		var child_add_tpl =instance.get_remodal_extraorder_situation_child_add;
		var child_add_html=$(instance.replaceTPL(child_add_tpl,{ "staff":"<?php echo $first_name; ?>","group_id":group_id }));
		var elements=getElements.call(child_add_html);

		for(var first_main_category in menus["main_categories"]) break;
		for(var category_id in menus["categories"]["menu"][first_main_category]) break;
		for(var first_sub_category in menus["menus"][first_main_category]) break;

		var maincategories=menus["main_categories"];
		var subcategories =menus["categories"]["menu"][first_main_category];
		var aliase=menus["categories"]["aliases"][first_main_category][category_id];
		var items         =menus["menus"][first_main_category][aliase];

		setMenu.call(elements["maincateogry_html"].empty(),maincategories);
		setMenu.call(elements["category_html"].empty(),subcategories);
		setMenu.call(elements["item_html"].empty(),items);
		setMenu.call(elements["cashtype_html"].empty(),menus["cashtype"]);
		return child_add_html;
	}

	var setAddLayout=function(main_html,information){

		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_extraorder_add_group","remodal_extraorder_situation_child_add"]);
		var child_add_group_tpl=instance.get_remodal_extraorder_add_group;
		var child_add_group_html=$(instance.replaceTPL(child_add_group_tpl,{
		
			"group_id"  :"0",
			"title"     :"<?php echo __("新規注文追加"); ?>",
			"enter_date":"-"
		}));

		var child_add_tpl =instance.get_remodal_extraorder_situation_child_add;
		var child_add_html=$(instance.replaceTPL(child_add_tpl,{
		
			"staff"   :"<?php echo $first_name; ?>",
			"group_id":"0"
		}));

		var child_add_target=child_add_group_html.find("div[data-type=\"extraorder-group-top\"]");
		child_add_target.append(child_add_html);

		var add_target=main_html.find("div[data-type=\"extraorder-add-group\"]");
		add_target.prepend(child_add_group_html);
		return deferred.resolve(main_html,information);
	}

	var getElements=function(){
	
		var top=this;
		var maincateogry_html=top.find("select[data-type=\"extraorder-maincategory\"]");
		var category_html    =top.find("select[data-type=\"extraorder-category\"]");
		var item_html        =top.find("select[data-type=\"extraorder-item\"]");
		var cashtype_html    =top.find("select[data-type=\"extraorder-cashtype\"]");
		var count_html       =top.find("input[type=number][data-type=\"extraorder-count\"]");
		var remark_html      =top.find("input[type=text][data-type=\"extraorder-remarks\"]");
		var checkbox         =top.find("input[type=checkbox][data-type=\"extraorder-status\"]");

		return {
		
			"maincateogry_html":maincateogry_html,
			"category_html"    :category_html,
			"item_html"        :item_html,
			"cashtype_html"    :cashtype_html,
			"count_html"       :count_html,
			"remark_html"      :remark_html,
			"checkbox"         :checkbox
		}
	}

	var setAddInformations=function(main_html,information){

		var deferred=$.Deferred();
		var add_group=main_html.find("div[data-group-id=\"0\"]");
		var add_child_html=add_group.find("div[data-group-id=\"0\"]");

		var menus=information["menu"];

		var elements=getElements.call(add_child_html);

		setMenu.call(elements["maincateogry_html"].empty(),menus["main_categories"]);

		var type=elements["maincateogry_html"].val();
		setMenu.call(elements["category_html"].empty(),menus["categories"]["menu"][type]);

		var category_id=elements["category_html"].val();
		var aliase=menus["categories"]["aliases"][type][category_id];
		setMenu.call(elements["item_html"].empty(),menus["menus"][type][aliase]);

		setMenu.call(elements["cashtype_html"].empty(),menus["cashtype"]);
		var first_cashtype_option=elements["cashtype_html"].find("option").eq(0);
		var first_cashtype_option_id=first_cashtype_option.val();
		elements["cashtype_html"].val(first_cashtype_option_id);

		return deferred.resolve(main_html,information);
	}

	var setGroupTitle=function(main_html,information){

		var deferred=$.Deferred();
		var order=information["data"]["order"];
		var price;
		var count;

		var cost={};
		for(var type in order){
		
			for(var group_id in order[type]){
			
				if(cost[group_id]==undefined) cost[group_id]=0;
				for(var category_id in order[type][group_id]){
				
					for(var order_id in order[type][group_id][category_id]){
					
						price=parseFloat(order[type][group_id][category_id][order_id]["order"]["price"]);
						count=order[type][group_id][category_id][order_id]["order"]["count"];
						cost[group_id]+=(price*count);
					}
				}
			}
		}

		var group_top_html;
		var span_total_cost_html;
		for(var group_id in cost){

			group_top_html=main_html.find("div[data-type=\"extraorder-group\"][data-group-id=\""+group_id+"\"]");
			span_total_cost_html=group_top_html.find("span[data-type=\"total-cost\"]");
			span_total_cost_html.text("【"+cost[group_id]+"$】");
		}

		return deferred.resolve(main_html,information,cost);
	}

	var setTotalCost=function(main_html,information,cost){

		var deferred=$.Deferred();

		var total_cost=0;
		for(var group_id in cost) total_cost+=cost[group_id];
		main_html.find("span[data-type=\"main-total-cost\"]").text(total_cost);

		return deferred.resolve(main_html,information);
	}

	var viewModal=function(main_html,information){

		var deferred=$.Deferred();

		var main_title="<?php echo __("外部注文"); ?>"
		var message=main_html;
		var remodal=remodalAlert("normal_1200",main_title,message,{
		
			"issue-invoice":function(e,type){

				if(type=="start") return;
				var target=$(e.target);
				var group_id=target.parents("div[data-type=\"extraorder-group\"]").attr("data-group-id");

				var params={};
				params["order_id"]=group_id;
				apiGeoRequests.getInvoice(params,function(status,res){
				
					location.href=res["data"]["url"];
				});
			},
			"extraorder-save":function(e,type){
			
				if(type=="start") return;

				var remodal=this;
				var groups=main_html.find("div[data-type=\"extraorder-group\"]");
				var add_group_html=groups.filter("div[data-group-id=\"0\"]");
				var group_htmls=groups.filter(":not(div[data-group-id=\"0\"])");
				var add_group_child_htmls=add_group_html.find("div[data-type=\"row-top\"]");
				var current_orders=information["data"]["order"];

				var new_values=[];
				add_group_child_htmls.each(function(){
				
					var add_group_child_html=$(this);
					var elements=getElements.call(add_group_child_html);
					var count_val              =elements["count_html"].val().trim();
					if(1>count_val.length || 1>parseInt(count_val)) return;

					var select_maincategory_val=elements["maincateogry_html"].val();
					var select_category_val    =elements["category_html"].val();  
					var select_item_val        =elements["item_html"].val();
					var select_cashtype_val    =elements["cashtype_html"].val();
					var remark_val             =elements["remark_html"].val().trim();

					if(!select_item_val) return;
					select_item_val=select_item_val.replace("_","");

					new_values.push({

						"master_id":select_item_val,
						"type"     :select_maincategory_val,
						"category" :select_category_val,
						"count"    :count_val,
						"remarks"  :remark_val,
						"cash_type_id":select_cashtype_val
					});
				});

				var remove_values={};
				var edit_values  ={};
				var edit_new_values={};
				group_htmls.each(function(){
				
					var group_html=$(this);
					var group_id=group_html.attr("data-group-id");
					var child_htmls=group_html.find("div[data-type=\"row-top\"]:not([data-initial-order-id=\"0\"])");
					var child_new_htmls=group_html.find("div[data-type=\"row-top\"][data-initial-order-id=\"0\"]");

					child_new_htmls.each(function(){

						var child_new_html=$(this);
						var elements=getElements.call(child_new_html);

						var select_maincategory_val=elements["maincateogry_html"].val();
						var select_category_val    =elements["category_html"].val();  
						var select_item_val        =elements["item_html"].val();
						var select_cashtype_val    =elements["cashtype_html"].val();
						var count_val              =elements["count_html"].val().trim();
						var remark_val             =elements["remark_html"].val().trim();

						if(!select_item_val || 1>count_val.length || 1>parseInt(count_val)) return;
						select_item_val=select_item_val.replace("_","");

						if(edit_new_values[group_id]==undefined) edit_new_values[group_id]=[];

						edit_new_values[group_id].push({
						
							"master_id"   :select_item_val,
							"type"        :select_maincategory_val,
							"category"    :select_category_val,
							"count"       :count_val,
							"remarks"     :remark_val,
							"cash_type_id":select_cashtype_val
						});
					});

					child_htmls.each(function(){

						var child_html=$(this);
						var elements=getElements.call(child_html);
						var initial_category_id=child_html.attr("data-initial-category-id");
						var initial_order_id  =child_html.attr("data-initial-order-id");
						var initial_type       =child_html.attr("data-initial-type");
						var prev_values        =current_orders[initial_type][group_id][initial_category_id][initial_order_id];
						var prev_orders        =prev_values["order"];
						var prev_categories    =prev_values["category"];
						var prev_masters       =prev_values["master"];

						var select_maincategory_val=elements["maincateogry_html"].val();
						var select_category_val    =elements["category_html"].val();  
						var select_item_val        =elements["item_html"].val();
						var select_cashtype_val    =elements["cashtype_html"].val();
						var count_val              =elements["count_html"].val().trim();
						var remark_val             =elements["remark_html"].val().trim();
						var is_noremove            =elements["checkbox"].is(":checked");

						if(!select_item_val || 1>count_val.length || 1>parseInt(count_val) || !is_noremove){
						
							if(remove_values[group_id]==undefined) remove_values[group_id]={};
							if(remove_values[group_id][initial_type]==undefined) remove_values[group_id][initial_type]={};
							remove_values[group_id][initial_type][initial_order_id]={};
							remove_values[group_id][initial_type][initial_order_id]["initial_order_id"]   =initial_order_id;
							remove_values[group_id][initial_type][initial_order_id]["initial_category_id"]=initial_category_id;
							remove_values[group_id][initial_type][initial_order_id]["initial_type"]       =initial_type;
							return;
						}

						select_item_val=select_item_val.replace("_","");

						var is_edit=false;
						if(select_maincategory_val!=prev_categories["type"])             is_edit=true;
						if(!is_edit && select_category_val!=prev_categories["id"])       is_edit=true;
						if(!is_edit && select_item_val!=prev_masters["id"])              is_edit=true;
						if(!is_edit && select_cashtype_val!=prev_orders["cash_type_id"]) is_edit=true;
						if(!is_edit && count_val!=prev_orders["count"])                  is_edit=true;
						if(!is_edit && remark_val!=prev_orders["remarks"])               is_edit=true;
						if(!is_edit) return;

						if(edit_values[group_id]==undefined) edit_values[group_id]={};
						if(edit_values[group_id][initial_type]==undefined) edit_values[group_id][initial_type]={};
						edit_values[group_id][initial_type][initial_order_id]={};
						edit_values[group_id][initial_type][initial_order_id]["master_id"]          =select_item_val;
						edit_values[group_id][initial_type][initial_order_id]["type"]               =select_maincategory_val;
						edit_values[group_id][initial_type][initial_order_id]["category"]           =select_category_val;
						edit_values[group_id][initial_type][initial_order_id]["count"]              =count_val;
						edit_values[group_id][initial_type][initial_order_id]["remarks"]            =remark_val;
						edit_values[group_id][initial_type][initial_order_id]["initial_order_id"]   =initial_order_id;
						edit_values[group_id][initial_type][initial_order_id]["initial_category_id"]=initial_category_id;
						edit_values[group_id][initial_type][initial_order_id]["initial_type"]       =initial_type;
						edit_values[group_id][initial_type][initial_order_id]["cash_type_id"]       =select_cashtype_val;
					});
				});

				if(1>new_values.length && 1>Object.keys(edit_new_values) && 1>Object.keys(edit_values).length && 1>Object.keys(remove_values).length){

					alert("<?php echo __("変更された項目は存在しません"); ?>");
					return;
				}

				var params={"data":{}};
				params["data"]["new_items"]     =new_values;
				params["data"]["edit_items"]    =edit_values;
				params["data"]["edit_new_items"]=edit_new_values;
				params["data"]["remove_items"]  =remove_values;
				params["ymd"]=ymd;
				apiGeoRequests.orderItemSubscribe(params,function(status,res){

					if(!status){
					
						alert(res["message"]);
						return;
					}

					alert("<?php echo __("設定した内容が正常に登録されました"); ?>");
					remodal.close(null,function(){

						make(ymd,res["data"]["data"]);
					});
				});
			},
			"remodal-close":function(e,type){

				if(type=="end") return;
			},
			"extraorder-status":function(e,type){
			
				if(type=="end") return;

				var target=$(e.target);
				var is_checked=target.is(":checked");
				target.prop("checked",(is_checked)?false:true);
			},
			"extraorder-add":function(e,type){

				if(type=="start") return;

				var target=$(e.target);
				var group_html=target.parents("div[data-type=\"extraorder-group\"]");
				var group_id=group_html.attr("data-group-id");
				var child_html=group_html.find("div[data-initial-order-id=\"0\"]").eq(0);
				var clone_child_html=child_html.clone(true);
				var group_add_html  =group_html.find("div[data-type=\"extraorder-group-top\"]");

				var extraorder_maincategory=clone_child_html.find("select[data-type=\"extraorder-maincategory\"]");
				var extraorder_subcategory =clone_child_html.find("select[data-type=\"extraorder-category\"]");
				var extraorder_items       =clone_child_html.find("select[data-type=\"extraorder-item\"]");

				var category_val=extraorder_maincategory.children("option").eq(0).val();
				extraorder_maincategory.val(category_val);

				var submenu=information["menu"]["categories"]["menu"][category_val];
				setMenu.call(extraorder_subcategory.empty(),submenu);
				var submenu_val=extraorder_subcategory.val();

				var aliases=information["menu"]["categories"]["aliases"];
				var aliase=aliases[category_val][submenu_val];
				var items=information["menu"]["menus"][category_val][aliase];
				setMenu.call(extraorder_items.empty(),items);

				clone_child_html.find("input[type=number][data-type=\"extraorder-count\"]").val("");
				clone_child_html.find("input[type=text][data-type=\"extraorder-remarks\"]").val("");
				group_add_html.append(clone_child_html)
			}
		});

		main_html.data("remodal",remodal);

		return deferred.resolve(main_html,information);
	}

	var make=function(ymd,informations){

		getInformations(ymd,informations).
		then(mainView).
		then(setCalendar).
		then(setCalendarDefault).
		then(setGroups).
		then(setInformations).
		then(setAddRowForGroups).
		then(setAddLayout).
		then(setAddInformations).
		then(setSelectEvents).
		then(setGroupTitle).
		then(setTotalCost).
		then(viewModal).
		done(function(main_html,information){
		
		}).
		fail(function(){
		
		});
	}

	make(ymd);
}

var unavailableRoom=function(id,params,callback){

	var roomid   =params["roomid"];
	var start_ymd=params["start"];
	var end_ymd  =params["end"];
	var remarks  =params["remarks"];
	var reason_id=params["reason_id"];

	var setMainView=function(){
	
		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_situation_unavailable"]);
		var roomnum=rooms[roomid]["room_num"];
		var main_tpl=instance.replaceTPL(instance.get_remodal_situation_unavailable,{ "title":"<?php echo __("部屋番号"); ?>"+roomnum });
		var main_html=$(main_tpl);
		return deferred.resolve(main_html);
	}

	var getInformations=function(main_html){

		var deferred=$.Deferred();

		var params={};
		apiGeoRequests.getUnavailableReasons(params,function(status,res){
		
			var menu=res["data"]["menu"];
			deferred.resolve(main_html,menu);
		});

		return deferred.promise();
	}

	var getElements=function(){ this.elements={}; }
	getElements.getElements=function(main_html){

		if(!!this["instance"] && this.instance instanceof this){ return this.instance.elements; }

		var reason_html   =main_html.find("select[data-type=\"unavailable-reason\"]");
		var calendar_left =main_html.find("input[type=text][data-type=\"calendar-start\"]");
		var calendar_right=main_html.find("input[type=text][data-type=\"calendar-end\"]");
		var remark_html   =main_html.find("textarea[data-type=\"unavailable-remarks\"]");

		this.instance=new this();
		this.instance.elements["reason_html"]   =reason_html;
		this.instance.elements["calendar_left"] =calendar_left;
		this.instance.elements["calendar_right"]=calendar_right;
		this.instance.elements["remark_html"]   =remark_html;
		return this.instance.elements;
	};

	var setValues=function(main_html,menu){

		var deferred=$.Deferred();
		var elements=getElements.getElements(main_html);

		var locale_date;
		setMenu.call(elements["reason_html"],menu);
		if(reason_id!=undefined) elements["reason_html"].val(reason_id);
		if(remarks!=undefined)   elements["remark_html"].val(remarks);

		if(start_ymd!=undefined){

			locale_date=replaceToLocalDate(Number(start_ymd).splitYmd().join("-"));
			elements["calendar_left"].val(locale_date);
		}

		if(start_ymd!=undefined && end_ymd==undefined){

			locale_date=elements["calendar_left"].val();
			elements["calendar_right"].val(locale_date);
		}

		if(end_ymd!=undefined){

			locale_date=replaceToLocalDate(Number(end_ymd).splitYmd().join("-"));
			elements["calendar_right"].val(locale_date);
		}

		return deferred.resolve(main_html,menu);
	}

	var setEvents=function(main_html,menu){

		var deferred=$.Deferred();
		var elements=getElements.getElements(main_html);

		setCalendarForInput.call(elements["calendar_left"],{
		
			"onSelect":function(selectedDate){
			
				var calendar=this;
				var ymd=replaceToYmd(selectedDate);
				var date=replaceToLocalDate(Number(ymd).splitYmd().join("-"));
				var end_date=elements["calendar_right"].val();
				if(!!end_date && date>end_date){

					elements["calendar_right"].val(date);
					return;
				}
			}

		},{ "minDate":"-0d" });

		setCalendarForInput.call(elements["calendar_right"],{
		
			"onSelect":function(selectedDate){
			
				var calendar=this;
				var ymd=replaceToYmd(selectedDate);
				var date=replaceToLocalDate(Number(ymd).splitYmd().join("-"));
				var start_date=elements["calendar_left"].val();

				if(!!start_date && start_date>date){

					elements["calendar_left"].val(date);
					return;
				}
			}

		},{ "minDate":"-0d" });

		return deferred.resolve(main_html);
	}

	setMainView().
	then(getInformations).
	then(setValues).
	then(setEvents).
	done(function(main_html){
	
		var is_update=false;
		var main_title="<?php echo __("使用停止設定"); ?>";
		var params={"data":{"date":{},"id":id}}
		remodalAlert("normal_600",main_title,main_html,{

			"remodal-close":function(e,type){

				if(type=="end") return;
				if($.isFunction(callback)) callback(is_update);
			},
			"situation-unavailable-remove-button":function(e,type){

				if(type=="end") return;
				if(params["data"]["id"]==undefined){

					alert("<?php echo __('操作出来ません'); ?>");
					return;
				}

				var res=window.confirm("<?php echo __("削除して宜しいですか？"); ?>");
				if(!res) return;

				// here shuld be not empty.
				var data={"data":{}};
				data["data"]["data_id"]=params["data"]["id"];
				apiGeoRequests.unAvailableReasonRemove(data,function(status,res){

					if(!status){
					
						alert(res["message"]);
						return;
					}

					alert("<?php echo __('設定した内容が正常に登録されました'); ?>");
				});
			},
			"situation-unavailable-button":function(e,type){

				if(type=="end") return;

				var elements=getElements.getElements(main_html);

				// here shuld be not empty.
				params["data"]["roomid"]       =roomid;
				params["data"]["date"]["start"]=elements["calendar_left"].val().trim();
				params["data"]["date"]["end"]  =elements["calendar_right"].val().trim();
				params["data"]["reasonid"]     =elements["reason_html"].val();
				params["data"]["remarks"]      =elements["remark_html"].val().trim();
				apiGeoRequests.unAvailableReasonSubscribe(params,function(status,res){

					if(!status){
					
						alert(res["message"]);
						return;
					}

					alert("<?php echo __('設定した内容が正常に登録されました'); ?>");

					//for update. against to double registration.
					params["data"]["id"]=res["data"]["id"];
					is_update=true;
				});
			}
		});
	});
}

var __alert=function(message){

	message=message.replace(/(<br>|<br \/>)/gi,'\n');
	alert(message);
}

var diposit=function(schedule_id,ymd,staytype,callback,is_edit){

	var mainView=function(information,menus){
	
		var deferred=$.Deferred();
		var instance=TPL.getInstance(["remodal_diposit_registerd"]);
		var main_tpl=instance.get_remodal_diposit_registerd;
		var main_html=$(main_tpl);
		return deferred.resolve(main_html,information,menus);
	}

	var getInformations=function(schedule_id,staytype){

		var deferred=$.Deferred();

		var params={"data":{}};
		params["data"]["schedule_id"]=schedule_id;
		params["data"]["staytype"]   =staytype;
		apiGeoRequests.getDiposits(params,function(status,res){
		
			var informations=res["data"]["data"];
			var menus=res["data"]["menus"];
			deferred.resolve(informations,menus);
		});

		return deferred.promise();
	}

	var getElements=function(){
	
		var row_top=this;

		var res={};
		res["diposit-reason"]  =row_top.find("select[data-type=\"diposit-reason\"]");
		res["diposit-amount"]  =row_top.find("input[type=number][data-type=\"diposit-amount\"]");
		res["diposit-remarks"] =row_top.find("input[type=text][data-type=\"diposit-remarks\"]");
		res["diposit-status"]  =row_top.find("input[type=checkbox][data-type=\"diposit-status\"]");
		res["diposit-cashtype"]=row_top.find("select[data-type=\"diposit-cashtype\"]");
		return res;
	}

	var setInformations=function(main_html,informations,menus){

		var deferred=$.Deferred();

		if(1>Object.keys(informations).length) return deferred.resolve(main_html,informations,menus);

		var instance=TPL.getInstance(["remodal_diposit_child"]);
		var tpl=instance.get_remodal_diposit_child;
		var html;
		var elements;
		var fragment=document.createDocumentFragment();
		var target=main_html.find("div[data-type=\"diposit-list\"]");

		for(var data_id in informations){
	
			html=$(instance.replaceTPL(tpl,{ "data_id":data_id,"staff":informations[data_id]["employee"]["name"],"time":informations[data_id]["diposit"]["regist_date"] }));
			elements=getElements.call(html);
			setMenu.call(elements["diposit-reason"],menus["reason"]);
			setMenu.call(elements["diposit-cashtype"],menus["cashtype"]);
			elements["diposit-reason"].val(informations[data_id]["diposit"]["reason_id"]);
			elements["diposit-cashtype"].val(informations[data_id]["diposit"]["cash_type_id"]);
			elements["diposit-amount"].val(informations[data_id]["diposit"]["value"]);
			elements["diposit-remarks"].val(informations[data_id]["diposit"]["remarks"]);
			fragment.appendChild(html.get(0));
		}

		target.append(fragment);
		return deferred.resolve(main_html,informations,menus);
	}

	var setAddLayout=function(main_html,informations,menus){

		var deferred=$.Deferred();

		var instance=TPL.getInstance(["remodal_diposit_add"]);
		var tpl=instance.get_remodal_diposit_add;
		var html=$(tpl);
		var elements=getElements.call(html);
		var target=main_html.find("div[data-type=\"diposit-list\"]");

		setMenu.call(elements["diposit-reason"],menus["reason"]);
		setMenu.call(elements["diposit-cashtype"],menus["cashtype"]);

		target.append(html);
	
		return deferred.resolve(main_html,informations,menus);
	}

	var setTotal=function(main_html,informations,menus){

		var deferred=$.Deferred();

		var target=main_html.find("span[data-type=\"main-total-cost\"]");
		var total=0;
		for(var data_id in informations) total+=parseFloat(informations[data_id]["diposit"]["value"]);
		total=Number(total).toLocaleString();
		target.text(total);

		return deferred.resolve(main_html,informations,menus);
	}

	var viewModal=function(main_html,informations,menus){

		var deferred=$.Deferred();
		var date=replaceToLocaleFormatWithYmd(ymd);

		var main_title="<?php echo __("デポジット"); ?>"
		main_title+="("+date+")";

		var message=main_html;
		var remodal=remodalAlert("normal_1200",main_title,message,{
		
			"remodal-close":function(e,type){

				if(type=="end") return;
				if($.isFunction(callback)) callback(is_edit?true:false);
			},
			"diposit-add":function(e,type){

				if(type=="end") return;
				setAddLayout(main_html,informations,menus);
			},
			"diposit-status":function(e,type){

				if(type=="end") return;
				var target    =$(e.target);
				var is_checked=target.is(":checked");
				target.prop("checked",(is_checked)?false:true);
				is_checked=target.is(":checked");
			},
			"diposit-save":function(e,type){

				if(type=="end") return;

				var remodal=this;
				var data_rows=main_html.find("div[data-type=\"row-top\"]");
				var remove_values=[];
				var new_values   =[]
				var edit_values  =[];

				var new_data_rows=data_rows.filter("div[data-id=\"0\"]");
				var origin_data_rows=data_rows.filter(":not(div[data-id=\"0\"])");

				origin_data_rows.each(function(){

					var data_row=$(this);
					var data_id=data_row.attr("data-id");
					var elements=getElements.call(data_row);
					var value=elements["diposit-amount"].val().trim();
					var remarks=elements["diposit-remarks"].val().trim();
					var reason_id=elements["diposit-reason"].val();
					var cash_type_id=elements["diposit-cashtype"].val();
					var is_remove=elements["diposit-status"].is(":checked");

					if(!is_remove || 1>value.length){
					
						remove_values.push(data_id);
						return;
					}

					var current=informations[data_id];

					var is_edit=false;
					if(value!=current["diposit"]["value"]) is_edit=true;
					if(!is_edit && remarks!=current["diposit"]["remarks"]) is_edit=true;
					if(!is_edit && reason_id!=current["diposit"]["reason_id"]) is_edit=true;
					if(!is_edit && cash_type_id!=current["diposit"]["cash_type_id"]) is_edit=true;
					if(!is_edit) return;

					edit_values.push({
					
						"data_id"     :data_id,
						"value"       :value,
						"remarks"     :remarks,
						"reason_id"   :reason_id,
						"cash_type_id":cash_type_id
					});
				});

				new_data_rows.each(function(){
				
					var data_row=$(this);
					var elements=getElements.call(data_row);
					var value=elements["diposit-amount"].val().trim();
					if(1>value.length) return;
					value=Math.max(value,0);
					var remarks=elements["diposit-remarks"].val().trim();
					var reason_id=elements["diposit-reason"].val();
					var cash_type_id=elements["diposit-cashtype"].val();
					new_values.push({
					
						"value"       :value,
						"reason_id"   :reason_id,
						"remarks"     :remarks,
						"cash_type_id":cash_type_id,
					});
				});

				if(1>remove_values.length && 1>new_values.length && 1>edit_values.length){

					alert("<?php echo __("変更された項目は存在しません"); ?>");
					return;
				}

				var params={"data":{},"staytype":staytype,"schedule_id":schedule_id};
				params["data"]["edit_values"]  =edit_values;
				params["data"]["new_values"]   =new_values;
				params["data"]["remove_values"]=remove_values;
				apiGeoRequests.dipositSubscribe(params,function(status,res){

					if(!status){
					
						alert(res["message"]);
						return;
					}

					alert("<?php echo __("設定した内容が正常に登録されました"); ?>");

					informations=null;

					remodal.close(null,function(){

						diposit(schedule_id,ymd,staytype,callback,true);
					});
				});
			}
		});

		main_html.data("remodal",remodal);

		return deferred.resolve(main_html,informations);
	}

	var make=function(schedule_id,staytype){

		getInformations(schedule_id,staytype).
		then(mainView).
		then(setInformations).
		then(setAddLayout).
		then(setTotal).
		then(viewModal).
		done(function(){
		
		}).
		fail(function(){
		
		});
	}

	make(schedule_id,staytype);
}


</script>
